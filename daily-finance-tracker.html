<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Daily Finance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, setDoc, query, where, orderBy, enableIndexedDbPersistence, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: 'AIzaSyBVVXhDCgMxjeVwf3siFEdHrQ5qebvNSaw',
            authDomain: 'rdp-final-677a1.firebaseapp.com',
            projectId: 'rdp-final-677a1',
            storageBucket: 'rdp-final-677a1.firebasestorage.app',
            messagingSenderId: '398537230115',
            appId: '1:398537230115:web:634a176686ea383bf66e96',
            measurementId: 'G-4DKCVHMF1W'
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Enable offline persistence
        try {
            await enableIndexedDbPersistence(db);
            console.log('Firestore offline persistence enabled');
        } catch (e) {
            console.log('Firestore offline persistence not available:', e);
        }

        // Make Firestore and Auth functions globally available
        window.firestoreDB = {
            db,
            collection: (db, name) => collection(db, name),
            addDoc,
            getDocs,
            getDoc,
            updateDoc,
            deleteDoc,
            doc,
            setDoc,
            query,
            where,
            orderBy,
            onSnapshot
        };
        
        window.firebaseAuth = {
            auth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .date-section {
            background: #34495e;
            padding: 15px;
            text-align: center;
        }

        .date-input {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            background: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            overflow: hidden;
        }

        .section-header {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .section-content {
            padding: 15px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .table th, .table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .table th {
            background: #ecf0f1;
            font-weight: bold;
        }

        .table input {
            width: 100%;
            border: none;
            padding: 5px;
            text-align: center;
            background: transparent;
        }

        .table input:focus {
            background: #e8f4f8;
            outline: 2px solid #3498db;
        }

        .total-row {
            background: #f8f9fa;
            font-weight: bold;
        }

        .total-row input {
            font-weight: bold;
            background: #e8f4f8;
        }

        .cash-out-section {
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            overflow: hidden;
        }

        .cash-out-header {
            background: #e74c3c;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .cash-out-content {
            padding: 15px;
        }

        .cash-out-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cash-out-table th, .cash-out-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .cash-out-table th {
            background: #ecf0f1;
            font-weight: bold;
        }

        .cash-out-table input {
            width: 100%;
            border: none;
            padding: 5px;
            background: transparent;
        }

        .cash-out-table input:focus {
            background: #e8f4f8;
            outline: 2px solid #3498db;
        }

        .right-section {
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            overflow: hidden;
        }

        .total-header {
            background: #27ae60;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .total-content {
            padding: 15px;
        }

        .total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .total-item:last-child {
            border-bottom: none;
        }

        .total-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .total-input {
            width: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
            font-weight: bold;
        }

        .total-input:focus {
            outline: 2px solid #3498db;
            border-color: #3498db;
        }

        .summary-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }

        .summary-label {
            color: #2c3e50;
        }

        .summary-value {
            font-weight: bold;
            color: #27ae60;
        }

        .expense-section {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .section-subheader {
            background: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        .section-subheader h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            background: #229954;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        .expense-input {
            width: 100%;
            border: none;
            padding: 5px;
            background: transparent;
        }

        .expense-input:focus {
            background: #e8f4f8;
            outline: 2px solid #3498db;
        }

        .amount-input {
            width: 100%;
            border: none;
            padding: 5px;
            background: transparent;
            text-align: right;
        }

        .amount-input:focus {
            background: #e8f4f8;
            outline: 2px solid #3498db;
        }

        .buttons {
            margin-top: 20px;
            text-align: center;
        }

        .btn {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Modal Styles */
        .products-modal {
            display: block;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .products-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .products-modal-header {
            background: #3498db;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .products-modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-modal-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-modal-btn:hover {
            transform: scale(1.2);
        }

        .products-modal-body {
            padding: 25px;
            max-height: 500px;
            overflow-y: auto;
        }

        .products-modal-body h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .products-modal-footer {
            background: #ecf0f1;
            padding: 15px 25px;
            border-radius: 0 0 8px 8px;
            text-align: right;
        }

        .products-modal-footer .btn {
            margin-left: 10px;
        }

        .product-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }

        .form-control {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Navigation Bar Styles */
        .navbar {
            background: #34495e;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .navbar-brand {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            padding: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            color: #ecf0f1;
        }

        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-item {
            margin-left: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            display: block;
            transition: all 0.3s ease;
            border-radius: 4px;
            cursor: pointer;
        }

        .nav-link:hover {
            background: #2c3e50;
            color: #ecf0f1;
        }

        .nav-link.active {
            background: #3498db;
            color: white;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            top: 100%;
            right: 0;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            color: #2c3e50;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s ease;
        }

        .dropdown-item:hover {
            background: #ecf0f1;
        }

        .dropdown-item i {
            margin-right: 8px;
            width: 16px;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .navbar-nav {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #34495e;
                flex-direction: column;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .navbar-nav.active {
                display: flex;
            }

            .nav-item {
                margin: 0;
            }

            .nav-link {
                padding: 15px 20px;
                border-bottom: 1px solid #2c3e50;
            }

            .mobile-menu-btn {
                display: block;
            }

            .dropdown-content {
                position: static;
                display: none;
                background: #2c3e50;
                box-shadow: none;
            }

            .dropdown:hover .dropdown-content {
                display: block;
            }

            .dropdown-item {
                color: white;
                padding: 10px 20px;
            }
        }

        /* Charts Section Styles */
        .charts-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-controls button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-controls button:hover {
            background: #f8f9fa;
        }

        .chart-controls button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .btn.active {
            background: #3498db !important;
            color: white !important;
            border-color: #3498db !important;
        }

        .no-data-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        /* Report Styles */
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .report-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .report-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
        }

        .report-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .report-table th {
            background: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }

        .report-table tr:hover {
            background: #f8f9fa;
        }

        .report-section {
            margin-bottom: 25px;
        }

        .report-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .date-picker {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .date-picker input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .date-picker button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .date-picker button:hover {
            background: #2980b9;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* History Table Styles */
        .history-section {
            margin-top: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .history-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .history-controls {
            display: flex;
            gap: 10px;
        }

        .history-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: bold;
            color: #2c3e50;
            white-space: nowrap;
        }

        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid #ecf0f1;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .history-table th {
            background: #34495e;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #2c3e50;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .history-table tr:nth-child(even) {
            background: #fafafa;
        }

        .history-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .btn-view {
            background: #27ae60;
            color: white;
        }

        .btn-view:hover {
            background: #229954;
        }

        .no-history-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .profit-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .profit-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .profit-zero {
            color: #6c757d;
            font-weight: bold;
        }

        /* Edit Modal Styles */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .edit-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .edit-modal h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .edit-form-group {
            margin-bottom: 15px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .edit-form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            /* Mobile Navigation */
            .navbar-container {
                padding: 0 10px;
            }
            
            .navbar-brand {
                font-size: 16px;
                padding: 10px 0;
            }
            
            .navbar-nav {
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: #34495e;
                display: none;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .navbar-nav.active {
                display: flex;
            }
            
            .nav-item {
                margin: 0;
                width: 100%;
            }
            
            .nav-link {
                padding: 15px 20px;
                border-bottom: 1px solid #2c3e50;
            }
            
            .dropdown-content {
                position: static;
                background: #2c3e50;
                box-shadow: none;
                width: 100%;
            }
            
            .dropdown-item {
                padding: 10px 30px;
                border-bottom: 1px solid #34495e;
            }

            /* Mobile Container */
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }

            /* Mobile Tables */
            .table {
                font-size: 12px;
            }
            
            .table th,
            .table td {
                padding: 8px 4px;
            }
            
            .table input {
                font-size: 12px;
                padding: 4px;
            }

            /* Mobile Cash Out Tables */
            .cash-out-table th,
            .cash-out-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .cash-out-table input {
                font-size: 12px;
                padding: 4px;
            }

            /* Mobile History Table */
            .history-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .history-table {
                min-width: 600px;
            }
            
            .history-table th,
            .history-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn-action {
                padding: 4px 8px;
                font-size: 10px;
            }

            /* Mobile Charts */
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .chart-title {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .chart-controls {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .chart-controls button {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* Mobile Report Tables */
            .report-table {
                font-size: 12px;
            }
            
            .report-table th,
            .report-table td {
                padding: 8px 4px;
            }
            
            .report-summary {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .report-card {
                padding: 10px;
            }
            
            .report-card h4 {
                font-size: 12px;
            }
            
            .report-card .value {
                font-size: 18px;
            }

            /* Mobile Filters */
            .history-filters {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            
            .filter-group input {
                width: 100%;
            }

            /* Mobile Buttons */
            .buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }

            /* Mobile Modals */
            .edit-modal-content {
                width: 95%;
                padding: 20px;
                max-height: 90vh;
            }
            
            .edit-modal h2 {
                font-size: 18px;
            }
            
            .edit-form-group input {
                font-size: 14px;
            }

            /* Mobile Section Headers */
            .section-header {
                font-size: 16px;
                padding: 10px;
            }
            
            .section-subheader h4 {
                font-size: 14px;
            }

            /* Mobile Summary */
            .summary-section {
                margin-top: 15px;
            }
            
            .summary-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .summary-label {
                font-size: 12px;
            }
            
            .summary-value {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            /* Extra Small Mobile */
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .table th,
            .table td {
                padding: 6px 2px;
                font-size: 11px;
            }
            
            .table input {
                font-size: 11px;
                padding: 3px;
            }
            
            .report-summary {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 200px;
            }
            
            .history-table th,
            .history-table td {
                padding: 6px 4px;
                font-size: 11px;
            }
            
            .btn-action {
                padding: 3px 6px;
                font-size: 9px;
            }
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            /* Touch-friendly buttons */
            .btn, .btn-action, .nav-link {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Prevent text selection on buttons */
            .btn, .btn-action, .nav-link, .mobile-menu-btn {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Better scrolling for mobile */
            .history-table-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Mobile-friendly modals */
            .edit-modal {
                padding: 10px;
            }
            
            .edit-modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            
            /* Mobile chart controls */
            .chart-controls {
                justify-content: center;
            }
            
            .chart-controls button {
                min-width: 60px;
                min-height: 36px;
            }
            
            /* Mobile report display */
            .report-display {
                padding: 10px;
            }
            
            .report-display h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            /* Mobile-friendly date picker */
            input[type="date"] {
                font-size: 16px;
                padding: 8px;
            }
            
            /* Mobile table improvements */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                border: 2px solid #ddd;
                border-radius: 8px;
                margin: 10px 0;
            }
            
            /* Make tables more compact on mobile */
            .table {
                min-width: 600px; /* Ensure minimum width for readability */
                font-size: 11px;
            }
            
            .table th,
            .table td {
                padding: 6px 4px;
                white-space: nowrap;
                min-width: 60px;
            }
            
            .table input {
                font-size: 11px;
                padding: 4px 2px;
                width: 100%;
                min-width: 50px;
            }
            
            /* Cigarette sales table specific */
            .cigarette-table {
                min-width: 700px;
            }
            
            .cigarette-table th,
            .cigarette-table td {
                min-width: 80px;
                text-align: center;
            }
            
            /* Rental collection table specific */
            .rental-table {
                min-width: 800px;
            }
            
            .rental-table th,
            .rental-table td {
                min-width: 90px;
                text-align: center;
            }
            
            /* Beer sales table specific */
            .beer-table {
                min-width: 500px;
            }
            
            .beer-table th,
            .beer-table td {
                min-width: 70px;
                text-align: center;
            }
            
            /* Add scroll indicators */
            .table-responsive::before {
                content: "‚Üê Scroll to see more ‚Üí";
                display: block;
                text-align: center;
                background: #f8f9fa;
                color: #666;
                padding: 5px;
                font-size: 10px;
                border-bottom: 1px solid #ddd;
            }
            
            
            /* Mobile summary cards */
            .summary-item {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            /* Mobile-friendly dropdowns */
            .dropdown-content {
                max-height: 200px;
                overflow-y: auto;
            }
        }

        /* Mobile instructions banner */
        .mobile-instructions {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .instructions-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .instructions-text {
            font-size: 12px;
            flex: 1;
        }
        
        .instructions-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }
        
        .instructions-close:hover {
            opacity: 0.7;
        }

        /* Alert styling for no data messages */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .alert-info {
            color: #31708f;
            background-color: #d9edf7;
            border-color: #bce8f1;
        }

        .no-data-message {
            text-align: center;
            padding: 20px;
        }

        .no-data-message h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .no-data-message h4 {
            color: #34495e;
            margin-bottom: 15px;
        }

        .no-data-message p {
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        /* Sync status indicator */
        .sync-status {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            background: rgba(52, 73, 94, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-icon {
            animation: spin 2s linear infinite;
        }

        .sync-status.connected {
            background: rgba(39, 174, 96, 0.95);
        }

        .sync-status.error {
            background: rgba(231, 76, 60, 0.95);
        }

        .sync-status.syncing {
            background: rgba(52, 152, 219, 0.95);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide sync status on mobile */
        @media (max-width: 768px) {
            .sync-status {
                top: 60px;
                right: 10px;
                font-size: 10px;
                padding: 6px 10px;
            }
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-button:hover {
            background: #2980b9;
        }

        .login-error {
            color: #e74c3c;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }

        .login-link {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .login-link a {
            color: #3498db;
            cursor: pointer;
            text-decoration: none;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .login-user-info {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 6px;
            color: #2c3e50;
            font-size: 14px;
        }

        .login-loading {
            text-align: center;
            color: #3498db;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h2 class="login-title">üìä Daily Finance Tracker</h2>
            <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">Please login to continue</p>
            
            <form id="loginForm">
                <div class="login-form-group">
                    <label class="login-label" for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="login-input" placeholder="Enter your email" required>
                </div>
                
                <div class="login-form-group">
                    <label class="login-label" for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="login-input" placeholder="Enter your password" required>
                </div>
                
                <div id="loginError" class="login-error" style="display: none;"></div>
                <div id="loginLoading" class="login-loading" style="display: none;">Logging in...</div>
                
                <button type="submit" class="login-button">Login</button>
            </form>
            
            <div class="login-link">
                <p>Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: #ecf0f1; border-radius: 8px; font-size: 12px; color: #7f8c8d; text-align: center;">
                <strong>üí° Tip:</strong> Create your account using the "Sign up" link above.
            </div>
        </div>
    </div>

    <!-- Signup Page -->
    <div id="signupPage" class="login-container" style="display: none;">
        <div class="login-card">
            <h2 class="login-title">üìä Create Account</h2>
            <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">Sign up for Daily Finance Tracker</p>
            
            <form id="signupForm">
                <div class="login-form-group">
                    <label class="login-label" for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="login-input" placeholder="Enter your email" required>
                </div>
                
                <div class="login-form-group">
                    <label class="login-label" for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="login-input" placeholder="Create a password" required minlength="6">
                </div>
                
                <div class="login-form-group">
                    <label class="login-label" for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="login-input" placeholder="Confirm your password" required>
                </div>
                
                <div id="signupError" class="login-error" style="display: none;"></div>
                <div id="signupLoading" class="login-loading" style="display: none;">Creating account...</div>
                
                <button type="submit" class="login-button">Create Account</button>
            </form>
            
            <div class="login-link">
                <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="mainApp" style="display: none;">
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-brand" onclick="showMainPage(event)">üìä Daily Finance Tracker</a>
            
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
            
            <ul class="navbar-nav" id="navbarNav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showMainPage(event)">üè† Daily Record</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showNightSection(event)">üåô Night Section</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showReports(event)">üìà Reports</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showNightReports(event)">üåô Night Reports</a>
                </li>
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link">‚öôÔ∏è Settings</a>
                    <div class="dropdown-content">
                        <a href="#" class="dropdown-item" onclick="showExpenseSettings(event)">
                            üí∞ Expense Templates
                        </a>
                        <a href="#" class="dropdown-item" onclick="showSalarySettings(event)">
                            üë• Salary Names
                        </a>
                        <a href="#" class="dropdown-item" onclick="showBankExpenseSettings(event)">
                            üè¶ Bank Expense Templates
                        </a>
                        <a href="#" class="dropdown-item" onclick="showProductSettings(event)">
                            üì¶ Product Settings
                        </a>
                        <a href="#" class="dropdown-item" onclick="showRentalSettings(event)">
                            üè† Rental Settings
                        </a>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showDataManagement(event)">üíæ Data Management</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showHelp(event)">‚ùì Help</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="handleLogout(event)" style="color: #e74c3c;">üö™ Logout</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Mobile Instructions Banner -->
        <div class="mobile-instructions" id="mobileInstructions" style="display: none;">
            <div class="instructions-content">
                <span class="instructions-text">üì± Mobile users: Pinch to zoom out to see full tables</span>
                <button class="instructions-close" onclick="hideMobileInstructions()">√ó</button>
            </div>
        </div>

        <!-- Sync Status Indicator -->
        <div class="sync-status" id="syncStatus">
            <div class="sync-indicator">
                <span class="sync-icon">üîÑ</span>
                <span class="sync-text">Connecting to Firestore...</span>
            </div>
        </div>

        <div class="header">
            <h1>Daily Finance Tracker</h1>
            <p>Comprehensive Daily Financial Data Entry</p>
        </div>

        <div class="date-section">
            <label for="dateInput" style="color: white; margin-right: 10px;">Date:</label>
            <input type="date" id="dateInput" class="date-input" value="">
        </div>

        <!-- Save Data Button Section -->
        <div style="padding: 20px; text-align: center; background: #ecf0f1;">
            <button class="btn btn-success" onclick="saveData()" style="font-size: 18px; padding: 15px 40px;">
                üíæ Save Data
            </button>
        </div>

        <div class="main-content">
            <div class="left-section">
                <!-- Sales of Cigarettes Section -->
                <div class="section">
                    <div class="section-header">Sales of Cigarettes</div>
                    <div class="section-content">
                        <div class="table-responsive">
                            <table class="table cigarette-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>LD</th>
                                    <th>Rothman & Chest</th>
                                    <th>Terrar</th>
                                    <th>Peter</th>
                                    <th>Wiston</th>
                                    <th>Dunhill</th>
                                    <th>Mevius</th>
                                    <th>Marbolo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Default Price</strong></td>
                                    <td><input type="number" value="12" readonly></td>
                                    <td><input type="number" value="12.4" readonly></td>
                                    <td><input type="number" value="14" readonly></td>
                                    <td><input type="number" value="16.2" readonly></td>
                                    <td><input type="number" value="15.9" readonly></td>
                                    <td><input type="number" value="17.7" readonly></td>
                                    <td><input type="number" value="17.7" readonly></td>
                                    <td><input type="number" value="17.4" readonly></td>
                                </tr>
                                <tr>
                                    <td><strong>Sales of packs</strong></td>
                                    <td><input type="number" class="cigarette-qty" data-price="12" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="12.4" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="14" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="16.2" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="15.9" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="17.7" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="17.7" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty" data-price="17.4" placeholder="0"></td>
                                </tr>
                                <tr class="total-row">
                                    <td><strong>Total:</strong></td>
                                    <td colspan="8"><input type="number" id="cigaretteTotal" readonly placeholder="0.00"></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                <!-- Rental Collection Section -->
                <div class="section">
                    <div class="section-header">Rental Collection</div>
                    <div class="section-content">
                        <div class="table-responsive">
                            <table class="table rental-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Rental Name</th>
                                    <th style="width: 20%;">Price per Day</th>
                                    <th style="width: 20%;">Days of Collection</th>
                                    <th style="width: 30%;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Wanton</strong></td>
                                    <td><input type="number" class="rental-price" value="40" readonly data-name="wanton"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="40" data-name="wanton" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="wanton" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Pork Noodle</strong></td>
                                    <td><input type="number" class="rental-price" value="40" readonly data-name="porknoodle"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="40" data-name="porknoodle" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="porknoodle" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Pan Mee</strong></td>
                                    <td><input type="number" class="rental-price" value="35" readonly data-name="panmee"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="35" data-name="panmee" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="panmee" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>ChiCongFun</strong></td>
                                    <td><input type="number" class="rental-price" value="35" readonly data-name="chicongfun"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="35" data-name="chicongfun" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="chicongfun" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Kampar</strong></td>
                                    <td><input type="number" class="rental-price" value="35" readonly data-name="kampar"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="35" data-name="kampar" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="kampar" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Ipoh Sherred</strong></td>
                                    <td><input type="number" class="rental-price" value="20" readonly data-name="ipohsherred"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="20" data-name="ipohsherred" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="ipohsherred" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Chicken Rice</strong></td>
                                    <td><input type="number" class="rental-price" value="100" readonly data-name="chickenrice"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="100" data-name="chickenrice" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="chickenrice" placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Cina Noodle</strong></td>
                                    <td><input type="number" class="rental-price" value="40" readonly data-name="cinanoodle"></td>
                                    <td><input type="number" class="rental-days" value="0" min="0" step="1" data-price="40" data-name="cinanoodle" placeholder="0"></td>
                                    <td><input type="number" class="rental-total" readonly data-name="cinanoodle" placeholder="0.00"></td>
                                </tr>
                                <tr class="total-row">
                                    <td><strong>Rental Total</strong></td>
                                    <td colspan="3"><input type="number" id="rentalTotal" readonly placeholder="0.00"></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                <!-- ALL CASH OUT Section -->
                <div class="cash-out-section">
                    <div class="cash-out-header">ALL CASH OUT</div>
                    <div class="cash-out-content">
                        <!-- Expenses Section -->
                        <div class="expense-section">
                            <div class="section-subheader">
                                <h4>Expenses</h4>
                                <button class="btn-add" onclick="addExpenseRow()">+ Add Expense</button>
                            </div>
                            <div class="table-responsive">
                                <table class="cash-out-table" id="expensesTable">
                                <thead>
                                    <tr>
                                        <th style="width: 60%;">Item</th>
                                        <th style="width: 30%;">Amount</th>
                                        <th style="width: 10%;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="expensesTableBody">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td><strong>Total Expenses</strong></td>
                                        <td><input type="number" id="totalExpenses" readonly placeholder="0.00"></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            </div>
                        </div>

                        <!-- Bank Transfer Expenses Section -->
                        <div class="expense-section">
                            <div class="section-subheader">
                                <h4>Expenses Bank Transfer</h4>
                                <button class="btn-add" onclick="addBankExpenseRow()">+ Add Bank Expense</button>
                            </div>
                            <div class="table-responsive">
                                <table class="cash-out-table" id="bankExpensesTable">
                                <thead>
                                    <tr>
                                        <th style="width: 60%;">Item</th>
                                        <th style="width: 30%;">Amount</th>
                                        <th style="width: 10%;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="bankExpensesTableBody">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td><strong>Total Bank Expenses</strong></td>
                                        <td><input type="number" id="totalBankExpenses" readonly placeholder="0.00"></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            </div>
                        </div>

                        <!-- Salary/Gaji Section -->
                        <div class="expense-section">
                            <div class="section-subheader">
                                <h4>Salary/Gaji</h4>
                                <button class="btn-add" onclick="addSalaryRow()">+ Add Salary/Gaji</button>
                            </div>
                            <div class="table-responsive">
                                <table class="cash-out-table" id="salaryTable">
                                <thead>
                                    <tr>
                                        <th style="width: 60%;">Item</th>
                                        <th style="width: 30%;">Amount</th>
                                        <th style="width: 10%;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="salaryTableBody">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td><strong>Total Salary/Gaji</strong></td>
                                        <td><input type="number" id="totalSalary" readonly placeholder="0.00"></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-section">
                <div class="total-header">Daily Sales Total:</div>
                <div class="total-content">
                    <div class="total-item">
                        <span class="total-label">Cash Received:</span>
                        <input type="number" id="cashReceived" class="total-input" placeholder="0.00" oninput="calculateCashReceived()">
                    </div>
                    <div class="total-item">
                        <span class="total-label">TNG Received:</span>
                        <input type="number" id="tngReceived" class="total-input" placeholder="0.00" oninput="calculateCashReceived()">
                    </div>
                    <div class="total-item" style="background-color: #fee; border: 2px solid #e74c3c; padding: 10px; border-radius: 4px;">
                        <span class="total-label" style="font-weight: bold; color: #e74c3c;">Expenses paid by Cash today:</span>
                        <span id="cashExpenses" style="font-weight: bold; font-size: 1.1em; color: #e74c3c;">0.00</span>
                    </div>
                    <div class="total-item" style="background-color: #fee; border: 2px solid #e74c3c; padding: 10px; border-radius: 4px;">
                        <span class="total-label" style="font-weight: bold; color: #e74c3c;">Salary/Gaji paid by cash today:</span>
                        <span id="cashSalary" style="font-weight: bold; font-size: 1.1em; color: #e74c3c;">0.00</span>
                    </div>
                    <div class="total-item">
                        <span class="total-label">Grab Received:</span>
                        <input type="number" id="grabReceived" class="total-input" placeholder="0.00" oninput="calculateCashReceived()">
                    </div>
                    <div class="total-item">
                        <span class="total-label">Shopee Received:</span>
                        <input type="number" id="shopeeReceived" class="total-input" placeholder="0.00" oninput="calculateCashReceived()">
                    </div>
                    <div class="total-item" style="background-color: #fee; border: 2px solid #e74c3c; padding: 10px; border-radius: 4px;">
                        <span class="total-label" style="font-weight: bold; color: #e74c3c;">Total:</span>
                        <span class="summary-value" id="totalCashReceived" style="font-weight: bold; font-size: 1.1em; color: #e74c3c;">0.00</span>
                    </div>

                    <div class="summary-section">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">Sales Summary</h4>
                        <div class="summary-item">
                            <span class="summary-label">Sales Today:</span>
                            <span class="summary-value" id="salesToday">0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Sales of Cigarettes:</span>
                            <span class="summary-value" id="summaryCigaretteSales">0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Rental Collection:</span>
                            <span class="summary-value" id="summaryRentalCollection">0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Coffee Sales:</span>
                            <input type="number" id="coffeeSales" class="total-input" placeholder="0.00" style="width: 100px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Table Section -->
        <div class="history-section">
            <div class="history-header">
                <h3>üìã Financial Records History</h3>
                <div class="history-controls">
                    <button class="btn btn-info" onclick="refreshHistoryTable()">üîÑ Refresh</button>
                    <button class="btn btn-warning" onclick="exportHistoryData()">üì§ Export</button>
                </div>
            </div>
            
            <div class="history-filters">
                <div class="filter-group">
                    <label for="dateFilter">Filter by Date:</label>
                    <input type="date" id="dateFilter" onchange="filterHistoryTable()">
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search:</label>
                    <input type="text" id="searchFilter" placeholder="Search records..." onkeyup="filterHistoryTable()">
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Sales</th>
                            <th>Total Expenses</th>
                            <th>Net Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History records will be populated here -->
                    </tbody>
                </table>
                <div id="noHistoryMessage" class="no-history-message" style="display: none;">
                    <p>No financial records found. Start recording daily finances to see your history here.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Night Section Container -->
    <div class="container" id="nightSectionContainer" style="display: none;">
        <div class="header">
            <h1>üåô Night Section</h1>
            <p>Night Shift Financial Data Entry</p>
        </div>

        <div class="date-section">
            <label for="nightDateInput" style="color: white; margin-right: 10px;">Date:</label>
            <input type="date" id="nightDateInput" class="date-input" value="">
        </div>

        <!-- Save Data Button Section -->
        <div style="padding: 20px; text-align: center; background: #ecf0f1;">
            <button class="btn btn-success" onclick="saveNightData()" style="font-size: 18px; padding: 15px 40px; margin: 5px;">
                üíæ Save Night Data
            </button>
            <button class="btn btn-info" onclick="document.getElementById('nightCsvFileInput').click()" style="font-size: 18px; padding: 15px 40px; margin: 5px;">
                üì• Import CSV File
            </button>
            <button class="btn btn-secondary" onclick="downloadNightCsvSample()" style="font-size: 18px; padding: 15px 40px; margin: 5px;">
                üìÑ Download Sample CSV
            </button>
            <input type="file" id="nightCsvFileInput" accept=".csv" style="display: none;" onchange="handleNightCsvImport(event)">
        </div>

        <div class="main-content">
            <div class="left-section">
                <!-- Sales of Cigarettes Section -->
                <div class="section">
                    <div class="section-header">Sales of Cigarettes</div>
                    <div class="section-content">
                        <div class="table-responsive">
                            <table class="table cigarette-table-night">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>LD</th>
                                    <th>Rothman & Chest</th>
                                    <th>Terrar</th>
                                    <th>Peter</th>
                                    <th>Wiston</th>
                                    <th>Dunhill</th>
                                    <th>Mevius</th>
                                    <th>Marbolo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Default Price</strong></td>
                                    <td><input type="number" value="12" readonly></td>
                                    <td><input type="number" value="12.4" readonly></td>
                                    <td><input type="number" value="14" readonly></td>
                                    <td><input type="number" value="16.2" readonly></td>
                                    <td><input type="number" value="15.9" readonly></td>
                                    <td><input type="number" value="17.7" readonly></td>
                                    <td><input type="number" value="17.7" readonly></td>
                                    <td><input type="number" value="17.4" readonly></td>
                                </tr>
                                <tr>
                                    <td><strong>Sales of packs</strong></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="12" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="12.4" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="14" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="16.2" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="15.9" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="17.7" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="17.7" placeholder="0"></td>
                                    <td><input type="number" class="cigarette-qty-night" data-price="17.4" placeholder="0"></td>
                                </tr>
                                <tr class="total-row">
                                    <td><strong>Total:</strong></td>
                                    <td colspan="8"><input type="number" id="cigaretteTotalNight" readonly placeholder="0.00"></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                <!-- Sales of Beer Section -->
                <div class="section">
                    <div class="section-header">Sales of Beer</div>
                    <div class="section-content">
                        <div class="table-responsive">
                            <table class="table beer-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Beer Brand</th>
                                    <th style="width: 30%;">Price per Bottle</th>
                                    <th style="width: 20%;">Bottles Sold</th>
                                    <th style="width: 10%;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Carlsberg</strong></td>
                                    <td><input type="number" class="beer-price-night" value="0" step="0.01" placeholder="0.00"></td>
                                    <td><input type="number" class="beer-bottles-night" value="0" step="1" placeholder="0"></td>
                                    <td><input type="number" class="beer-total-night" readonly placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Tiger</strong></td>
                                    <td><input type="number" class="beer-price-night" value="0" step="0.01" placeholder="0.00"></td>
                                    <td><input type="number" class="beer-bottles-night" value="0" step="1" placeholder="0"></td>
                                    <td><input type="number" class="beer-total-night" readonly placeholder="0.00"></td>
                                </tr>
                                <tr>
                                    <td><strong>Guinness</strong></td>
                                    <td><input type="number" class="beer-price-night" value="0" step="0.01" placeholder="0.00"></td>
                                    <td><input type="number" class="beer-bottles-night" value="0" step="1" placeholder="0"></td>
                                    <td><input type="number" class="beer-total-night" readonly placeholder="0.00"></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="3"><strong>Beer Sales Total</strong></td>
                                    <td><input type="number" id="beerTotalNight" readonly placeholder="0.00"></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-section">
                <!-- TOTAL Section -->
                <div class="section">
                    <div class="section-header" style="background: #27ae60;">TOTAL:</div>
                    <div class="section-content" style="padding: 20px;">
                        <div class="total-item">
                            <span class="total-label">Cash Received:</span>
                            <input type="number" id="nightCashReceived" class="total-input" placeholder="0.00" oninput="calculateNightCashReceived()">
                        </div>
                        <div class="total-item">
                            <span class="total-label">TNG Received:</span>
                            <input type="number" id="nightTngReceived" class="total-input" placeholder="0.00" oninput="calculateNightCashReceived()">
                        </div>
                        <div class="total-display">
                            <span class="total-label"><strong>Total:</strong></span>
                            <span class="total-value" id="nightTotalCashReceived">0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Sales Summary Section -->
                <div class="section">
                    <div class="section-header" style="background: #3498db;">Sales Summary</div>
                    <div class="section-content">
                        <div class="summary-item">
                            <span class="summary-label">Sales Today:</span>
                            <span class="summary-value" id="nightSalesToday">0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Sales of Cigarettes:</span>
                            <span class="summary-value" id="nightSummaryCigaretteSales">0.00</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Coffee Sales:</span>
                            <input type="number" id="nightCoffeeSales" class="summary-input" placeholder="0.00" readonly>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Beer Sales:</span>
                            <span class="summary-value" id="nightSummaryBeerSales">0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Night Section Financial Records History -->
        <div class="history-section" style="margin-top: 30px;">
            <div class="history-header">
                <h3>üìã Night Shift Records History</h3>
                <div class="history-controls">
                    <button class="btn btn-info" onclick="refreshNightHistoryTable()">üîÑ Refresh</button>
                    <button class="btn btn-warning" onclick="exportNightHistoryData()">üì§ Export</button>
                </div>
            </div>
            
            <div class="history-filters">
                <div class="filter-group">
                    <label for="nightDateFilter">Filter by Date:</label>
                    <input type="date" id="nightDateFilter" onchange="filterNightHistoryTable()">
                </div>
                <div class="filter-group">
                    <label for="nightSearchFilter">Search:</label>
                    <input type="text" id="nightSearchFilter" placeholder="Search records..." onkeyup="filterNightHistoryTable()">
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="clearNightFilters()">Clear Filters</button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table" id="nightHistoryTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Shift</th>
                            <th>Total Sales</th>
                            <th>Cash Received</th>
                            <th>TNG Received</th>
                            <th>Total Received</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="nightHistoryTableBody">
                        <!-- Night shift history records will be populated here -->
                    </tbody>
                </table>
                <div id="noNightHistoryMessage" class="no-history-message" style="display: none;">
                    <p>No night shift records found. Start recording night shift finances to see your history here.</p>
                </div>
            </div>
        </div>

        <!-- Night Cash Flow Analysis Table -->
        <div class="section" style="margin-top: 30px;">
            <div class="section-header">üíµ Cash Flow Analysis</div>
            <div class="section-content">
                <div style="margin-bottom: 15px;">
                    <p style="color: #666;">View night shift cash flow details including Cash, TNG, and Total Sales for selected date range.</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generateNightCashFlow30DaysReport()">30 Days</button>
                        <button class="btn btn-info" onclick="generateNightCashFlowCustomReport()">üîç Custom Report</button>
                        <button class="btn btn-success" onclick="exportNightCashFlowToExcel()" style="background-color: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üìä Export to Excel</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="nightCashFlowAnalysisTable">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Date</th>
                                <th style="width: 25%;">Cash Received</th>
                                <th style="width: 25%;">TNG Received</th>
                                <th style="width: 20%;">Total Sales</th>
                                <th style="width: 10%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="nightCashFlowAnalysisTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                                    Select 30 Days or Custom Report to view cash flow data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Night Sale Summary Reports Table -->
        <div class="section" style="margin-top: 30px;">
            <div class="section-header">üìä Sale Summary Reports</div>
            <div class="section-content">
                <div style="margin-bottom: 15px;">
                    <p style="color: #666;">View night shift sales summary including Beer Sales, Coffee Sales, and Total Sales for selected date range.</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generateNightSaleSummary30DaysReport()">30 Days</button>
                        <button class="btn btn-info" onclick="generateNightSaleSummaryCustomReport()">üîç Custom Report</button>
                        <button class="btn btn-success" onclick="exportNightSaleSummaryToExcel()" style="background-color: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üìä Export to Excel</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="nightSaleSummaryTable">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Date</th>
                                <th style="width: 25%;">Beer Sales</th>
                                <th style="width: 25%;">Coffee Sales</th>
                                <th style="width: 20%;">Total Sales</th>
                                <th style="width: 10%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="nightSaleSummaryTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                                    Select 30 Days or Custom Report to view sale summary data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Night Section -->

    </div>
    <!-- End of Main App -->

    <script>
        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            console.log('Login form submitted');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loadingDiv = document.getElementById('loginLoading');
            
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            
            try {
                console.log('Attempting login for:', email);
                const { signInWithEmailAndPassword } = window.firebaseAuth;
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth.auth, email, password);
                console.log('Login successful:', userCredential.user.email);
                
                // Hide login page and show main app
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('signupPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                loadingDiv.style.display = 'none';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = error.message || 'Login failed. Please check your credentials.';
                errorDiv.style.display = 'block';
                console.error('Login error:', error);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorDiv = document.getElementById('signupError');
            const loadingDiv = document.getElementById('signupLoading');
            
            errorDiv.style.display = 'none';
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }
            
            loadingDiv.style.display = 'block';
            
            try {
                const { createUserWithEmailAndPassword } = window.firebaseAuth;
                await createUserWithEmailAndPassword(window.firebaseAuth.auth, email, password);
                console.log('Signup successful');
                // Switch to login view after successful signup
                alert('Account created successfully! Please login.');
                document.getElementById('signupPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                console.error('Signup error:', error);
            }
        }

        // Logout function
        async function handleLogout(event) {
            event.preventDefault();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const { signOut } = window.firebaseAuth;
                    await signOut(window.firebaseAuth.auth);
                    console.log('User logged out successfully');
                    
                    // Show login page and hide main app
                    document.getElementById('loginPage').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }

        // Event ListenersSetupafterDOMready
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const showSignup = document.getElementById('showSignup');
            const showLogin = document.getElementById('showLogin');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('Login form event listener attached');
            }
            
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignup);
                console.log('Signup form event listener attached');
            }
            
            if (showSignup) {
                showSignup.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('signupPage').style.display = 'flex';
                });
            }
            
            if (showLogin) {
                showLogin.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('signupPage').style.display = 'none';
                    document.getElementById('loginPage').style.display = 'flex';
                });
            }
        });

        // Check authentication state on page load
        window.addEventListener('load', async function() {
            // Wait a bit for Firebase to initialize
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (window.firebaseAuth && window.firebaseAuth.auth) {
                // First, try to create the demo user
                try {
                    const { createUserWithEmailAndPassword } = window.firebaseAuth;
                    await createUserWithEmailAndPassword(window.firebaseAuth.auth, 'admin@rdp.com', 'admin123');
                    console.log('Demo user created successfully');
                } catch (error) {
                    console.log('Demo user already exists or error:', error.code);
                }

                // Then check auth state
                window.firebaseAuth.onAuthStateChanged(window.firebaseAuth.auth, async (user) => {
                    console.log('Auth state changed, user:', user ? user.email : 'null');
                    if (user) {
                        // User is logged in
                        const loginPage = document.getElementById('loginPage');
                        const signupPage = document.getElementById('signupPage');
                        const mainApp = document.getElementById('mainApp');
                        
                        if (loginPage) loginPage.style.display = 'none';
                        if (signupPage) signupPage.style.display = 'none';
                        if (mainApp) mainApp.style.display = 'block';
                        console.log('User logged in and shown main app:', user.email);
                        
                        // Load cigarette products when user logs in
                        await loadCigaretteProducts();
                    } else {
                        // User is not logged in
                        const loginPage = document.getElementById('loginPage');
                        const mainApp = document.getElementById('mainApp');
                        
                        if (loginPage) loginPage.style.display = 'flex';
                        if (mainApp) mainApp.style.display = 'none';
                        console.log('User not logged in, showing login page');
                    }
                });
            } else {
                console.error('Firebase Auth not initialized');
                const loginPage = document.getElementById('loginPage');
                const mainApp = document.getElementById('mainApp');
                if (loginPage) loginPage.style.display = 'flex';
                if (mainApp) mainApp.style.display = 'none';
            }
        });

    </script>
    <script>
        // Mobile menu toggle function
        function toggleMobileMenu() {
            const navbarNav = document.getElementById('navbarNav');
            navbarNav.classList.toggle('active');
        }

        // Show/hide mobile instructions
        function showMobileInstructions() {
            const instructions = document.getElementById('mobileInstructions');
            if (window.innerWidth <= 768) {
                instructions.style.display = 'block';
            } else {
                instructions.style.display = 'none';
            }
        }

        function hideMobileInstructions() {
            const instructions = document.getElementById('mobileInstructions');
            instructions.style.display = 'none';
            // Store preference in localStorage
            localStorage.setItem('hideMobileInstructions', 'true');
        }

        // Check if user previously hid instructions
        function checkMobileInstructionsPreference() {
            const hideInstructions = localStorage.getItem('hideMobileInstructions');
            if (hideInstructions === 'true') {
                return;
            }
            showMobileInstructions();
        }
        // Initialize mobile instructions
        window.addEventListener('resize', function() {
            showMobileInstructions();
        });
        window.addEventListener('load', function() {
            checkMobileInstructionsPreference();
        });
        document.addEventListener('click', function(event) {
            const navbarNav = document.getElementById('navbarNav');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            
            if (!navbarNav.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                navbarNav.classList.remove('active');
            }
        });

        // Close mobile menu when window is resized to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                const navbarNav = document.getElementById('navbarNav');
                navbarNav.classList.remove('active');
            }
            
            // Resize charts on mobile
            resizeChartsForMobile();
        });

        // Mobile chart resizing function
        function resizeChartsForMobile() {
            const isMobile = window.innerWidth <= 768;
            const chartContainers = document.querySelectorAll('.chart-wrapper');
            
            chartContainers.forEach(container => {
                if (isMobile) {
                    container.style.height = '250px';
                } else {
                    container.style.height = '400px';
                }
            });
            
            // Resize all charts
            Object.values(charts).forEach(chart => {
                if (chart && chart.resize) {
                    chart.resize();
                }
            });
        }

        // Touch-friendly interactions for mobile
        function addMobileTouchSupport() {
            // Add touch support for buttons
            const buttons = document.querySelectorAll('.btn, .btn-action, .nav-link');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
            
            // Prevent zoom on input focus for mobile
            const inputs = document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"]');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth <= 768) {
                        this.style.fontSize = '16px';
                    }
                });
                
                input.addEventListener('blur', function() {
                    if (window.innerWidth <= 768) {
                        this.style.fontSize = '12px';
                    }
                });
            });
        }
        // Firestore data management
        let savedExpenses = [];
        let savedSalaries = [];
        let savedBankExpenses = [];
        let dailyFinanceData = [];
        let nightShiftData = [];

        // Initialize Firestore collections
        const COLLECTIONS = {
            EXPENSES: 'expenseTemplates',
            SALARIES: 'salaryTemplates', 
            BANK_EXPENSES: 'bankExpenseTemplates',
            DAILY_DATA: 'dailyFinanceData',
            RENTALS: 'rentalTemplates'
        };

        // Real-time data synchronization
        let unsubscribeFunctions = [];

        // Set up real-time listeners for cross-device sync
        async function setupRealtimeListeners() {
            try {
                updateSyncStatus('syncing', 'Setting up real-time sync...');
                
                const { onSnapshot, collection, query, orderBy, db } = window.firestoreDB;
                
                // Listen to daily finance data changes
                const dailyDataQuery = query(collection(db, COLLECTIONS.DAILY_DATA), orderBy('createdAt', 'desc'));
                const unsubscribeDailyData = onSnapshot(dailyDataQuery, (snapshot) => {
                    const data = [];
                    snapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    dailyFinanceData = data;
                    populateHistoryTable(data);
                    console.log('Daily data updated from Firestore:', data.length, 'records');
                }, (error) => {
                    console.error('Daily data listener error:', error);
                    updateSyncStatus('error', 'Sync error');
                });
                unsubscribeFunctions.push(unsubscribeDailyData);

                // Listen to expense templates changes
                const expenseQuery = query(collection(db, COLLECTIONS.EXPENSES), orderBy('createdAt', 'desc'));
                const unsubscribeExpenses = onSnapshot(expenseQuery, (snapshot) => {
                    const data = [];
                    snapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    savedExpenses = data;
                    updateExpenseSuggestions();
                    console.log('Expense templates updated from Firestore:', data.length, 'templates');
                }, (error) => {
                    console.error('Expense templates listener error:', error);
                });
                unsubscribeFunctions.push(unsubscribeExpenses);

                // Listen to salary templates changes
                const salaryQuery = query(collection(db, COLLECTIONS.SALARIES), orderBy('createdAt', 'desc'));
                const unsubscribeSalaries = onSnapshot(salaryQuery, (snapshot) => {
                    const data = [];
                    snapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    savedSalaries = data;
                    updateSalarySuggestions();
                    console.log('Salary templates updated from Firestore:', data.length, 'templates');
                }, (error) => {
                    console.error('Salary templates listener error:', error);
                });
                unsubscribeFunctions.push(unsubscribeSalaries);

                // Listen to bank expense templates changes
                const bankExpenseQuery = query(collection(db, COLLECTIONS.BANK_EXPENSES), orderBy('createdAt', 'desc'));
                const unsubscribeBankExpenses = onSnapshot(bankExpenseQuery, (snapshot) => {
                    const data = [];
                    snapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    savedBankExpenses = data;
                    updateBankExpenseSuggestions();
                    console.log('Bank expense templates updated from Firestore:', data.length, 'templates');
                }, (error) => {
                    console.error('Bank expense templates listener error:', error);
                });
                unsubscribeFunctions.push(unsubscribeBankExpenses);

                // Listen to rental templates changes (without orderBy to avoid index requirement)
                const rentalQuery = query(collection(db, COLLECTIONS.RENTALS), orderBy('createdAt', 'desc'));
                const unsubscribeRentals = onSnapshot(rentalQuery, (snapshot) => {
                    const data = [];
                    snapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    savedRentals = data;
                    updateRentalTable();
                    console.log('Rental templates updated from Firestore:', data.length, 'templates');
                }, (error) => {
                    console.error('Rental templates listener error:', error);
                });
                unsubscribeFunctions.push(unsubscribeRentals);

                // Listen to cigarette products settings changes (REAL-TIME SYNC)
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (user) {
                    const { doc, onSnapshot } = window.firestoreDB;
                    const cigaretteSettingsRef = doc(db, 'users', user.uid, 'settings', 'cigaretteProducts');
                    const unsubscribeCigaretteProducts = onSnapshot(cigaretteSettingsRef, (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            if (data.products && Array.isArray(data.products) && data.products.length > 0) {
                                cigaretteProducts = data.products;
                                // Also save to localStorage as backup
                                localStorage.setItem('cigaretteProducts', JSON.stringify(cigaretteProducts));
                                console.log('Cigarette products updated from Firestore (real-time):', cigaretteProducts.length, 'products');
                                
                                // Update all tables that use cigarette products
                                updateCigaretteTable();
                                updateNightCigaretteTable();
                                
                                // Update product settings display if it's visible
                                const backendSections = document.querySelectorAll('.backend-section');
                                backendSections.forEach(section => {
                                    if (section.querySelector('h1') && section.querySelector('h1').textContent.includes('Product Settings')) {
                                        showProductSettingsSection();
                                    }
                                });
                            }
                        } else {
                            console.log('Cigarette products document does not exist yet, using defaults or localStorage');
                            // Try localStorage as fallback
                            const localProducts = localStorage.getItem('cigaretteProducts');
                            if (localProducts) {
                                try {
                                    cigaretteProducts = JSON.parse(localProducts);
                                    updateCigaretteTable();
                                    updateNightCigaretteTable();
                                } catch (e) {
                                    console.error('Error parsing local cigarette products:', e);
                                }
                            } else {
                                // Keep default products, but update tables
                                updateCigaretteTable();
                                updateNightCigaretteTable();
                            }
                        }
                    }, (error) => {
                        console.error('Cigarette products listener error:', error);
                        // Fallback to localStorage
                        const localProducts = localStorage.getItem('cigaretteProducts');
                        if (localProducts) {
                            try {
                                cigaretteProducts = JSON.parse(localProducts);
                                updateCigaretteTable();
                                updateNightCigaretteTable();
                            } catch (e) {
                                console.error('Error parsing local cigarette products:', e);
                            }
                        }
                    });
                    unsubscribeFunctions.push(unsubscribeCigaretteProducts);
                    console.log('Cigarette products real-time listener set up');
                    
                    // Listen to night shift data changes (user-specific collection)
                    const nightShiftDataRef = collection(db, `users/${user.uid}/nightShiftData`);
                    
                    // Try with orderBy first - if index not available, will fallback in error handler
                    const nightShiftQuery = query(nightShiftDataRef, orderBy('date', 'desc'));
                    
                    const unsubscribeNightShift = onSnapshot(nightShiftQuery, (snapshot) => {
                        const data = [];
                        snapshot.forEach((doc) => {
                            data.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Always sort by date descending to ensure consistent ordering
                        // (even if orderBy was used, sorting again doesn't hurt)
                        data.sort((a, b) => {
                            const dateA = new Date(a.date || a.createdAt || 0);
                            const dateB = new Date(b.date || b.createdAt || 0);
                            return dateB - dateA;
                        });
                        
                        nightShiftData = data;
                        
                        // Update night history table if it's visible
                        if (document.getElementById('nightHistoryTableBody')) {
                            populateNightHistoryTable(data);
                        }
                        
                        // Update sync status to show real-time sync is working
                        updateSyncStatus('connected', `Synced - ${data.length} night records`);
                        
                        console.log('üåô Night shift data updated from Firestore (real-time sync):', data.length, 'records');
                        
                        // Show notification if data was updated from another device (optional - could be noisy)
                        // We'll keep it silent to avoid too many notifications
                    }, (error) => {
                        console.error('‚ùå Night shift data listener error:', error);
                        
                        // If orderBy fails, try without orderBy
                        if (error.code === 'failed-precondition' || error.message.includes('index')) {
                            console.log('‚ö†Ô∏è Retrying without orderBy...');
                            const fallbackQuery = collection(db, `users/${user.uid}/nightShiftData`);
                            const unsubscribeFallback = onSnapshot(fallbackQuery, (snapshot) => {
                                const data = [];
                                snapshot.forEach((doc) => {
                                    data.push({ id: doc.id, ...doc.data() });
                                });
                                data.sort((a, b) => {
                                    const dateA = new Date(a.date || a.createdAt || 0);
                                    const dateB = new Date(b.date || b.createdAt || 0);
                                    return dateB - dateA;
                                });
                                nightShiftData = data;
                                if (document.getElementById('nightHistoryTableBody')) {
                                    populateNightHistoryTable(data);
                                }
                                updateSyncStatus('connected', `Synced - ${data.length} night records`);
                                console.log('‚úÖ Night shift data synced (fallback mode):', data.length, 'records');
                            }, (fallbackError) => {
                                console.error('‚ùå Night shift fallback listener error:', fallbackError);
                                updateSyncStatus('error', 'Sync error - check console');
                            });
                            unsubscribeFunctions.push(unsubscribeFallback);
                        } else {
                            updateSyncStatus('error', 'Sync error');
                        }
                    });
                    unsubscribeFunctions.push(unsubscribeNightShift);
                    console.log('‚úÖ Night shift data real-time listener set up - data will sync across all devices');
                }

                console.log('Real-time listeners set up successfully');
                updateSyncStatus('connected', 'Real-time sync active');
                
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
                updateSyncStatus('error', 'Failed to setup sync');
            }
        }

        // Clean up listeners when page unloads
        function cleanupRealtimeListeners() {
            unsubscribeFunctions.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            unsubscribeFunctions = [];
            console.log('Real-time listeners cleaned up');
        }

        // Update sync status indicator
        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            const syncIcon = syncStatus.querySelector('.sync-icon');
            const syncText = syncStatus.querySelector('.sync-text');
            
            syncStatus.className = `sync-status ${status}`;
            syncText.textContent = message;
            
            switch(status) {
                case 'connected':
                    syncIcon.textContent = '‚úÖ';
                    syncIcon.style.animation = 'none';
                    break;
                case 'syncing':
                    syncIcon.textContent = 'üîÑ';
                    syncIcon.style.animation = 'spin 2s linear infinite';
                    break;
                case 'error':
                    syncIcon.textContent = '‚ùå';
                    syncIcon.style.animation = 'none';
                    break;
                default:
                    syncIcon.textContent = 'üîÑ';
                    syncIcon.style.animation = 'spin 2s linear infinite';
            }
        }

        // Check Firestore connection status
        async function checkFirestoreConnection() {
            try {
                const { getDocs, collection } = window.firestoreDB;
                await getDocs(collection(window.firestoreDB.db, COLLECTIONS.DAILY_DATA));
                updateSyncStatus('connected', 'Synced with Firestore');
                return true;
            } catch (error) {
                console.error('Firestore connection error:', error);
                updateSyncStatus('error', 'Connection failed');
                return false;
            }
        }

        // Add device info to data for better tracking
        function addDeviceInfo(data) {
            return {
                ...data,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    timestamp: new Date().toISOString()
                }
            };
        }
        async function saveToFirestore(collectionName, data) {
            try {
                const { addDoc, collection, db } = window.firestoreDB;
                const docRef = await addDoc(collection(db, collectionName), {
                    ...data,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                console.log('Document written with ID: ', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error adding document: ', error);
                console.error('Error details:', error.message, error.code);
                alert('Error: ' + error.message);
                throw error;
            }
        }

        async function getFromFirestore(collectionName) {
            try {
                const { getDocs, collection, query, orderBy, db } = window.firestoreDB;
                const q = query(collection(db, collectionName), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error('Error getting documents: ', error);
                return [];
            }
        }

        async function updateFirestoreDoc(collectionName, docId, data) {
            try {
                const { updateDoc, doc, db } = window.firestoreDB;
                await updateDoc(doc(db, collectionName, docId), {
                    ...data,
                    updatedAt: new Date()
                });
                console.log('Document updated successfully');
            } catch (error) {
                console.error('Error updating document: ', error);
                throw error;
            }
        }

        async function deleteFromFirestore(collectionName, docId) {
            try {
                const { deleteDoc, doc, db } = window.firestoreDB;
                await deleteDoc(doc(db, collectionName, docId));
                console.log('Document deleted successfully');
            } catch (error) {
                console.error('Error deleting document: ', error);
                throw error;
            }
        }

        // History Table Functions
        async function refreshHistoryTable() {
            try {
                const savedData = await getFromFirestore(COLLECTIONS.DAILY_DATA);
                dailyFinanceData = savedData;
                populateHistoryTable(savedData);
            } catch (error) {
                console.error('Error loading history data:', error);
                // Fallback to localStorage if Firestore fails
                const localData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const cleanedData = removeDuplicateRecords(localData);
                populateHistoryTable(cleanedData);
            }
        }

        function removeDuplicateRecords(data) {
            // Remove duplicates by keeping only the latest record for each date
            const uniqueRecords = [];
            const dateMap = new Map();
            
            // Sort by date to ensure we keep the most recent record for each date
            const sortedData = data.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach(record => {
                if (!dateMap.has(record.date)) {
                    dateMap.set(record.date, true);
                    uniqueRecords.push(record);
                }
            });
            
            return uniqueRecords;
        }

        function populateHistoryTable(data) {
            const tbody = document.getElementById('historyTableBody');
            const noMessage = document.getElementById('noHistoryMessage');
            
            if (data.length === 0) {
                tbody.innerHTML = '';
                noMessage.style.display = 'block';
                return;
            }

            noMessage.style.display = 'none';
            
            // Sort data by date (newest first)
            const sortedData = data.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedData.map(record => {
                const totalSales = parseFloat(record.salesToday || 0);
                const totalExpenses = parseFloat(record.totalExpenses || 0) + 
                                    parseFloat(record.totalBankExpenses || 0) + 
                                    parseFloat(record.totalSalary || 0);
                const netProfit = totalSales - totalExpenses;
                
                const profitClass = netProfit > 0 ? 'profit-positive' : 
                                  netProfit < 0 ? 'profit-negative' : 'profit-zero';
                
                return `
                    <tr>
                        <td>${formatDate(record.date)}</td>
                        <td>RM ${totalSales.toFixed(2)}</td>
                        <td>RM ${totalExpenses.toFixed(2)}</td>
                        <td class="${profitClass}">RM ${netProfit.toFixed(2)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewRecord('${record.date}')" title="View Details">üëÅÔ∏è</button>
                                <button class="btn-action btn-edit" onclick="editRecord('${record.date}')" title="Edit Record">‚úèÔ∏è</button>
                                <button class="btn-action btn-delete" onclick="deleteRecord('${record.date}')" title="Delete Record">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterHistoryTable() {
            const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            let filteredData = savedData;
            
            // Filter by date
            if (dateFilter) {
                filteredData = filteredData.filter(record => record.date === dateFilter);
            }
            
            // Filter by search term
            if (searchFilter) {
                filteredData = filteredData.filter(record => {
                    const totalSales = parseFloat(record.salesToday || 0);
                    const totalExpenses = parseFloat(record.totalExpenses || 0) + 
                                        parseFloat(record.totalBankExpenses || 0) + 
                                        parseFloat(record.totalSalary || 0);
                    const netProfit = totalSales - totalExpenses;
                    
                    return record.date.includes(searchFilter) ||
                           totalSales.toString().includes(searchFilter) ||
                           totalExpenses.toString().includes(searchFilter) ||
                           netProfit.toString().includes(searchFilter);
                });
            }
            
            populateHistoryTable(filteredData);
        }

        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('searchFilter').value = '';
            refreshHistoryTable();
        }

        function viewRecord(date) {
            // Search in Firestore data
            const record = dailyFinanceData.find(r => r.date === date);
            
            if (!record) {
                alert('Record not found!');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'edit-modal';
            modal.innerHTML = `
                <div class="edit-modal-content">
                    <h2>üìã Record Details - ${formatDate(date)}</h2>
                    <div class="edit-form-group">
                        <label>Total Sales:</label>
                        <input type="text" value="RM ${parseFloat(record.salesToday || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Cigarette Sales:</label>
                        <input type="text" value="RM ${parseFloat(record.cigaretteSales || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Rental Collection:</label>
                        <input type="text" value="RM ${parseFloat(record.rentalCollection || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Coffee Sales:</label>
                        <input type="text" value="RM ${parseFloat(record.coffeeSales || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Total Expenses:</label>
                        <input type="text" value="RM ${parseFloat(record.totalExpenses || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Bank Expenses:</label>
                        <input type="text" value="RM ${parseFloat(record.totalBankExpenses || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Total Salary/Gaji:</label>
                        <input type="text" value="RM ${parseFloat(record.totalSalary || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Cash Received:</label>
                        <input type="text" value="RM ${parseFloat(record.cashReceived || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>TNG Received:</label>
                        <input type="text" value="RM ${parseFloat(record.tngReceived || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Grab Received:</label>
                        <input type="text" value="RM ${parseFloat(record.grabReceived || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-form-group">
                        <label>Shopee Received:</label>
                        <input type="text" value="RM ${parseFloat(record.shopeeReceived || 0).toFixed(2)}" readonly>
                    </div>
                    <div class="edit-modal-buttons">
                        <button class="btn btn-secondary" onclick="this.closest('.edit-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function editRecord(date) {
            // Search in Firestore data
            const record = dailyFinanceData.find(r => r.date === date);
            
            if (!record) {
                alert('Record not found!');
                return;
            }

            // Prepare expenses HTML
            let expensesHTML = '';
            if (record.expenses && Array.isArray(record.expenses) && record.expenses.length > 0) {
                expensesHTML = record.expenses.map((exp, idx) => {
                    const name = (exp.name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const amount = exp.amount || 0;
                    return `
                    <div class="expense-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <input type="text" class="edit-expense-name" value="${name}" placeholder="Expense name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="edit-expense-amount" value="${amount}" step="0.01" placeholder="0.00" oninput="updateEditExpensesTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-danger" onclick="removeEditExpenseRow(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
                }).join('');
            } else {
                expensesHTML = `
                    <div class="expense-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <input type="text" class="edit-expense-name" placeholder="Expense name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="edit-expense-amount" value="0" step="0.01" placeholder="0.00" oninput="updateEditExpensesTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-danger" onclick="removeEditExpenseRow(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
            }

            // Prepare bank expenses HTML
            let bankExpensesHTML = '';
            if (record.bankExpenses && Array.isArray(record.bankExpenses) && record.bankExpenses.length > 0) {
                bankExpensesHTML = record.bankExpenses.map((exp, idx) => {
                    const name = (exp.name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const amount = exp.amount || 0;
                    return `
                    <div class="bank-expense-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <input type="text" class="edit-bank-expense-name" value="${name}" placeholder="Expense name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="edit-bank-expense-amount" value="${amount}" step="0.01" placeholder="0.00" oninput="updateEditBankExpensesTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-danger" onclick="removeEditBankExpenseRow(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
                }).join('');
            } else {
                bankExpensesHTML = `
                    <div class="bank-expense-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <input type="text" class="edit-bank-expense-name" placeholder="Expense name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="edit-bank-expense-amount" value="0" step="0.01" placeholder="0.00" oninput="updateEditBankExpensesTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-danger" onclick="removeEditBankExpenseRow(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
            }

            // Prepare salaries HTML
            let salariesHTML = '';
            if (record.salaries && Array.isArray(record.salaries) && record.salaries.length > 0) {
                salariesHTML = record.salaries.map((sal, idx) => {
                    const name = (sal.name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const amount = sal.amount || 0;
                    return `
                    <div class="salary-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <input type="text" class="edit-salary-name" value="${name}" placeholder="Salary name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="edit-salary-amount" value="${amount}" step="0.01" placeholder="0.00" oninput="updateEditSalaryTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-danger" onclick="removeEditSalaryRow(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
                }).join('');
            } else {
                salariesHTML = `
                    <div class="salary-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <input type="text" class="edit-salary-name" placeholder="Salary name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="edit-salary-amount" value="0" step="0.01" placeholder="0.00" oninput="updateEditSalaryTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-danger" onclick="removeEditSalaryRow(this)" style="padding: 8px 12px;">√ó</button>
                    </div>
                `;
            }

            const modal = document.createElement('div');
            modal.className = 'edit-modal';
            // Store cashExpenses and cashSalary in modal data attributes for Coffee Sales calculation
            modal.dataset.cashExpenses = record.cashExpenses || 0;
            modal.dataset.cashSalary = record.cashSalary || 0;
            modal.innerHTML = `
                <div class="edit-modal-content">
                    <h2>‚úèÔ∏è Edit Record - ${formatDate(date)}</h2>
                    <div class="edit-form-group">
                        <label>Cigarette Sales:</label>
                        <input type="number" id="editCigaretteSales" value="${record.cigaretteSales || 0}" step="0.01" oninput="updateEditCoffeeSales()">
                    </div>
                    <div class="edit-form-group">
                        <label>Rental Collection:</label>
                        <input type="number" id="editRentalCollection" value="${record.rentalCollection || 0}" step="0.01" oninput="updateEditCoffeeSales()">
                    </div>
                    <div class="edit-form-group">
                        <label>Coffee Sales:</label>
                        <input type="number" id="editCoffeeSales" value="${record.coffeeSales || 0}" step="0.01" readonly style="background-color: #f5f5f5; cursor: not-allowed;" title="Coffee Sales is automatically calculated based on Total Sales - Cigarette Sales - Rental Collection">
                    </div>
                    <div class="edit-form-group">
                        <label>Expenses:</label>
                        <div style="margin-top: 10px;">
                            <div id="editExpensesList" style="margin-bottom: 10px;">
                                ${expensesHTML}
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addEditExpenseRow()" style="margin-bottom: 10px;">+ Add Expense</button>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight: bold;">Total Expenses:</label>
                                <input type="number" id="editTotalExpenses" value="${record.totalExpenses || 0}" step="0.01" readonly style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                    <div class="edit-form-group">
                        <label>Bank Expenses:</label>
                        <div style="margin-top: 10px;">
                            <div id="editBankExpensesList" style="margin-bottom: 10px;">
                                ${bankExpensesHTML}
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addEditBankExpenseRow()" style="margin-bottom: 10px;">+ Add Bank Expense</button>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight: bold;">Total Bank Expenses:</label>
                                <input type="number" id="editTotalBankExpenses" value="${record.totalBankExpenses || 0}" step="0.01" readonly style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                    <div class="edit-form-group">
                        <label>Salary/Gaji:</label>
                        <div style="margin-top: 10px;">
                            <div id="editSalariesList" style="margin-bottom: 10px;">
                                ${salariesHTML}
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addEditSalaryRow()" style="margin-bottom: 10px;">+ Add Salary/Gaji</button>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight: bold;">Total Salary/Gaji:</label>
                                <input type="number" id="editTotalSalary" value="${record.totalSalary || 0}" step="0.01" readonly style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                    <div class="edit-form-group">
                        <label>Cash Received:</label>
                        <input type="number" id="editCashReceived" value="${record.cashReceived || 0}" step="0.01" oninput="updateEditCoffeeSales()">
                    </div>
                    <div class="edit-form-group">
                        <label>TNG Received:</label>
                        <input type="number" id="editTngReceived" value="${record.tngReceived || 0}" step="0.01" oninput="updateEditCoffeeSales()">
                    </div>
                    <div class="edit-form-group">
                        <label>Grab Received:</label>
                        <input type="number" id="editGrabReceived" value="${record.grabReceived || 0}" step="0.01" oninput="updateEditCoffeeSales()">
                    </div>
                    <div class="edit-form-group">
                        <label>Shopee Received:</label>
                        <input type="number" id="editShopeeReceived" value="${record.shopeeReceived || 0}" step="0.01" oninput="updateEditCoffeeSales()">
                    </div>
                    <div class="edit-modal-buttons">
                        <button class="btn btn-success" onclick="saveEditedRecord('${date}')">üíæ Save Changes</button>
                        <button class="btn btn-secondary" onclick="this.closest('.edit-modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calculate all totals when modal opens
            setTimeout(() => {
                updateEditExpensesTotal();
                updateEditBankExpensesTotal();
                updateEditSalaryTotal();
                updateEditCoffeeSales(); // Calculate Coffee Sales based on current values
            }, 100);
        }

        function updateEditCoffeeSales() {
            // Get cash inputs to calculate salesToday
            const cashReceived = parseFloat(document.getElementById('editCashReceived')?.value || 0) || 0;
            const tngReceived = parseFloat(document.getElementById('editTngReceived')?.value || 0) || 0;
            const grabReceived = parseFloat(document.getElementById('editGrabReceived')?.value || 0) || 0;
            const shopeeReceived = parseFloat(document.getElementById('editShopeeReceived')?.value || 0) || 0;
            
            // Get cash expenses and salary from the record (they might not be editable in modal)
            const modal = document.querySelector('.edit-modal');
            if (!modal) return;
            
            // Try to get from data attribute or use 0
            const cashExpenses = parseFloat(modal.dataset.cashExpenses || 0) || 0;
            const cashSalary = parseFloat(modal.dataset.cashSalary || 0) || 0;
            
            // Calculate salesToday - NEW FORMULA
            const salesToday = cashReceived + tngReceived + cashExpenses + cashSalary + grabReceived + shopeeReceived;
            
            // Get cigarette sales and rental collection
            const cigaretteSales = parseFloat(document.getElementById('editCigaretteSales')?.value || 0) || 0;
            const rentalCollection = parseFloat(document.getElementById('editRentalCollection')?.value || 0) || 0;
            
            // Calculate Coffee Sales - NEW FORMULA: Sales Today - Cigarette Sales - Rental Collection
            const coffeeSales = Math.max(0, salesToday - cigaretteSales - rentalCollection);
            
            // Update the Coffee Sales field
            const coffeeSalesInput = document.getElementById('editCoffeeSales');
            if (coffeeSalesInput) {
                coffeeSalesInput.value = coffeeSales.toFixed(2);
            }
        }

        // Add expense row in edit modal
        function addEditExpenseRow() {
            const list = document.getElementById('editExpensesList');
            if (!list) return;
            
            const row = document.createElement('div');
            row.className = 'expense-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="edit-expense-name" placeholder="Expense name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" class="edit-expense-amount" value="0" step="0.01" placeholder="0.00" oninput="updateEditExpensesTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" class="btn btn-danger" onclick="removeEditExpenseRow(this)" style="padding: 8px 12px;">√ó</button>
            `;
            list.appendChild(row);
        }

        // Remove expense row in edit modal
        function removeEditExpenseRow(button) {
            const row = button.closest('.expense-row');
            if (row) {
                row.remove();
                updateEditExpensesTotal();
            }
        }

        // Update total expenses in edit modal
        function updateEditExpensesTotal() {
            const totalInput = document.getElementById('editTotalExpenses');
            if (!totalInput) return;
            
            const amountInputs = document.querySelectorAll('.edit-expense-amount');
            let total = 0;
            amountInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            totalInput.value = total.toFixed(2);
        }

        // Get expenses data from edit modal
        function getEditExpensesData() {
            const expenses = [];
            const rows = document.querySelectorAll('#editExpensesList .expense-row');
            rows.forEach(row => {
                const nameInput = row.querySelector('.edit-expense-name');
                const amountInput = row.querySelector('.edit-expense-amount');
                if (nameInput && amountInput && nameInput.value.trim()) {
                    expenses.push({
                        name: nameInput.value.trim(),
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return expenses;
        }

        // Add salary row in edit modal
        function addEditSalaryRow() {
            const list = document.getElementById('editSalariesList');
            if (!list) return;
            
            const row = document.createElement('div');
            row.className = 'salary-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="edit-salary-name" placeholder="Salary name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" class="edit-salary-amount" value="0" step="0.01" placeholder="0.00" oninput="updateEditSalaryTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" class="btn btn-danger" onclick="removeEditSalaryRow(this)" style="padding: 8px 12px;">√ó</button>
            `;
            list.appendChild(row);
        }

        // Remove salary row in edit modal
        function removeEditSalaryRow(button) {
            const row = button.closest('.salary-row');
            if (row) {
                row.remove();
                updateEditSalaryTotal();
            }
        }

        // Update total salary in edit modal
        function updateEditSalaryTotal() {
            const totalInput = document.getElementById('editTotalSalary');
            if (!totalInput) return;
            
            const amountInputs = document.querySelectorAll('.edit-salary-amount');
            let total = 0;
            amountInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            totalInput.value = total.toFixed(2);
        }

        // Get salaries data from edit modal
        function getEditSalariesData() {
            const salaries = [];
            const rows = document.querySelectorAll('#editSalariesList .salary-row');
            rows.forEach(row => {
                const nameInput = row.querySelector('.edit-salary-name');
                const amountInput = row.querySelector('.edit-salary-amount');
                if (nameInput && amountInput && nameInput.value.trim()) {
                    salaries.push({
                        name: nameInput.value.trim(),
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return salaries;
        }

        // Add bank expense row in edit modal
        function addEditBankExpenseRow() {
            const list = document.getElementById('editBankExpensesList');
            if (!list) return;
            
            const row = document.createElement('div');
            row.className = 'bank-expense-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            row.innerHTML = `
                <input type="text" class="edit-bank-expense-name" placeholder="Expense name" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" class="edit-bank-expense-amount" value="0" step="0.01" placeholder="0.00" oninput="updateEditBankExpensesTotal()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" class="btn btn-danger" onclick="removeEditBankExpenseRow(this)" style="padding: 8px 12px;">√ó</button>
            `;
            list.appendChild(row);
        }

        // Remove bank expense row in edit modal
        function removeEditBankExpenseRow(button) {
            const row = button.closest('.bank-expense-row');
            if (row) {
                row.remove();
                updateEditBankExpensesTotal();
            }
        }

        // Update total bank expenses in edit modal
        function updateEditBankExpensesTotal() {
            const totalInput = document.getElementById('editTotalBankExpenses');
            if (!totalInput) return;
            
            const amountInputs = document.querySelectorAll('.edit-bank-expense-amount');
            let total = 0;
            amountInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            totalInput.value = total.toFixed(2);
        }

        // Get bank expenses data from edit modal
        function getEditBankExpensesData() {
            const expenses = [];
            const rows = document.querySelectorAll('#editBankExpensesList .bank-expense-row');
            rows.forEach(row => {
                const nameInput = row.querySelector('.edit-bank-expense-name');
                const amountInput = row.querySelector('.edit-bank-expense-amount');
                if (nameInput && amountInput && nameInput.value.trim()) {
                    expenses.push({
                        name: nameInput.value.trim(),
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return expenses;
        }

        async function saveEditedRecord(date) {
            // Find the record in Firestore data
            const record = dailyFinanceData.find(r => r.date === date);
            
            if (!record) {
                alert('Record not found!');
                return;
            }

            // Get expenses, bank expenses, and salaries arrays
            const expenses = getEditExpensesData();
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            const bankExpenses = getEditBankExpensesData();
            const totalBankExpenses = bankExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            const salaries = getEditSalariesData();
            const totalSalary = salaries.reduce((sum, sal) => sum + sal.amount, 0);

            // Get edited values
            const editedRecord = {
                cigaretteSales: parseFloat(document.getElementById('editCigaretteSales').value) || 0,
                rentalCollection: parseFloat(document.getElementById('editRentalCollection').value) || 0,
                // Coffee Sales will be calculated automatically below, not from input field
                expenses: expenses, // Save the array with names and amounts
                totalExpenses: totalExpenses, // Save the calculated total
                bankExpenses: bankExpenses, // Save the array with names and amounts
                totalBankExpenses: totalBankExpenses, // Save the calculated total
                salaries: salaries, // Save the array with names and amounts
                totalSalary: totalSalary, // Save the calculated total
                cashReceived: parseFloat(document.getElementById('editCashReceived').value) || 0,
                tngReceived: parseFloat(document.getElementById('editTngReceived').value) || 0,
                grabReceived: parseFloat(document.getElementById('editGrabReceived').value) || 0,
                shopeeReceived: parseFloat(document.getElementById('editShopeeReceived').value) || 0,
                updatedAt: new Date()
            };

            // Get cash expenses and salary from record (they might not be in edit modal)
            const cashExpenses = parseFloat(record.cashExpenses || 0);
            const cashSalary = parseFloat(record.cashSalary || 0);
            
            // Calculate sales today - NEW FORMULA: Cash Received + TNG Received + Expenses paid by Cash + Salary paid by cash + Grab Received + Shopee Received
            const cashReceived = parseFloat(document.getElementById('editCashReceived').value) || 0;
            const tngReceived = parseFloat(document.getElementById('editTngReceived').value) || 0;
            const grabReceived = parseFloat(document.getElementById('editGrabReceived').value) || 0;
            const shopeeReceived = parseFloat(document.getElementById('editShopeeReceived').value) || 0;
            
            editedRecord.salesToday = cashReceived + tngReceived + cashExpenses + cashSalary + grabReceived + shopeeReceived;
            
            // Calculate Coffee Sales - NEW FORMULA: Sales Today - Cigarette Sales - Rental Collection
            editedRecord.coffeeSales = Math.max(0, editedRecord.salesToday - editedRecord.cigaretteSales - editedRecord.rentalCollection);

            try {
                // Update the record in Firestore
                await updateFirestoreDoc(COLLECTIONS.DAILY_DATA, record.id, editedRecord);
                
                // Close modal and refresh table
                document.querySelector('.edit-modal').remove();
                await refreshHistoryTable();
                
                alert('Record updated successfully!');
            } catch (error) {
                console.error('Error updating record:', error);
                alert('Error updating record. Please try again.');
            }
        }

        async function deleteRecord(date) {
            if (!confirm(`Are you sure you want to delete the record for ${formatDate(date)}? This action cannot be undone!`)) {
                return;
            }

            try {
                // Find the record in Firestore data
                const record = dailyFinanceData.find(r => r.date === date);
                
                if (!record) {
                    alert('Record not found!');
                    return;
                }
                
                // Delete from Firestore
                await deleteFromFirestore(COLLECTIONS.DAILY_DATA, record.id);
                console.log('Record deleted from Firestore');
                
                // Also delete from localStorage
                const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const recordIndex = savedData.findIndex(r => r.date === date);
                
                if (recordIndex !== -1) {
                    savedData.splice(recordIndex, 1);
                    localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));
                }
                
                // Refresh history table
                await refreshHistoryTable();
                
                alert('Record deleted successfully from Firestore!');
            } catch (error) {
                console.error('Error deleting from Firestore:', error);
                
                // Fallback to localStorage only
                const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const recordIndex = savedData.findIndex(r => r.date === date);
                
                if (recordIndex === -1) {
                    alert('Record not found!');
                    return;
                }
                
                savedData.splice(recordIndex, 1);
                localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));
                refreshHistoryTable();
                
                alert('Record deleted locally (Firestore unavailable). Please check your internet connection.');
            }
        }

        function exportHistoryData() {
            const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            if (savedData.length === 0) {
                alert('No data to export!');
                return;
            }

            // Create CSV content
            let csvContent = 'Date,Total Sales,Total Expenses,Net Profit,Cigarette Sales,Rental Collection,Coffee Sales,Beer Sales,Cash Received,TNG Received,Grab Received,Shopee Received\n';
            
            savedData.forEach(record => {
                const totalSales = parseFloat(record.salesToday || 0);
                const totalExpenses = parseFloat(record.totalExpenses || 0) + 
                                    parseFloat(record.totalBankExpenses || 0) + 
                                    parseFloat(record.totalSalary || 0);
                const netProfit = totalSales - totalExpenses;
                
                csvContent += `${record.date},${totalSales.toFixed(2)},${totalExpenses.toFixed(2)},${netProfit.toFixed(2)},${parseFloat(record.cigaretteSales || 0).toFixed(2)},${parseFloat(record.rentalCollection || 0).toFixed(2)},${parseFloat(record.coffeeSales || 0).toFixed(2)},${parseFloat(record.beerSales || 0).toFixed(2)},${parseFloat(record.cashReceived || 0).toFixed(2)},${parseFloat(record.tngReceived || 0).toFixed(2)},${parseFloat(record.grabReceived || 0).toFixed(2)},${parseFloat(record.shopeeReceived || 0).toFixed(2)}\n`;
            });

            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial_history_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('History data exported successfully!');
        }

        // ============ NIGHT SHIFT HISTORY FUNCTIONS ============
        
        async function refreshNightHistoryTable() {
            try {
                const { db, collection, getDocs } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;

                if (!user) {
                    // Fallback to localStorage
                    const localData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                    nightShiftData = localData;
                    populateNightHistoryTable(localData);
                    return;
                }

                const nightDataRef = collection(db, `users/${user.uid}/nightShiftData`);
                const querySnapshot = await getDocs(nightDataRef);
                const savedData = [];
                
                querySnapshot.forEach(doc => {
                    savedData.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date descending
                savedData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                nightShiftData = savedData;
                populateNightHistoryTable(savedData);
            } catch (error) {
                console.error('Error loading night history data:', error);
                // Fallback to localStorage
                const localData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                nightShiftData = localData;
                populateNightHistoryTable(localData);
            }
        }

        function populateNightHistoryTable(data) {
            const tbody = document.getElementById('nightHistoryTableBody');
            const noMessage = document.getElementById('noNightHistoryMessage');
            
            if (!tbody) return;
            
            if (data.length === 0) {
                tbody.innerHTML = '';
                if (noMessage) noMessage.style.display = 'block';
                return;
            }
            
            if (noMessage) noMessage.style.display = 'none';
            
            tbody.innerHTML = data.map(record => {
                const totalSales = parseFloat(record.salesToday || 0);
                const cashReceived = parseFloat(record.cashReceived || 0);
                const tngReceived = parseFloat(record.tngReceived || 0);
                const totalReceived = parseFloat(record.totalCashReceived || 0) || (cashReceived + tngReceived);
                
                return `
                    <tr>
                        <td>${formatDate(record.date)}</td>
                        <td>üåô Night</td>
                        <td>RM ${totalSales.toFixed(2)}</td>
                        <td>RM ${cashReceived.toFixed(2)}</td>
                        <td>RM ${tngReceived.toFixed(2)}</td>
                        <td>RM ${totalReceived.toFixed(2)}</td>
                        <td class="action-buttons">
                            <button class="btn btn-primary btn-edit" onclick="editNightRecord('${record.date}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger btn-delete" onclick="deleteNightRecord('${record.date}')">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterNightHistoryTable() {
            const dateFilter = document.getElementById('nightDateFilter')?.value || '';
            const searchFilter = document.getElementById('nightSearchFilter')?.value.toLowerCase() || '';
            const tbody = document.getElementById('nightHistoryTableBody');
            
            if (!tbody) return;
            
            let filteredData = nightShiftData;
            
            // Filter by date
            if (dateFilter) {
                filteredData = filteredData.filter(record => record.date === dateFilter);
            }
            
            // Filter by search term
            if (searchFilter) {
                filteredData = filteredData.filter(record => {
                    const totalSales = parseFloat(record.salesToday || 0);
                    const cashReceived = parseFloat(record.cashReceived || 0);
                    return record.date.includes(searchFilter) ||
                           totalSales.toString().includes(searchFilter) ||
                           cashReceived.toString().includes(searchFilter);
                });
            }
            
            populateNightHistoryTable(filteredData);
        }

        function clearNightFilters() {
            document.getElementById('nightDateFilter').value = '';
            document.getElementById('nightSearchFilter').value = '';
            populateNightHistoryTable(nightShiftData);
        }

        // ============ NIGHT CASH FLOW ANALYSIS FUNCTIONS ============
        
        function generateNightCashFlow30DaysReport() {
            // Use night shift data
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 29 * 24 * 60 * 60 * 1000); // Past 30 days (including today)
            
            const days30Data = savedData.filter(entry => {
                let entryDateStr = entry.date;
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                const entryDate = new Date(entryDateNormalized);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => {
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            updateNightCashFlowTable(days30Data);
        }

        function generateNightCashFlowCustomReport() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">üîç Custom Report - Night Cash Flow</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Date:</label>
                        <input type="date" id="nightCashFlowStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Date:</label>
                        <input type="date" id="nightCashFlowEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="generateNightCashFlowFromDates()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Report</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function generateNightCashFlowFromDates() {
            const startDateInput = document.getElementById('nightCashFlowStartDate');
            const endDateInput = document.getElementById('nightCashFlowEndDate');
            
            if (!startDateInput || !endDateInput || !startDateInput.value || !endDateInput.value) {
                alert('Please select both start and end dates.');
                return;
            }
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before or equal to end date.');
                return;
            }
            
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            const customData = savedData.filter(entry => {
                let entryDateStr = entry.date;
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                return entryDateNormalized >= startDate && entryDateNormalized <= endDate;
            }).sort((a, b) => {
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            // Close the modal
            document.querySelector('div[style*="z-index: 1000"]').remove();
            
            updateNightCashFlowTable(customData);
        }

        function updateNightCashFlowTable(data) {
            const tbody = document.getElementById('nightCashFlowAnalysisTableBody');
            
            if (!tbody) {
                console.error('Night cash flow table body not found');
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                            No cash flow data available for the selected date range.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Store the data for later use (for saving)
            if (!window.nightCashFlowTableData) {
                window.nightCashFlowTableData = {};
            }
            
            // Calculate totals
            let totalCash = 0;
            let totalTNG = 0;
            let totalSales = 0;
            
            const rows = data.map((entry, index) => {
                const cash = parseFloat(entry.cashReceived || 0);
                const tng = parseFloat(entry.tngReceived || 0);
                const sales = parseFloat(entry.salesToday || 0);
                
                totalCash += cash;
                totalTNG += tng;
                totalSales += sales;
                
                // Format date using the existing formatDate helper
                const formattedDate = formatDate(entry.date);
                
                // Store entry data for saving
                const rowId = `nightCashFlowRow_${index}_${entry.date}`;
                window.nightCashFlowTableData[rowId] = entry;
                
                return `
                    <tr id="${rowId}" data-entry-date="${entry.date}" data-entry-id="${entry.id || ''}">
                        <td>${formattedDate}</td>
                        <td>
                            <input type="number" 
                                   class="night-cash-flow-input" 
                                   value="${cash.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="cashReceived"
                                   data-row-id="${rowId}"
                                   oninput="updateNightCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="night-cash-flow-input" 
                                   value="${tng.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="tngReceived"
                                   data-row-id="${rowId}"
                                   oninput="updateNightCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <span class="night-cash-flow-total-sales" data-row-id="${rowId}" style="font-weight: bold;">RM ${sales.toFixed(2)}</span>
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm" 
                                    onclick="saveNightCashFlowRow('${rowId}')" 
                                    style="padding: 5px 10px; font-size: 12px;">
                                üíæ Save
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add total row
            const totalRow = `
                <tr style="font-weight: bold; background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                    <td>Total</td>
                    <td id="nightCashFlowTotalCash">RM ${totalCash.toFixed(2)}</td>
                    <td id="nightCashFlowTotalTNG">RM ${totalTNG.toFixed(2)}</td>
                    <td id="nightCashFlowTotalSales" style="color: #27ae60;">RM ${totalSales.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;
            
            tbody.innerHTML = rows + totalRow;
        }

        function updateNightCashFlowTotals() {
            const tbody = document.getElementById('nightCashFlowAnalysisTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr[id^="nightCashFlowRow_"]');
            let totalCash = 0;
            let totalTNG = 0;
            let totalSales = 0;
            
            rows.forEach(row => {
                const cashInput = row.querySelector('input[data-field="cashReceived"]');
                const tngInput = row.querySelector('input[data-field="tngReceived"]');
                const totalSalesSpan = row.querySelector('.night-cash-flow-total-sales');
                
                const cash = parseFloat(cashInput.value) || 0;
                const tng = parseFloat(tngInput.value) || 0;
                // Calculate Total Sales as Cash + TNG for night shift
                const sales = cash + tng;
                
                // Update the total sales display for this row
                if (totalSalesSpan) {
                    totalSalesSpan.textContent = `RM ${sales.toFixed(2)}`;
                }
                
                totalCash += cash;
                totalTNG += tng;
                totalSales += sales;
            });
            
            // Update total row
            const totalCashEl = document.getElementById('nightCashFlowTotalCash');
            const totalTNGEl = document.getElementById('nightCashFlowTotalTNG');
            const totalSalesEl = document.getElementById('nightCashFlowTotalSales');
            
            if (totalCashEl) totalCashEl.textContent = `RM ${totalCash.toFixed(2)}`;
            if (totalTNGEl) totalTNGEl.textContent = `RM ${totalTNG.toFixed(2)}`;
            if (totalSalesEl) totalSalesEl.textContent = `RM ${totalSales.toFixed(2)}`;
        }

        async function saveNightCashFlowRow(rowId) {
            const row = document.getElementById(rowId);
            if (!row) {
                alert('Row not found!');
                return;
            }
            
            const entryData = window.nightCashFlowTableData[rowId];
            if (!entryData) {
                alert('Entry data not found!');
                return;
            }
            
            const cashInput = row.querySelector('input[data-field="cashReceived"]');
            const tngInput = row.querySelector('input[data-field="tngReceived"]');
            
            const cashReceived = parseFloat(cashInput.value) || 0;
            const tngReceived = parseFloat(tngInput.value) || 0;
            
            // Calculate Total Sales (same as Cash + TNG for night shift)
            const totalSales = cashReceived + tngReceived;
            
            const updatedData = {
                cashReceived: cashReceived,
                tngReceived: tngReceived,
                totalCashReceived: totalSales,
                salesToday: totalSales,
                updatedAt: new Date()
            };
            
            try {
                const { db, collection, doc, updateDoc, getDocs, query, where } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (user && entryData.id) {
                    const nightDataRef = collection(db, `users/${user.uid}/nightShiftData`);
                    const docRef = doc(nightDataRef, entryData.id);
                    await updateDoc(docRef, updatedData);
                    console.log('Night cash flow data updated in Firestore');
                }
                
                // Update localStorage
                const savedNightData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                const existingRecordIndex = savedNightData.findIndex(r => r.date === entryData.date);
                
                if (existingRecordIndex !== -1) {
                    savedNightData[existingRecordIndex] = { ...savedNightData[existingRecordIndex], ...updatedData };
                }
                localStorage.setItem('nightShiftData', JSON.stringify(savedNightData));
                
                // Update the data in memory
                const nightDataIndex = nightShiftData.findIndex(r => r.date === entryData.date);
                if (nightDataIndex !== -1) {
                    nightShiftData[nightDataIndex] = { ...nightShiftData[nightDataIndex], ...updatedData };
                }
                
                // Update the total sales display
                const totalSalesSpan = row.querySelector('.night-cash-flow-total-sales');
                if (totalSalesSpan) {
                    totalSalesSpan.textContent = `RM ${totalSales.toFixed(2)}`;
                }
                
                // Update totals
                updateNightCashFlowTotals();
                
                // Refresh history table if it exists
                if (typeof refreshNightHistoryTable === 'function') {
                    await refreshNightHistoryTable();
                }
                
                // Show success feedback
                const saveButton = row.querySelector('button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '‚úÖ Saved';
                saveButton.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.backgroundColor = '';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving night cash flow data:', error);
                alert('Error saving data. Please try again.');
            }
        }

        function exportNightCashFlowToExcel() {
            const tbody = document.getElementById('nightCashFlowAnalysisTableBody');
            if (!tbody) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            const rows = tbody.querySelectorAll('tr[id^="nightCashFlowRow_"]');
            if (rows.length === 0) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            // CSV header
            let csvContent = '\uFEFF'; // BOM for UTF-8 (Excel compatibility)
            csvContent += 'Date,Cash Received,TNG Received,Total Sales\n';
            
            // Get data from table rows
            rows.forEach(row => {
                const dateCell = row.querySelector('td:first-child').textContent.trim();
                const cashInput = row.querySelector('input[data-field="cashReceived"]');
                const tngInput = row.querySelector('input[data-field="tngReceived"]');
                const totalSalesSpan = row.querySelector('.night-cash-flow-total-sales');
                
                const cash = cashInput ? parseFloat(cashInput.value) || 0 : 0;
                const tng = tngInput ? parseFloat(tngInput.value) || 0 : 0;
                const totalSales = totalSalesSpan ? parseFloat(totalSalesSpan.textContent.replace('RM', '').replace(/,/g, '').trim()) || 0 : 0;
                
                csvContent += `${dateCell},${cash.toFixed(2)},${tng.toFixed(2)},${totalSales.toFixed(2)}\n`;
            });
            
            // Add total row
            const totalRow = tbody.querySelector('tr:last-child');
            if (totalRow && totalRow.textContent.includes('Total')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 4) {
                    csvContent += `Total,${totalCells[1].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[2].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[3].textContent.replace('RM', '').replace(/,/g, '').trim()}\n`;
                }
            }
            
            // Create filename with current date
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const filename = `Night_Cash_Flow_Analysis_${dateStr}.csv`;
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert('Night Cash Flow Analysis data exported successfully!');
        }

        // ============ NIGHT SALE SUMMARY REPORTS FUNCTIONS ============
        
        function generateNightSaleSummary30DaysReport() {
            // Use night shift data
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 29 * 24 * 60 * 60 * 1000); // Past 30 days (including today)
            
            const days30Data = savedData.filter(entry => {
                let entryDateStr = entry.date;
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                const entryDate = new Date(entryDateNormalized);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => {
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            updateNightSaleSummaryTable(days30Data);
        }

        function generateNightSaleSummaryCustomReport() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">üîç Custom Report - Night Sale Summary</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Date:</label>
                        <input type="date" id="nightSaleSummaryStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Date:</label>
                        <input type="date" id="nightSaleSummaryEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="generateNightSaleSummaryFromDates()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Report</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function generateNightSaleSummaryFromDates() {
            const startDateInput = document.getElementById('nightSaleSummaryStartDate');
            const endDateInput = document.getElementById('nightSaleSummaryEndDate');
            
            if (!startDateInput || !endDateInput || !startDateInput.value || !endDateInput.value) {
                alert('Please select both start and end dates.');
                return;
            }
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before or equal to end date.');
                return;
            }
            
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            const customData = savedData.filter(entry => {
                let entryDateStr = entry.date;
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                return entryDateNormalized >= startDate && entryDateNormalized <= endDate;
            }).sort((a, b) => {
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            // Close the modal
            document.querySelector('div[style*="z-index: 1000"]').remove();
            
            updateNightSaleSummaryTable(customData);
        }

        function updateNightSaleSummaryTable(data) {
            const tbody = document.getElementById('nightSaleSummaryTableBody');
            
            if (!tbody) {
                console.error('Night sale summary table body not found');
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                            No sale summary data available for the selected date range.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Store the data for later use (for saving)
            if (!window.nightSaleSummaryTableData) {
                window.nightSaleSummaryTableData = {};
            }
            
            // Calculate totals
            let totalBeerSales = 0;
            let totalCoffeeSales = 0;
            let totalSales = 0;
            
            const rows = data.map((entry, index) => {
                const beerSales = parseFloat(entry.beerSales || 0);
                const coffeeSales = parseFloat(entry.coffeeSales || 0);
                // Total Sales = Beer Sales + Coffee Sales for night shift
                const totalSale = beerSales + coffeeSales;
                
                totalBeerSales += beerSales;
                totalCoffeeSales += coffeeSales;
                totalSales += totalSale;
                
                // Format date using the existing formatDate helper
                const formattedDate = formatDate(entry.date);
                
                // Store entry data for saving
                const rowId = `nightSaleSummaryRow_${index}_${entry.date}`;
                window.nightSaleSummaryTableData[rowId] = entry;
                
                return `
                    <tr id="${rowId}" data-entry-date="${entry.date}" data-entry-id="${entry.id || ''}">
                        <td>${formattedDate}</td>
                        <td>
                            <input type="number" 
                                   class="night-sale-summary-input" 
                                   value="${beerSales.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="beerSales"
                                   data-row-id="${rowId}"
                                   oninput="updateNightSaleSummaryTotals('${rowId}')"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="night-sale-summary-input" 
                                   value="${coffeeSales.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="coffeeSales"
                                   data-row-id="${rowId}"
                                   oninput="updateNightSaleSummaryTotals('${rowId}')"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <span class="night-sale-total-display" data-row-id="${rowId}" style="font-weight: bold;">RM ${totalSale.toFixed(2)}</span>
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm" 
                                    onclick="saveNightSaleSummaryRow('${rowId}')" 
                                    style="padding: 5px 10px; font-size: 12px;">
                                üíæ Save
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add total row
            const totalRow = `
                <tr style="font-weight: bold; background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                    <td>Total</td>
                    <td id="nightSaleSummaryTotalBeer">RM ${totalBeerSales.toFixed(2)}</td>
                    <td id="nightSaleSummaryTotalCoffee">RM ${totalCoffeeSales.toFixed(2)}</td>
                    <td id="nightSaleSummaryTotalSales" style="color: #27ae60;">RM ${totalSales.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;
            
            tbody.innerHTML = rows + totalRow;
        }

        function updateNightSaleSummaryTotals(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const beerInput = row.querySelector('input[data-field="beerSales"]');
            const coffeeInput = row.querySelector('input[data-field="coffeeSales"]');
            
            const beerSales = parseFloat(beerInput.value) || 0;
            const coffeeSales = parseFloat(coffeeInput.value) || 0;
            const totalSale = beerSales + coffeeSales;
            
            // Update the total display for this row
            const totalDisplay = row.querySelector('.night-sale-total-display');
            if (totalDisplay) {
                totalDisplay.textContent = `RM ${totalSale.toFixed(2)}`;
            }
            
            // Update overall totals
            const tbody = document.getElementById('nightSaleSummaryTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr[id^="nightSaleSummaryRow_"]');
            let totalBeerSales = 0;
            let totalCoffeeSales = 0;
            let totalSales = 0;
            
            rows.forEach(r => {
                const beerInput = r.querySelector('input[data-field="beerSales"]');
                const coffeeInput = r.querySelector('input[data-field="coffeeSales"]');
                
                const beer = parseFloat(beerInput.value) || 0;
                const coffee = parseFloat(coffeeInput.value) || 0;
                const total = beer + coffee;
                
                totalBeerSales += beer;
                totalCoffeeSales += coffee;
                totalSales += total;
            });
            
            // Update total row
            const totalBeerEl = document.getElementById('nightSaleSummaryTotalBeer');
            const totalCoffeeEl = document.getElementById('nightSaleSummaryTotalCoffee');
            const totalSalesEl = document.getElementById('nightSaleSummaryTotalSales');
            
            if (totalBeerEl) totalBeerEl.textContent = `RM ${totalBeerSales.toFixed(2)}`;
            if (totalCoffeeEl) totalCoffeeEl.textContent = `RM ${totalCoffeeSales.toFixed(2)}`;
            if (totalSalesEl) totalSalesEl.textContent = `RM ${totalSales.toFixed(2)}`;
        }

        async function saveNightSaleSummaryRow(rowId) {
            const row = document.getElementById(rowId);
            if (!row) {
                alert('Row not found!');
                return;
            }
            
            const entryData = window.nightSaleSummaryTableData[rowId];
            if (!entryData) {
                alert('Entry data not found!');
                return;
            }
            
            const beerInput = row.querySelector('input[data-field="beerSales"]');
            const coffeeInput = row.querySelector('input[data-field="coffeeSales"]');
            
            const beerSales = parseFloat(beerInput.value) || 0;
            const coffeeSales = parseFloat(coffeeInput.value) || 0;
            const totalSales = beerSales + coffeeSales;
            
            const updatedData = {
                beerSales: beerSales,
                coffeeSales: coffeeSales,
                salesToday: totalSales,
                updatedAt: new Date()
            };
            
            try {
                const { db, collection, doc, updateDoc } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;
                
                if (user && entryData.id) {
                    const nightDataRef = collection(db, `users/${user.uid}/nightShiftData`);
                    const docRef = doc(nightDataRef, entryData.id);
                    await updateDoc(docRef, updatedData);
                    console.log('Night sale summary data updated in Firestore');
                }
                
                // Update localStorage
                const savedNightData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                const existingRecordIndex = savedNightData.findIndex(r => r.date === entryData.date);
                
                if (existingRecordIndex !== -1) {
                    savedNightData[existingRecordIndex] = { ...savedNightData[existingRecordIndex], ...updatedData };
                }
                localStorage.setItem('nightShiftData', JSON.stringify(savedNightData));
                
                // Update the data in memory
                const nightDataIndex = nightShiftData.findIndex(r => r.date === entryData.date);
                if (nightDataIndex !== -1) {
                    nightShiftData[nightDataIndex] = { ...nightShiftData[nightDataIndex], ...updatedData };
                }
                
                // Update totals
                updateNightSaleSummaryTotals(rowId);
                
                // Refresh history table if it exists
                if (typeof refreshNightHistoryTable === 'function') {
                    await refreshNightHistoryTable();
                }
                
                // Show success feedback
                const saveButton = row.querySelector('button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '‚úÖ Saved';
                saveButton.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.backgroundColor = '';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving night sale summary data:', error);
                alert('Error saving data. Please try again.');
            }
        }

        function exportNightSaleSummaryToExcel() {
            const tbody = document.getElementById('nightSaleSummaryTableBody');
            if (!tbody) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            const rows = tbody.querySelectorAll('tr[id^="nightSaleSummaryRow_"]');
            if (rows.length === 0) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            // CSV header
            let csvContent = '\uFEFF'; // BOM for UTF-8 (Excel compatibility)
            csvContent += 'Date,Beer Sales,Coffee Sales,Total Sales\n';
            
            // Get data from table rows
            rows.forEach(row => {
                const dateCell = row.querySelector('td:first-child').textContent.trim();
                const beerInput = row.querySelector('input[data-field="beerSales"]');
                const coffeeInput = row.querySelector('input[data-field="coffeeSales"]');
                const totalSalesSpan = row.querySelector('.night-sale-total-display');
                
                const beerSales = beerInput ? parseFloat(beerInput.value) || 0 : 0;
                const coffeeSales = coffeeInput ? parseFloat(coffeeInput.value) || 0 : 0;
                const totalSales = totalSalesSpan ? parseFloat(totalSalesSpan.textContent.replace('RM', '').replace(/,/g, '').trim()) || 0 : 0;
                
                csvContent += `${dateCell},${beerSales.toFixed(2)},${coffeeSales.toFixed(2)},${totalSales.toFixed(2)}\n`;
            });
            
            // Add total row
            const totalRow = tbody.querySelector('tr:last-child');
            if (totalRow && totalRow.textContent.includes('Total')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 4) {
                    csvContent += `Total,${totalCells[1].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[2].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[3].textContent.replace('RM', '').replace(/,/g, '').trim()}\n`;
                }
            }
            
            // Create filename with current date
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const filename = `Night_Sale_Summary_${dateStr}.csv`;
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert('Night Sale Summary data exported successfully!');
        }

        function editNightRecord(date) {
            // Search in night shift data
            const record = nightShiftData.find(r => r.date === date);
            
            if (!record) {
                alert('Record not found!');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'edit-modal';
            modal.innerHTML = `
                <div class="edit-modal-content">
                    <h2>‚úèÔ∏è Edit Night Record - ${formatDate(date)}</h2>
                    <div class="edit-form-group">
                        <label>Cigarette Sales:</label>
                        <input type="number" id="editNightCigaretteSales" value="${record.cigaretteSales || 0}" step="0.01">
                    </div>
                    <div class="edit-form-group">
                        <label>Coffee Sales:</label>
                        <input type="number" id="editNightCoffeeSales" value="${record.coffeeSales || 0}" step="0.01">
                    </div>
                    <div class="edit-form-group">
                        <label>Beer Sales:</label>
                        <input type="number" id="editNightBeerSales" value="${record.beerSales || 0}" step="0.01">
                    </div>
                    <div class="edit-form-group">
                        <label>Cash Received:</label>
                        <input type="number" id="editNightCashReceived" value="${record.cashReceived || 0}" step="0.01">
                    </div>
                    <div class="edit-form-group">
                        <label>TNG Received:</label>
                        <input type="number" id="editNightTngReceived" value="${record.tngReceived || 0}" step="0.01">
                    </div>
                    <div class="edit-modal-buttons">
                        <button class="btn btn-success" onclick="saveEditedNightRecord('${date}')">üíæ Save Changes</button>
                        <button class="btn btn-secondary" onclick="this.closest('.edit-modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function saveEditedNightRecord(date) {
            // Find the record in night shift data
            const record = nightShiftData.find(r => r.date === date);
            
            if (!record) {
                alert('Record not found!');
                return;
            }

            // Get edited values
            const editedRecord = {
                date: date,
                shift: 'night',
                cigaretteSales: parseFloat(document.getElementById('editNightCigaretteSales').value) || 0,
                coffeeSales: parseFloat(document.getElementById('editNightCoffeeSales').value) || 0,
                beerSales: parseFloat(document.getElementById('editNightBeerSales').value) || 0,
                cashReceived: parseFloat(document.getElementById('editNightCashReceived').value) || 0,
                tngReceived: parseFloat(document.getElementById('editNightTngReceived').value) || 0,
                grabReceived: 0, // Removed from UI
                shopeeReceived: 0, // Removed from UI
                updatedAt: new Date()
            };

            // Calculate totals
            editedRecord.salesToday = editedRecord.cigaretteSales + editedRecord.coffeeSales + editedRecord.beerSales;
            editedRecord.totalCashReceived = editedRecord.cashReceived + editedRecord.tngReceived;

            try {
                const { db, collection, doc, updateDoc, getDocs, query, where } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;

                if (!user) {
                    alert('Please login to save data');
                    return;
                }

                // Update in Firestore
                const nightDataRef = collection(db, `users/${user.uid}/nightShiftData`);
                const q = query(nightDataRef, where('date', '==', date));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const docToUpdate = querySnapshot.docs[0];
                    await updateDoc(docToUpdate.ref, editedRecord);
                    console.log('Night record updated in Firestore');
                } else {
                    alert('Record not found in database!');
                    return;
                }
                
                // Also update localStorage
                const savedNightData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                const existingRecordIndex = savedNightData.findIndex(r => r.date === date);
                
                if (existingRecordIndex !== -1) {
                    savedNightData[existingRecordIndex] = { ...savedNightData[existingRecordIndex], ...editedRecord };
                }
                localStorage.setItem('nightShiftData', JSON.stringify(savedNightData));
                
                // Close modal and refresh table
                document.querySelector('.edit-modal').remove();
                await refreshNightHistoryTable();
                
                alert('Night record updated successfully!');
            } catch (error) {
                console.error('Error updating night record:', error);
                alert('Error updating record. Please try again.');
            }
        }

        async function deleteNightRecord(date) {
            if (!confirm(`Are you sure you want to delete the night shift record for ${formatDate(date)}? This action cannot be undone!`)) {
                return;
            }

            try {
                // Find the record in night shift data
                const record = nightShiftData.find(r => r.date === date);
                
                if (!record) {
                    alert('Record not found!');
                    return;
                }
                
                const { db, collection, doc, deleteDoc, getDocs, query, where } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;

                if (user && record.id) {
                    // Delete from Firestore
                    const nightDataRef = collection(db, `users/${user.uid}/nightShiftData`);
                    const docRef = doc(nightDataRef, record.id);
                    await deleteDoc(docRef);
                    console.log('Night record deleted from Firestore');
                }
                
                // Also delete from localStorage
                const savedNightData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                const filteredData = savedNightData.filter(r => r.date !== date);
                localStorage.setItem('nightShiftData', JSON.stringify(filteredData));
                
                // Refresh table
                await refreshNightHistoryTable();
                
                alert('Night record deleted successfully!');
            } catch (error) {
                console.error('Error deleting night record:', error);
                alert('Error deleting record. Please try again.');
            }
        }

        function exportNightHistoryData() {
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            if (savedData.length === 0) {
                alert('No night shift data to export!');
                return;
            }

            // Create CSV content
            let csvContent = 'Date,Shift,Total Sales,Cigarette Sales,Coffee Sales,Beer Sales,Cash Received,TNG Received,Total Received\n';
            
            savedData.forEach(record => {
                const totalSales = parseFloat(record.salesToday || 0);
                const cashReceived = parseFloat(record.cashReceived || 0);
                const tngReceived = parseFloat(record.tngReceived || 0);
                const totalReceived = parseFloat(record.totalCashReceived || 0) || (cashReceived + tngReceived);
                
                csvContent += `${record.date},Night,${totalSales.toFixed(2)},${parseFloat(record.cigaretteSales || 0).toFixed(2)},${parseFloat(record.coffeeSales || 0).toFixed(2)},${parseFloat(record.beerSales || 0).toFixed(2)},${cashReceived.toFixed(2)},${tngReceived.toFixed(2)},${totalReceived.toFixed(2)}\n`;
            });

            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `night_shift_history_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Night shift history data exported successfully!');
        }
        // ============ END NIGHT SHIFT HISTORY FUNCTIONS ============

        // Navigation Functions
        function toggleMobileMenu() {
            const navbarNav = document.getElementById('navbarNav');
            navbarNav.classList.toggle('active');
        }

        function setActiveNavLink(clickedLink) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            // Add active class to clicked link
            clickedLink.classList.add('active');
        }

        function showMainPage(event) {
            setActiveNavLink(event.target);
            // Hide all other sections and show main dashboard
            hideAllSections();
            document.querySelector('.container').style.display = 'block';
        }

        function showReports(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showReportsSection();
        }

        function showNightReports(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showNightReportsSection();
        }

        function showExpenseSettings(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showExpenseSettingsSection();
        }

        function showSalarySettings(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showSalarySettingsSection();
        }

        function showBankExpenseSettings(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showBankExpenseSettingsSection();
        }

        function showProductSettings(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showProductSettingsSection();
        }

        function showRentalSettings(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showRentalSettingsSection();
        }

        function showDataManagement(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showDataManagementSection();
        }

        function showHelp(event) {
            setActiveNavLink(event.target);
            hideAllSections();
            showHelpSection();
        }

        function hideAllSections() {
            // Hide main container
            document.querySelector('.container').style.display = 'none';
            
            // Hide night section container
            const nightSection = document.getElementById('nightSectionContainer');
            if (nightSection) {
                nightSection.style.display = 'none';
            }
            
            // Remove any existing backend sections
            const existingSections = document.querySelectorAll('.backend-section');
            existingSections.forEach(section => section.remove());
        }

        function showNightSection(event) {
            if (event) setActiveNavLink(event.target);
            hideAllSections();
            
            // Show night section container
            const nightSection = document.getElementById('nightSectionContainer');
            if (nightSection) {
                nightSection.style.display = 'block';
                
                // Set today's date
                document.getElementById('nightDateInput').value = new Date().toISOString().split('T')[0];
                
                // Setup event listeners for night section
                setupNightSectionListeners();
                
                // Update cigarette table with current products
                updateNightCigaretteTable();
                
                // Initialize calculations
                calculateNightCashReceived();
                
                // Load night shift history table
                refreshNightHistoryTable();
            }
        }

        function setupNightSectionListeners() {
            // Cigarette sales listeners
            document.querySelectorAll('.cigarette-qty-night').forEach(input => {
                input.addEventListener('input', calculateNightCigaretteSales);
            });

            // Beer sales listeners
            document.querySelectorAll('.beer-price-night, .beer-bottles-night').forEach(input => {
                input.addEventListener('input', calculateNightBeerSales);
            });
        }

        function updateNightCigaretteTable() {
            const cigaretteTable = document.querySelector('.cigarette-table-night tbody');
            if (!cigaretteTable) return;

            // Update headers
            const headerRow = document.querySelector('.cigarette-table-night thead tr');
            headerRow.innerHTML = '<th></th>';
            cigaretteProducts.forEach(product => {
                headerRow.innerHTML += `<th>${product.name}</th>`;
            });

            // Update rows
            cigaretteTable.innerHTML = `
                <tr>
                    <td><strong>Default Price</strong></td>
                    ${cigaretteProducts.map(product => 
                        `<td><input type="number" value="${product.price}" readonly></td>`
                    ).join('')}
                </tr>
                <tr>
                    <td><strong>Sales of packs</strong></td>
                    ${cigaretteProducts.map(product => 
                        `<td><input type="number" class="cigarette-qty-night" data-price="${product.price}" placeholder="0"></td>`
                    ).join('')}
                </tr>
                <tr class="total-row">
                    <td><strong>Total:</strong></td>
                    <td colspan="${cigaretteProducts.length}"><input type="number" id="cigaretteTotalNight" readonly placeholder="0.00"></td>
                </tr>
            `;

            // Re-attach event listeners
            document.querySelectorAll('.cigarette-qty-night').forEach(input => {
                input.addEventListener('input', calculateNightCigaretteSales);
            });
        }

        function calculateNightCigaretteSales() {
            let total = 0;
            document.querySelectorAll('.cigarette-qty-night').forEach(input => {
                const qty = parseFloat(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                total += qty * price;
            });
            document.getElementById('cigaretteTotalNight').value = total.toFixed(2);
            document.getElementById('nightSummaryCigaretteSales').textContent = total.toFixed(2);
            calculateNightSalesToday();
        }

        function calculateNightBeerSales() {
            const priceInputs = document.querySelectorAll('.beer-price-night');
            const bottleInputs = document.querySelectorAll('.beer-bottles-night');
            const totalInputs = document.querySelectorAll('.beer-total-night');
            
            let grandTotal = 0;
            
            priceInputs.forEach((priceInput, index) => {
                const price = parseFloat(priceInput.value) || 0;
                const bottles = parseFloat(bottleInputs[index].value) || 0;
                const total = price * bottles;
                
                totalInputs[index].value = total.toFixed(2);
                grandTotal += total;
            });
            
            document.getElementById('beerTotalNight').value = grandTotal.toFixed(2);
            document.getElementById('nightSummaryBeerSales').textContent = grandTotal.toFixed(2);
            calculateNightSalesToday();
        }

        function calculateNightCashReceived() {
            const cash = parseFloat(document.getElementById('nightCashReceived').value) || 0;
            const tng = parseFloat(document.getElementById('nightTngReceived').value) || 0;
            
            const total = cash + tng;
            document.getElementById('nightTotalCashReceived').textContent = total.toFixed(2);
            
            // Sales Today = Cash Received + TNG Received
            const salesToday = cash + tng;
            document.getElementById('nightSalesToday').textContent = salesToday.toFixed(2);
            
            // After Sales Today is updated, calculate Coffee Sales
            calculateNightSalesToday();
        }

        function calculateNightSalesToday() {
            // Get Sales Today (calculated from Cash + TNG)
            const salesToday = parseFloat(document.getElementById('nightSalesToday').textContent) || 0;
            const cigaretteSales = parseFloat(document.getElementById('cigaretteTotalNight').value) || 0;
            const beerSales = parseFloat(document.getElementById('beerTotalNight').value) || 0;
            
            // Coffee Sales = Sales Today - Cigarette Sales - Beer Sales
            const coffeeSales = Math.max(0, salesToday - cigaretteSales - beerSales);
            document.getElementById('nightCoffeeSales').value = coffeeSales.toFixed(2);
        }

        function getNightCigaretteData() {
            const cigarettes = [];
            const qtyInputs = document.querySelectorAll('.cigarette-qty-night');
            qtyInputs.forEach((input, index) => {
                const qty = parseFloat(input.value) || 0;
                if (qty > 0 && cigaretteProducts[index]) {
                    cigarettes.push({
                        name: cigaretteProducts[index].name,
                        price: cigaretteProducts[index].price,
                        quantity: qty,
                        total: qty * cigaretteProducts[index].price
                    });
                }
            });
            return cigarettes;
        }

        async function saveNightData() {
            const data = {
                date: document.getElementById('nightDateInput').value,
                shift: 'night', // Marker to identify night shift data
                cigaretteSales: document.getElementById('cigaretteTotalNight').value,
                cigaretteDetails: getNightCigaretteData(),
                beerSales: document.getElementById('beerTotalNight').value,
                coffeeSales: document.getElementById('nightCoffeeSales').value,
                cashReceived: document.getElementById('nightCashReceived').value,
                tngReceived: document.getElementById('nightTngReceived').value,
                grabReceived: 0, // Removed from UI
                shopeeReceived: 0, // Removed from UI
                totalCashReceived: document.getElementById('nightTotalCashReceived').textContent,
                salesToday: document.getElementById('nightSalesToday').textContent,
                // Add device and sync information
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenResolution: `${screen.width}x${screen.height}`,
                    timestamp: new Date().toISOString(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                syncInfo: {
                    lastModified: new Date(),
                    version: '1.0',
                    source: 'web-app-night-section'
                }
            };
            
            console.log('Night data to save:', data);
            
            try {
                // Save to Firestore with collection name indicating night shift
                const NIGHT_COLLECTION = 'nightShiftData';
                const { db, collection, addDoc, doc, updateDoc, getDocs, query, where } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;

                if (!user) {
                    alert('Please login to save data');
                    return;
                }

                // Check if a record for this date already exists
                const nightDataRef = collection(db, `users/${user.uid}/${NIGHT_COLLECTION}`);
                const q = query(nightDataRef, where('date', '==', data.date));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // Update existing record
                    const docToUpdate = querySnapshot.docs[0];
                    const updateData = {
                        ...data,
                        updatedAt: new Date().toISOString(),
                        syncInfo: {
                            ...data.syncInfo,
                            lastModified: new Date(),
                            version: '1.0',
                            source: 'web-app-night-section'
                        }
                    };
                    await updateDoc(docToUpdate.ref, updateData);
                    console.log('Night record updated in Firestore:', data.date);
                } else {
                    // Add new record with createdAt timestamp
                    const newRecord = {
                        ...data,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    await addDoc(nightDataRef, newRecord);
                    console.log('New night record saved to Firestore:', data.date);
                }
                
                // Also save to localStorage as backup
                const savedNightData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                const existingRecordIndex = savedNightData.findIndex(record => record.date === data.date);
                
                // Ensure data includes timestamps for localStorage
                // Preserve createdAt if updating, add new if creating
                const isNewRecord = querySnapshot.empty && existingRecordIndex === -1;
                const dataWithTimestamps = {
                    ...data,
                    createdAt: isNewRecord ? new Date().toISOString() : (savedNightData[existingRecordIndex]?.createdAt || new Date().toISOString()),
                    updatedAt: new Date().toISOString()
                };
                
                if (existingRecordIndex !== -1) {
                    savedNightData[existingRecordIndex] = dataWithTimestamps;
                } else {
                    savedNightData.push(dataWithTimestamps);
                }
                
                localStorage.setItem('nightShiftData', JSON.stringify(savedNightData));
                
                // Show success message
                const deviceType = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
                alert(`‚úÖ Night data saved successfully to Firestore!\nüì± Device: ${deviceType}\nüåô Shift: Night\nüåê Data synced in real-time - visible on all devices logged in to this account\nüíæ Date: ${data.date}`);
                
                // Refresh history table
                await refreshNightHistoryTable();
                
            } catch (error) {
                console.error('Error saving night data to Firestore:', error);
                
                // Fallback to localStorage only
                const savedNightData = JSON.parse(localStorage.getItem('nightShiftData')) || [];
                const existingRecordIndex = savedNightData.findIndex(record => record.date === data.date);
                
                if (existingRecordIndex !== -1) {
                    savedNightData[existingRecordIndex] = data;
                } else {
                    savedNightData.push(data);
                }
                
                localStorage.setItem('nightShiftData', JSON.stringify(savedNightData));
                
                alert(`‚ö†Ô∏è Night data saved locally only (Firestore unavailable).\nüì± Your data is safe in browser storage.\nüîó Please check your internet connection.\nüìä Data will sync to Firestore when connection is restored.`);
                
                // Refresh history table
                await refreshNightHistoryTable();
            }
        }

        // ============ CSV IMPORT/EXPORT FUNCTIONS FOR NIGHT SECTION ============
        
        function downloadNightCsvSample() {
            // Create sample CSV with headers and example data
            const headers = [
                'Date',
                'Cash Received',
                'TNG Received',
                'LD Packs',
                'Rothman & Chest Packs',
                'Terrar Packs',
                'Peter Packs',
                'Wiston Packs',
                'Dunhill Packs',
                'Mevius Packs',
                'Marbolo Packs',
                'Carlsberg Price',
                'Carlsberg Bottles',
                'Tiger Price',
                'Tiger Bottles',
                'Guinness Price',
                'Guinness Bottles'
            ];
            
            // Get current cigarette products to match the actual headers
            const cigaretteHeaders = ['Date', 'Cash Received', 'TNG Received'];
            cigaretteProducts.forEach(product => {
                cigaretteHeaders.push(`${product.name} Packs`);
            });
            cigaretteHeaders.push('Carlsberg Price', 'Carlsberg Bottles', 'Tiger Price', 'Tiger Bottles', 'Guinness Price', 'Guinness Bottles');
            
            // Create sample row with today's date
            const today = new Date().toISOString().split('T')[0];
            const sampleRow = [
                today,
                '100.00',  // Cash Received
                '50.00'    // TNG Received
            ];
            
            // Add sample quantities for each cigarette product
            cigaretteProducts.forEach(product => {
                sampleRow.push('5'); // Sample quantity for each product
            });
            
            // Add beer data
            sampleRow.push(
                '8.00',    // Carlsberg Price
                '10',      // Carlsberg Bottles
                '7.50',    // Tiger Price
                '5',       // Tiger Bottles
                '9.00',    // Guinness Price
                '3'        // Guinness Bottles
            );
            
            // Build CSV content
            let csvContent = cigaretteHeaders.join(',') + '\n';
            csvContent += sampleRow.join(',');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `night_shift_sample_${today}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Sample CSV file downloaded! Please fill in the values and import it.');
        }

        async function handleNightCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset file input
            event.target.value = '';
            
            try {
                const text = await file.text();
                // Handle different line endings (Windows \r\n, Unix \n, Mac \r)
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                
                if (lines.length < 2) {
                    alert('‚ùå Invalid CSV file! File must contain at least a header row and one data row.');
                    return;
                }
                
                // Simple CSV parsing function (handles quoted values)
                function parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                }
                
                // Parse header row
                const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g, ''));
                
                // Find column indices
                const dateIndex = headers.findIndex(h => h.toLowerCase().includes('date'));
                const cashIndex = headers.findIndex(h => h.toLowerCase().includes('cash received'));
                const tngIndex = headers.findIndex(h => h.toLowerCase().includes('tng received'));
                
                if (dateIndex === -1 || cashIndex === -1 || tngIndex === -1) {
                    alert('‚ùå Invalid CSV format! Missing required columns: Date, Cash Received, TNG Received');
                    return;
                }
                
                // Find cigarette columns
                const cigaretteColumns = [];
                cigaretteProducts.forEach((product, index) => {
                    const colIndex = headers.findIndex(h => 
                        h.toLowerCase().includes(product.name.toLowerCase()) && 
                        h.toLowerCase().includes('pack')
                    );
                    cigaretteColumns.push({ index, colIndex, name: product.name });
                });
                
                // Find beer columns
                const beerColumns = {
                    carlsbergPrice: headers.findIndex(h => h.toLowerCase().includes('carlsberg') && h.toLowerCase().includes('price')),
                    carlsbergBottles: headers.findIndex(h => h.toLowerCase().includes('carlsberg') && h.toLowerCase().includes('bottle')),
                    tigerPrice: headers.findIndex(h => h.toLowerCase().includes('tiger') && h.toLowerCase().includes('price') && !h.toLowerCase().includes('carlsberg')),
                    tigerBottles: headers.findIndex(h => h.toLowerCase().includes('tiger') && h.toLowerCase().includes('bottle') && !h.toLowerCase().includes('carlsberg')),
                    guinnessPrice: headers.findIndex(h => h.toLowerCase().includes('guinness') && h.toLowerCase().includes('price')),
                    guinnessBottles: headers.findIndex(h => h.toLowerCase().includes('guinness') && h.toLowerCase().includes('bottle'))
                };
                
                // Parse data rows (process only first data row for single import)
                const dataRow = parseCSVLine(lines[1]).map(cell => cell.replace(/^"|"$/g, '').trim());
                
                // Extract date
                const date = dataRow[dateIndex];
                if (!date || date === '') {
                    alert('‚ùå Invalid date in CSV file!');
                    return;
                }
                
                // Extract cash and TNG
                const cashReceived = parseFloat(dataRow[cashIndex]) || 0;
                const tngReceived = parseFloat(dataRow[tngIndex]) || 0;
                
                // Extract cigarette quantities
                cigaretteColumns.forEach(col => {
                    if (col.colIndex !== -1) {
                        const qty = parseFloat(dataRow[col.colIndex]) || 0;
                        const input = document.querySelectorAll('.cigarette-qty-night')[col.index];
                        if (input) {
                            input.value = qty;
                        }
                    }
                });
                
                // Extract beer data (beers are in fixed order: Carlsberg, Tiger, Guinness)
                const beerPriceInputs = document.querySelectorAll('.beer-price-night');
                const beerBottlesInputs = document.querySelectorAll('.beer-bottles-night');
                
                if (beerColumns.carlsbergPrice !== -1 && beerColumns.carlsbergBottles !== -1 && beerPriceInputs[0] && beerBottlesInputs[0]) {
                    const price = parseFloat(dataRow[beerColumns.carlsbergPrice]) || 0;
                    const bottles = parseFloat(dataRow[beerColumns.carlsbergBottles]) || 0;
                    beerPriceInputs[0].value = price;
                    beerBottlesInputs[0].value = bottles;
                }
                
                if (beerColumns.tigerPrice !== -1 && beerColumns.tigerBottles !== -1 && beerPriceInputs[1] && beerBottlesInputs[1]) {
                    const price = parseFloat(dataRow[beerColumns.tigerPrice]) || 0;
                    const bottles = parseFloat(dataRow[beerColumns.tigerBottles]) || 0;
                    beerPriceInputs[1].value = price;
                    beerBottlesInputs[1].value = bottles;
                }
                
                if (beerColumns.guinnessPrice !== -1 && beerColumns.guinnessBottles !== -1 && beerPriceInputs[2] && beerBottlesInputs[2]) {
                    const price = parseFloat(dataRow[beerColumns.guinnessPrice]) || 0;
                    const bottles = parseFloat(dataRow[beerColumns.guinnessBottles]) || 0;
                    beerPriceInputs[2].value = price;
                    beerBottlesInputs[2].value = bottles;
                }
                
                // Set date
                document.getElementById('nightDateInput').value = date;
                
                // Set cash and TNG received
                document.getElementById('nightCashReceived').value = cashReceived.toFixed(2);
                document.getElementById('nightTngReceived').value = tngReceived.toFixed(2);
                
                // Trigger calculations
                calculateNightCigaretteSales();
                calculateNightBeerSales();
                calculateNightCashReceived();
                
                alert(`‚úÖ CSV file imported successfully!\nüìÖ Date: ${date}\nüí∞ Cash: RM ${cashReceived.toFixed(2)}\nüí≥ TNG: RM ${tngReceived.toFixed(2)}\n\nPlease review the data and click "Save Night Data" to save.`);
                
            } catch (error) {
                console.error('Error importing CSV:', error);
                alert('‚ùå Error importing CSV file! Please check the file format and try again.\n\nError: ' + error.message);
            }
        }
        // ============ END CSV IMPORT/EXPORT FUNCTIONS ============

        function createBackendSection(title, content) {
            const section = document.createElement('div');
            section.className = 'backend-section';
            section.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>${title}</h1>
                        <p>Backend Management Interface</p>
                    </div>
                    <div class="main-content" style="grid-template-columns: 1fr; padding: 20px;">
                        ${content}
                    </div>
                    <div class="buttons" style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="showMainPage()">‚Üê Back to Daily Record</button>
                    </div>
                </div>
            `;
            document.body.appendChild(section);
        }

        function showExpenseSettingsSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üí∞ Expense Template Management</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Add New Expense Template</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="newExpenseTemplate" placeholder="Enter expense name" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="addExpenseTemplateFromSettings()" class="btn btn-success">Add Template</button>
                            </div>
                        </div>
                        <div>
                            <h3>Current Expense Templates</h3>
                            <div id="expenseTemplatesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Expense Settings', content);
            updateExpenseTemplatesList();
        }

        function showSalarySettingsSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üë• Salary Name Management</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Add New Salary Name</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="newSalaryTemplate" placeholder="Enter salary name" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="addSalaryTemplateFromSettings()" class="btn btn-success">Add Salary Name</button>
                            </div>
                        </div>
                        <div>
                                <h3>Current Salary Names</h3>
                            <div id="salaryTemplatesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Salary Names', content);
            updateSalaryTemplatesList();
        }

        function showBankExpenseSettingsSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üè¶ Bank Expense Template Management</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Add New Bank Expense Template</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="newBankExpenseTemplate" placeholder="Enter bank expense name" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="addBankExpenseTemplateFromSettings()" class="btn btn-success">Add Template</button>
                            </div>
                        </div>
                        <div>
                            <h3>Current Bank Expense Templates</h3>
                            <div id="bankExpenseTemplatesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Bank Expense Settings', content);
            updateBankExpenseTemplatesList();
        }

        function showProductSettingsSection() {
            // Get current cigarette products display
            const cigaretteProductsDisplay = cigaretteProducts.map(p => 
                `${p.name} (RM ${p.price.toFixed(2)})`
            ).join(', ');

            const content = `
                <div class="section">
                    <div class="section-header">üì¶ Product Settings</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Cigarette Products</h3>
                            <p>Manage cigarette brands and their default prices</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                                <strong>Current Products (${cigaretteProducts.length}):</strong><br>
                                ${cigaretteProductsDisplay}
                            </div>
                            <button class="btn btn-info" onclick="editCigaretteProducts()">Edit Cigarette Products</button>
                        </div>
                        <div>
                            <h3>Rental Products</h3>
                            <p>Manage rental items and their default prices</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                                <strong>Current Rental Items:</strong><br>
                                Wanton (RM 40), Pork Noodle (RM 40), Pan Mee (RM 35),<br>
                                ChiCongFun (RM 35), Kampar (RM 35), Ipoh Sherred (RM 20),<br>
                                Chicken Rice (RM 100), Cina Noodle (RM 40)
                            </div>
                            <button class="btn btn-info" onclick="editRentalProducts()">Edit Rental Products</button>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Product Settings', content);
        }

        function showRentalSettingsSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üè† Rental Collection Settings</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Add New Rental Collection</h3>
                            <p>Configure rental collection settings and pricing</p>
                            <div class="form-group">
                                <label for="newRentalName">Rental Name:</label>
                                <input type="text" id="newRentalName" class="form-control" placeholder="e.g., Wanton">
                            </div>
                            <div class="form-group">
                                <label for="newRentalPrice">Daily Price:</label>
                                <input type="number" id="newRentalPrice" class="form-control" step="0.01" placeholder="e.g., 40">
                            </div>
                            <button class="btn btn-success" onclick="addRentalTemplate()">Add Rental</button>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>Current Rental Collection Names</h3>
                            <p>Manage existing rental collections</p>
                            <div id="rentalTemplatesList"></div>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Rental Settings', content);
            loadRentalTemplates();
        }

        function showDataManagementSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üíæ Data Management</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Data Export & Import</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn btn-success" onclick="exportData()">üì§ Export Data</button>
                                <button class="btn btn-warning" onclick="importData()">üì• Import Data</button>
                                <button class="btn btn-info" onclick="backupData()">üíæ Backup Data</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>Data Statistics</h3>
                            <div id="dataStats" style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                                <p><strong>Total Records:</strong> <span id="totalRecords">0</span></p>
                                <p><strong>Date Range:</strong> <span id="dateRange">No data</span></p>
                                <p><strong>Last Updated:</strong> <span id="lastUpdated">Never</span></p>
                            </div>
                        </div>
                        <div>
                            <h3>Data Cleanup</h3>
                            <button class="btn btn-warning" onclick="clearOldData()">üóëÔ∏è Clear Old Data</button>
                            <button class="btn btn-danger" onclick="resetAllData()">‚ö†Ô∏è Reset All Data</button>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Data Management', content);
            updateDataStats();
        }

        function showReportsSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üìà Financial Reports</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Generate Reports</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="generateDailyReport()">üìÖ Daily Report</button>
                                <button class="btn btn-primary" onclick="generateWeeklyReport()">üìä Weekly Report</button>
                                <button class="btn btn-primary" onclick="generateMonthlyReport()">üìà Monthly Report</button>
                                <button class="btn btn-success" onclick="generate30DaysReport()">üìä 30 Days Report</button>
                                <button class="btn btn-success" onclick="generate90DaysReport()">üìä 90 Days Report</button>
                                <button class="btn btn-info" onclick="generateCustomReport()">üîç Custom Report</button>
                            </div>
                        </div>
                        <div>
                            <h3>Quick Analytics</h3>
                            <div id="quickAnalytics" style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                                <p><strong>Today's Sales:</strong> <span id="todaySales">RM 0.00</span></p>
                                <p><strong>This Week's Total:</strong> <span id="weekSales">RM 0.00</span></p>
                                <p><strong>This Month's Total:</strong> <span id="monthSales">RM 0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Display Section -->
                <div id="reportDisplay" style="display: none; margin-top: 20px;">
                    <div class="section">
                        <div class="section-header">
                            <span id="reportTitle">Report</span>
                            <div style="float: right;">
                                <button class="btn btn-success" onclick="exportReport()" style="margin-right: 10px;">üì§ Export</button>
                                <button class="btn btn-warning" onclick="printReport()">üñ®Ô∏è Print</button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div id="reportContent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="charts-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Financial Analytics Charts</h3>
                    
                    <div class="charts-grid">
                        <!-- Sales Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üí∞ Sales Overview</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateSalesChart('7days')">7 Days</button>
                                <button onclick="updateSalesChart('30days')">30 Days</button>
                                <button onclick="updateSalesChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>

                        <!-- Expenses Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üí∏ Expenses Breakdown</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateExpensesChart('7days')">7 Days</button>
                                <button onclick="updateExpensesChart('30days')">30 Days</button>
                                <button onclick="updateExpensesChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        </div>

                        <!-- Salary Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üë• Salary Distribution</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateSalaryChart('7days')">7 Days</button>
                                <button onclick="updateSalaryChart('30days')">30 Days</button>
                                <button onclick="updateSalaryChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="salaryChart"></canvas>
                            </div>
                        </div>

                        <!-- Cash Flow Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üíµ Cash Flow Analysis</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateCashFlowChart('7days')">7 Days</button>
                                <button onclick="updateCashFlowChart('30days')">30 Days</button>
                                <button onclick="updateCashFlowChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>

                        <!-- Cash Flow Pie Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üíµ Cash Flow Analysis (Percentage)</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateCashFlowPieChart('7days')">7 Days</button>
                                <button onclick="updateCashFlowPieChart('30days')">30 Days</button>
                                <button onclick="updateCashFlowPieChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="cashFlowPieChart"></canvas>
                            </div>
                        </div>

                        <!-- Profit/Loss Chart -->
                        <div class="chart-container" style="grid-column: 1 / -1;">
                            <div class="chart-title">üìà Profit & Loss Trend</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateProfitLossChart('7days')">7 Days</button>
                                <button onclick="updateProfitLossChart('30days')">30 Days</button>
                                <button onclick="updateProfitLossChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper" style="height: 400px;">
                                <canvas id="profitLossChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expenses Board Table -->
                    <div class="section" style="margin-top: 30px;">
                        <div class="section-header">üìã Expenses Board</div>
                        <div class="section-content">
                            <div style="margin-bottom: 15px;">
                                <p style="color: #666;">View all expenses and bank expenses sorted by amount to see which expenses cost the most and least.</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="updateExpensesBoard('7days')">7 Days</button>
                                    <button class="btn btn-primary" onclick="updateExpensesBoard('30days')">30 Days</button>
                                    <button class="btn btn-primary" onclick="updateExpensesBoard('90days')">90 Days</button>
                                    <button class="btn btn-info" onclick="updateExpensesBoard('all')">All Time</button>
                                    <button class="btn btn-info" onclick="generateExpensesBoardCustomReport()">üîç Custom Report</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table" id="expensesBoardTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Rank</th>
                                            <th style="width: 30%;">Expense Name</th>
                                            <th style="width: 15%;">Type</th>
                                            <th style="width: 10%;">Count</th>
                                            <th style="width: 15%;">Total Amount</th>
                                            <th style="width: 20%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expensesBoardTableBody">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                                                Loading expenses data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cash Flow Analysis Table -->
                    <div class="section" style="margin-top: 30px;">
                        <div class="section-header">üíµ Cash Flow Analysis</div>
                        <div class="section-content">
                            <div style="margin-bottom: 15px;">
                                <p style="color: #666;">View cash flow details including Cash, TNG, Shopee, and Grab received for selected date range.</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="generateCashFlow30DaysReport()">30 Days</button>
                                    <button class="btn btn-info" onclick="generateCashFlowCustomReport()">üîç Custom Report</button>
                                    <button class="btn btn-success" onclick="exportCashFlowToExcel()" style="background-color: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üìä Export to Excel</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table" id="cashFlowAnalysisTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;">Date</th>
                                            <th style="width: 12%;">Cash Received</th>
                                            <th style="width: 12%;">TNG Received</th>
                                            <th style="width: 10%;">Shopee</th>
                                            <th style="width: 10%;">Grab</th>
                                            <th style="width: 12%;">Expenses paid by Cash</th>
                                            <th style="width: 12%;">Salary/Gaji paid by cash</th>
                                            <th style="width: 12%;">Total Sale</th>
                                            <th style="width: 10%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cashFlowAnalysisTableBody">
                                        <tr>
                                            <td colspan="9" style="text-align: center; padding: 20px; color: #999;">
                                                Select 30 Days or Custom Report to view cash flow data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sale Summary Reports Table -->
                    <div class="section" style="margin-top: 30px;">
                        <div class="section-header">üìä Sale Summary Reports</div>
                        <div class="section-content">
                            <div style="margin-bottom: 15px;">
                                <p style="color: #666;">View sales summary including Cigarette Sales, Rental Collection, Coffee Sales, and Total Sales for selected date range.</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="generateSaleSummary30DaysReport()">30 Days</button>
                                    <button class="btn btn-info" onclick="generateSaleSummaryCustomReport()">üîç Custom Report</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table" id="saleSummaryTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Date</th>
                                            <th style="width: 18%;">Cigarette Sales</th>
                                            <th style="width: 18%;">Rental Collection</th>
                                            <th style="width: 18%;">Coffee Sales</th>
                                            <th style="width: 18%;">Total Sales</th>
                                            <th style="width: 13%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="saleSummaryTableBody">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                                                Select 30 Days or Custom Report to view sale summary data
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Reports', content);
            updateQuickAnalytics();
            
            // Initialize charts and expenses board after a short delay to ensure DOM is ready
            setTimeout(() => {
                initializeCharts();
                updateExpensesBoard('30days'); // Default to 30 days view
            }, 100);
        }

        function showNightReportsSection() {
            const content = `
                <div class="section">
                    <div class="section-header">üåô Night Section Reports</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Generate Night Shift Reports</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="generateNightDailyReport()">üìÖ Daily Report</button>
                                <button class="btn btn-primary" onclick="generateNightWeeklyReport()">üìä Weekly Report</button>
                                <button class="btn btn-primary" onclick="generateNightMonthlyReport()">üìà Monthly Report</button>
                                <button class="btn btn-info" onclick="generateNightCustomReport()">üîç Custom Report</button>
                            </div>
                        </div>
                        <div>
                            <h3>Quick Analytics</h3>
                            <div id="nightQuickAnalytics" style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                                <p><strong>Today's Night Sales:</strong> <span id="nightTodaySales">RM 0.00</span></p>
                                <p><strong>This Week's Night Total:</strong> <span id="nightWeekSales">RM 0.00</span></p>
                                <p><strong>This Month's Night Total:</strong> <span id="nightMonthSales">RM 0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Display Section -->
                <div id="nightReportDisplay" style="display: none; margin-top: 20px;">
                    <div class="section">
                        <div class="section-header">
                            <span id="nightReportTitle">Night Shift Report</span>
                            <div style="float: right;">
                                <button class="btn btn-success" onclick="exportNightReport()" style="margin-right: 10px;">üì§ Export</button>
                                <button class="btn btn-warning" onclick="printNightReport()">üñ®Ô∏è Print</button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div id="nightReportContent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="charts-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Night Shift Analytics Charts</h3>
                    
                    <div class="charts-grid">
                        <!-- Night Sales Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üí∞ Night Sales Overview</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateNightSalesChart('7days')">7 Days</button>
                                <button onclick="updateNightSalesChart('30days')">30 Days</button>
                                <button onclick="updateNightSalesChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="nightSalesChart"></canvas>
                            </div>
                        </div>

                        <!-- Night Cash Flow Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üíµ Night Cash Flow Analysis</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateNightCashFlowChart('7days')">7 Days</button>
                                <button onclick="updateNightCashFlowChart('30days')">30 Days</button>
                                <button onclick="updateNightCashFlowChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="nightCashFlowChart"></canvas>
                            </div>
                        </div>

                        <!-- Night Cash Flow Pie Chart -->
                        <div class="chart-container">
                            <div class="chart-title">üíµ Night Cash Flow Analysis (Percentage)</div>
                            <div class="chart-controls">
                                <button class="active" onclick="updateNightCashFlowPieChart('7days')">7 Days</button>
                                <button onclick="updateNightCashFlowPieChart('30days')">30 Days</button>
                                <button onclick="updateNightCashFlowPieChart('90days')">90 Days</button>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="nightCashFlowPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Night Section Reports', content);
            updateNightQuickAnalytics();
            
            // Load night shift data if not already loaded
            if (nightShiftData.length === 0) {
                refreshNightHistoryTable().then(() => {
                    // Initialize night shift charts after data is loaded
                    setTimeout(() => {
                        initializeNightCharts();
                        updateNightQuickAnalytics();
                    }, 100);
                });
            } else {
                // Initialize night shift charts after a short delay to ensure DOM is ready
                setTimeout(() => {
                    initializeNightCharts();
                }, 100);
            }
        }

        function showHelpSection() {
            const content = `
                <div class="section">
                    <div class="section-header">‚ùì Help & Documentation</div>
                    <div class="section-content">
                        <div style="margin-bottom: 20px;">
                            <h3>Getting Started</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                                <p><strong>1. Daily Data Entry:</strong> Use the Dashboard to enter daily sales, expenses, and income.</p>
                                <p><strong>2. Template Management:</strong> Go to Settings to manage expense and salary templates.</p>
                                <p><strong>3. Reports:</strong> Generate reports to analyze your financial data.</p>
                                <p><strong>4. Data Management:</strong> Export, import, or backup your data.</p>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3>Features</h3>
                            <ul style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                                <li>üìä Real-time calculations</li>
                                <li>üí∞ Custom expense categories</li>
                                <li>üë• Salary management</li>
                                <li>üè¶ Bank transfer tracking</li>
                                <li>üìà Financial reporting</li>
                                <li>üíæ Data backup & restore</li>
                            </ul>
                        </div>
                        <div>
                            <h3>Support</h3>
                            <p>For technical support or feature requests, please contact the system administrator.</p>
                        </div>
                    </div>
                </div>
            `;
            createBackendSection('Help & Documentation', content);
        }

        // Helper functions for backend sections
        function updateExpenseTemplatesList() {
            const list = document.getElementById('expenseTemplatesList');
            if (!list) return;
            
            list.innerHTML = '';
            savedExpenses.forEach((expense, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
                const expenseName = expense.name || expense;
                div.innerHTML = `
                    <span>${expenseName}</span>
                    <button onclick="removeExpenseTemplateFromSettings(${index})" class="btn-remove">Remove</button>
                `;
                list.appendChild(div);
            });
        }

        function updateSalaryTemplatesList() {
            const list = document.getElementById('salaryTemplatesList');
            if (!list) return;
            
            list.innerHTML = '';
            savedSalaries.forEach((salary, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
                const salaryName = salary.name || salary;
                div.innerHTML = `
                    <span>${salaryName}</span>
                    <button onclick="removeSalaryTemplateFromSettings(${index})" class="btn-remove">Remove</button>
                `;
                list.appendChild(div);
            });
        }

        function updateBankExpenseTemplatesList() {
            const list = document.getElementById('bankExpenseTemplatesList');
            if (!list) return;
            
            list.innerHTML = '';
            savedBankExpenses.forEach((expense, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
                const expenseName = expense.name || expense;
                div.innerHTML = `
                    <span>${expenseName}</span>
                    <button onclick="removeBankExpenseTemplateFromSettings(${index})" class="btn-remove">Remove</button>
                `;
                list.appendChild(div);
            });
        }

        function addExpenseTemplateFromSettings() {
            const input = document.getElementById('newExpenseTemplate');
            const name = input.value.trim();
            if (name) {
                saveExpenseTemplate(name);
                input.value = '';
                updateExpenseTemplatesList();
            }
        }

        function addSalaryTemplateFromSettings() {
            const input = document.getElementById('newSalaryTemplate');
            const name = input.value.trim();
            if (name) {
                saveSalaryTemplate(name);
                input.value = '';
                updateSalaryTemplatesList();
            }
        }

        function addBankExpenseTemplateFromSettings() {
            const input = document.getElementById('newBankExpenseTemplate');
            const name = input.value.trim();
            if (name) {
                saveBankExpenseTemplate(name);
                input.value = '';
                updateBankExpenseTemplatesList();
            }
        }

        function removeExpenseTemplateFromSettings(index) {
            savedExpenses.splice(index, 1);
            localStorage.setItem('savedExpenses', JSON.stringify(savedExpenses));
            updateExpenseSuggestions();
            updateExpenseTemplatesList();
        }

        function removeSalaryTemplateFromSettings(index) {
            const salaryToRemove = savedSalaries[index];
            
            // Remove from Firestore if it has an id
            if (salaryToRemove.id) {
                deleteFromFirestore(COLLECTIONS.SALARIES, salaryToRemove.id).then(() => {
                    console.log('Salary template removed from Firestore');
                }).catch(error => {
                    console.error('Error removing salary template from Firestore:', error);
                });
            }
            
            // Remove from local array
            savedSalaries.splice(index, 1);
            
            // Update localStorage
            localStorage.setItem('savedSalaries', JSON.stringify(savedSalaries.map(s => s.name || s)));
            
            updateSalarySuggestions();
            updateSalaryTemplatesList();
        }

        function removeBankExpenseTemplateFromSettings(index) {
            savedBankExpenses.splice(index, 1);
            localStorage.setItem('savedBankExpenses', JSON.stringify(savedBankExpenses));
            updateBankExpenseSuggestions();
            updateBankExpenseTemplatesList();
        }

        function updateDataStats() {
            const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            document.getElementById('totalRecords').textContent = savedData.length;
            
            if (savedData.length > 0) {
                const dates = savedData.map(d => d.date).sort();
                document.getElementById('dateRange').textContent = `${dates[0]} to ${dates[dates.length - 1]}`;
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            }
        }

        function updateQuickAnalytics() {
            const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            const today = new Date().toISOString().split('T')[0];
            
            const todayData = savedData.filter(d => d.date === today);
            const todaySales = todayData.reduce((sum, d) => sum + parseFloat(d.salesToday || 0), 0);
            
            document.getElementById('todaySales').textContent = `RM ${todaySales.toFixed(2)}`;
            document.getElementById('weekSales').textContent = 'RM 0.00'; // Implement week calculation
            document.getElementById('monthSales').textContent = 'RM 0.00'; // Implement month calculation
        }

        // Generate Custom Report for Expenses Board
        function generateExpensesBoardCustomReport() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0;">üîç Custom Report - Expenses Board</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Date:</label>
                        <input type="date" id="expensesBoardStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Date:</label>
                        <input type="date" id="expensesBoardEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="generateExpensesBoardFromDates()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Report</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function generateExpensesBoardFromDates() {
            const startDateInput = document.getElementById('expensesBoardStartDate');
            const endDateInput = document.getElementById('expensesBoardEndDate');
            
            if (!startDateInput || !endDateInput || !startDateInput.value || !endDateInput.value) {
                alert('Please select both start and end dates.');
                return;
            }
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before or equal to end date.');
                return;
            }
            
            // Close the modal
            document.querySelector('div[style*="z-index: 1000"]').remove();
            
            // Call updateExpensesBoard with custom date range
            updateExpensesBoardWithCustomDates(startDate, endDate);
        }

        // Update Expenses Board Table
        function updateExpensesBoard(period) {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            // Filter data by period
            let filteredData = savedData;
            if (period !== 'all') {
                const days = parseInt(period.replace('days', ''));
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - days);
                
                filteredData = savedData.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= startDate && recordDate <= endDate;
                });
            }
            
            // Process and display expenses
            processExpensesBoardData(filteredData, period);
        }

        function updateExpensesBoardWithCustomDates(startDate, endDate) {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            // Filter data by custom date range
            const filteredData = savedData.filter(record => {
                let entryDateStr = record.date;
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                return entryDateNormalized >= startDate && entryDateNormalized <= endDate;
            });
            
            // Process and display expenses with custom period label
            processExpensesBoardData(filteredData, `custom-${startDate}-${endDate}`);
        }

        function processExpensesBoardData(filteredData, period) {
            // Aggregate expenses and bank expenses
            const expensesMap = new Map(); // Map<name, {type, total, count}>
            
            filteredData.forEach(record => {
                // Process expenses
                if (record.expenses && Array.isArray(record.expenses)) {
                    record.expenses.forEach(exp => {
                        if (exp.name && exp.name.trim()) {
                            const name = exp.name.trim();
                            const amount = parseFloat(exp.amount) || 0;
                            if (amount > 0) {
                                if (expensesMap.has(name)) {
                                    const existing = expensesMap.get(name);
                                    existing.total += amount;
                                    existing.count += 1;
                                } else {
                                    expensesMap.set(name, {
                                        type: 'Expense',
                                        total: amount,
                                        count: 1
                                    });
                                }
                            }
                        }
                    });
                }
                
                // Process bank expenses
                if (record.bankExpenses && Array.isArray(record.bankExpenses)) {
                    record.bankExpenses.forEach(exp => {
                        if (exp.name && exp.name.trim()) {
                            const name = exp.name.trim();
                            const amount = parseFloat(exp.amount) || 0;
                            if (amount > 0) {
                                // For bank expenses, add "(Bank)" suffix if same name exists as expense
                                const key = expensesMap.has(name) ? `${name} (Bank)` : name;
                                if (expensesMap.has(key)) {
                                    const existing = expensesMap.get(key);
                                    existing.total += amount;
                                    existing.count += 1;
                                } else {
                                    expensesMap.set(key, {
                                        type: 'Bank Expense',
                                        total: amount,
                                        count: 1
                                    });
                                }
                            }
                        }
                    });
                }
            });
            
            // Convert map to array and sort by total amount (highest first)
            const expensesArray = Array.from(expensesMap.entries())
                .map(([name, data]) => ({
                    name: name,
                    type: data.type,
                    total: data.total,
                    count: data.count
                }))
                .sort((a, b) => b.total - a.total);
            
            // Update table
            const tbody = document.getElementById('expensesBoardTableBody');
            if (!tbody) return;
            
            if (expensesArray.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                            No expenses data found for the selected period.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Store mapping of expense names to their source records for editing
            // This will help us update the correct records when saving
            if (!window.expensesBoardData) {
                window.expensesBoardData = new Map();
            }
            
            // Build mapping: expenseKey -> { type, records: [{ record, originalName, originalAmount, index }] }
            const expenseToRecordsMap = new Map();
            filteredData.forEach(record => {
                // Process expenses
                if (record.expenses && Array.isArray(record.expenses)) {
                    record.expenses.forEach((exp, index) => {
                        if (exp.name && exp.name.trim()) {
                            const name = exp.name.trim();
                            const amount = parseFloat(exp.amount) || 0;
                            if (amount > 0) {
                                if (!expenseToRecordsMap.has(name)) {
                                    expenseToRecordsMap.set(name, {
                                        type: 'Expense',
                                        records: []
                                    });
                                }
                                expenseToRecordsMap.get(name).records.push({
                                    record: record,
                                    originalName: name,
                                    originalAmount: amount,
                                    index: index,
                                    isBank: false
                                });
                            }
                        }
                    });
                }
                
                // Process bank expenses
                if (record.bankExpenses && Array.isArray(record.bankExpenses)) {
                    record.bankExpenses.forEach((exp, index) => {
                        if (exp.name && exp.name.trim()) {
                            const name = exp.name.trim();
                            const amount = parseFloat(exp.amount) || 0;
                            if (amount > 0) {
                                const key = expenseToRecordsMap.has(name) ? `${name} (Bank)` : name;
                                if (!expenseToRecordsMap.has(key)) {
                                    expenseToRecordsMap.set(key, {
                                        type: 'Bank Expense',
                                        records: []
                                    });
                                }
                                expenseToRecordsMap.get(key).records.push({
                                    record: record,
                                    originalName: name,
                                    originalAmount: amount,
                                    index: index,
                                    isBank: true
                                });
                            }
                        }
                    });
                }
            });
            
            // Store the mapping for use in save function
            window.expensesBoardData = expenseToRecordsMap;
            
            // Calculate total amount
            const totalAmount = expensesArray.reduce((sum, exp) => sum + exp.total, 0);
            
            tbody.innerHTML = expensesArray.map((exp, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'style="color: #e74c3c; font-weight: bold;"' : 
                                 rank === expensesArray.length ? 'style="color: #27ae60; font-weight: bold;"' : '';
                const rankIcon = rank === 1 ? 'üèÜ ' : rank === expensesArray.length ? 'üìâ ' : '';
                
                // Create unique row ID based on expense name and type
                const rowId = `expense-${exp.name.replace(/[^a-zA-Z0-9]/g, '-')}-${exp.type.replace(/\s/g, '-')}-${index}`;
                
                // Extract original name (remove "(Bank)" suffix if present)
                const originalName = exp.name.replace(' (Bank)', '');
                
                return `
                    <tr id="${rowId}">
                        <td ${rankClass}>${rankIcon}${rank}</td>
                        <td>
                            <input type="text" 
                                   class="expense-board-name" 
                                   value="${originalName}" 
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"
                                   data-original-name="${exp.name}">
                        </td>
                        <td><span class="badge" style="background: ${exp.type === 'Expense' ? '#3498db' : '#9b59b6'}; color: white; padding: 4px 8px; border-radius: 3px;">${exp.type}</span></td>
                        <td>${exp.count}</td>
                        <td>
                            <input type="number" 
                                   class="expense-board-amount" 
                                   value="${exp.total.toFixed(2)}" 
                                   step="0.01"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; color: ${rank === 1 ? '#e74c3c' : '#2c3e50'};"
                                   data-original-total="${exp.total.toFixed(2)}">
                        </td>
                        <td>
                            <button class="btn btn-success" 
                                    onclick="saveExpensesBoardRow('${exp.name}', '${exp.type}')" 
                                    style="padding: 5px 10px; font-size: 0.9em;">
                                üíæ Save
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') + `
                <tr style="font-weight: bold; background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                    <td colspan="4" style="text-align: right; padding: 10px;">Total:</td>
                    <td id="expensesBoardTotal" style="font-weight: bold; color: #27ae60; font-size: 1.1em; padding: 10px;">
                        RM ${totalAmount.toFixed(2)}
                    </td>
                    <td></td>
                </tr>
            `;
            
            // Update button states (only for predefined periods, not custom)
            if (!period.startsWith('custom-')) {
                document.querySelectorAll('[onclick^="updateExpensesBoard"]').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('onclick').includes(`'${period}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // Save Expenses Board Row
        async function saveExpensesBoardRow(originalExpenseKey, expenseType) {
            if (!window.expensesBoardData || !window.expensesBoardData.has(originalExpenseKey)) {
                alert('Expense data not found. Please refresh the table and try again.');
                return;
            }

            // Find the row in the table
            const row = Array.from(document.querySelectorAll('#expensesBoardTableBody tr')).find(tr => {
                const button = tr.querySelector(`button[onclick*="'${originalExpenseKey}'"]`);
                return button !== null;
            });

            if (!row) {
                alert('Row not found. Please refresh the table and try again.');
                return;
            }

            // Get edited values
            const nameInput = row.querySelector('.expense-board-name');
            const amountInput = row.querySelector('.expense-board-amount');
            
            if (!nameInput || !amountInput) {
                alert('Input fields not found.');
                return;
            }

            const newName = nameInput.value.trim();
            const newTotalAmount = parseFloat(amountInput.value) || 0;

            if (!newName) {
                alert('Expense name cannot be empty.');
                return;
            }

            if (newTotalAmount < 0) {
                alert('Total amount cannot be negative.');
                return;
            }

            // Get the expense data mapping
            const expenseData = window.expensesBoardData.get(originalExpenseKey);
            if (!expenseData || !expenseData.records || expenseData.records.length === 0) {
                alert('No records found for this expense.');
                return;
            }

            // Calculate original total to determine distribution ratio
            const originalTotal = expenseData.records.reduce((sum, r) => sum + r.originalAmount, 0);
            
            // Group records by date and type to update all occurrences in each record
            const recordsToUpdate = new Map(); // Map<recordKey, { record, isBank, originalName, totalAmountInRecord }>
            
            expenseData.records.forEach(recordInfo => {
                const record = recordInfo.record;
                const recordKey = `${record.date}-${recordInfo.isBank ? 'bank' : 'expense'}`;
                
                if (!recordsToUpdate.has(recordKey)) {
                    // Calculate total amount of this expense in this record
                    const expenseArray = recordInfo.isBank ? (record.bankExpenses || []) : (record.expenses || []);
                    const totalInRecord = expenseArray
                        .filter(exp => exp.name && exp.name.trim() === recordInfo.originalName)
                        .reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    
                    recordsToUpdate.set(recordKey, {
                        record: record,
                        isBank: recordInfo.isBank,
                        originalName: recordInfo.originalName,
                        totalAmountInRecord: totalInRecord
                    });
                }
            });

            // Update all records
            const updatePromises = [];
            
            for (const [recordKey, recordData] of recordsToUpdate) {
                const record = recordData.record;
                const expenseArray = recordData.isBank ? (record.bankExpenses || []) : (record.expenses || []);
                
                // Calculate the ratio for this record's portion of the total
                const ratio = originalTotal > 0 ? recordData.totalAmountInRecord / originalTotal : 1 / recordsToUpdate.size;
                const newAmountForRecord = newTotalAmount * ratio;
                
                // Count how many times this expense appears in this record
                const matchingExpenses = expenseArray.filter(exp => 
                    exp.name && exp.name.trim() === recordData.originalName
                );
                const countInRecord = matchingExpenses.length;
                
                // Update all occurrences of this expense in the record
                // Distribute the new amount equally among all occurrences
                const amountPerOccurrence = countInRecord > 0 ? newAmountForRecord / countInRecord : 0;
                
                expenseArray.forEach(exp => {
                    if (exp.name && exp.name.trim() === recordData.originalName) {
                        exp.name = newName;
                        exp.amount = amountPerOccurrence;
                    }
                });

                // Recalculate totals for the record
                const totalExpenses = (record.expenses || []).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                const totalBankExpenses = (record.bankExpenses || []).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                record.totalExpenses = totalExpenses;
                record.totalBankExpenses = totalBankExpenses;

                // Update Firestore if record has an id
                if (record.id) {
                    updatePromises.push(
                        updateFirestoreDoc(COLLECTIONS.DAILY_DATA, record.id, {
                            expenses: record.expenses || [],
                            bankExpenses: record.bankExpenses || [],
                            totalExpenses: totalExpenses,
                            totalBankExpenses: totalBankExpenses
                        }).catch(error => {
                            console.error(`Error updating record ${record.date}:`, error);
                        })
                    );
                }

                // Update in dailyFinanceData array
                const dataIndex = dailyFinanceData.findIndex(r => r.date === record.date);
                if (dataIndex !== -1) {
                    dailyFinanceData[dataIndex] = { ...dailyFinanceData[dataIndex], ...record };
                }
            }

            // Update localStorage
            const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            for (const [recordKey, recordData] of recordsToUpdate) {
                const record = recordData.record;
                const localIndex = savedData.findIndex(r => r.date === record.date);
                if (localIndex !== -1) {
                    savedData[localIndex] = { ...savedData[localIndex], ...record };
                }
            }
            localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));

            // Wait for all Firestore updates
            try {
                await Promise.all(updatePromises);
                
                // Show success feedback
                const saveButton = row.querySelector('button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '‚úÖ Saved';
                saveButton.style.background = '#27ae60';
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.background = '';
                }, 2000);

                // Refresh the expenses board table
                // Get current period from active button
                const activeButton = document.querySelector('[onclick^="updateExpensesBoard"].active');
                if (activeButton) {
                    const onclickAttr = activeButton.getAttribute('onclick');
                    const periodMatch = onclickAttr.match(/updateExpensesBoard\('(.+?)'\)/);
                    if (periodMatch) {
                        updateExpensesBoard(periodMatch[1]);
                    } else {
                        updateExpensesBoard('30days'); // Default to 30 days
                    }
                } else {
                    updateExpensesBoard('30days'); // Default to 30 days
                }

                // Also refresh the history table if it exists
                if (typeof refreshHistoryTable === 'function') {
                    await refreshHistoryTable();
                }

            } catch (error) {
                console.error('Error saving expenses:', error);
                alert('Some records may not have been updated. Please check and try again.');
            }
        }

        // Cash Flow Analysis Functions
        function generateCashFlow30DaysReport() {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 29 * 24 * 60 * 60 * 1000); // Past 30 days (including today)
            
            const days30Data = savedData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            updateCashFlowTable(days30Data);
        }

        function generateCashFlowCustomReport() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Cash Flow Custom Report</h2>
                    <div class="date-picker">
                        <label>From Date:</label>
                        <input type="date" id="cashFlowStartDate" value="${new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                    </div>
                    <div class="date-picker">
                        <label>To Date:</label>
                        <input type="date" id="cashFlowEndDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button onclick="generateCashFlowFromDates()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Report</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateCashFlowFromDates() {
            const startDate = document.getElementById('cashFlowStartDate').value;
            const endDate = document.getElementById('cashFlowEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be later than end date.');
                return;
            }

            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            // Normalize dates to YYYY-MM-DD format for comparison
            const startDateNormalized = startDate;
            const endDateNormalized = endDate;
            
            const customData = savedData.filter(entry => {
                let entryDateStr = entry.date;
                
                // Normalize entry date
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                
                return entryDateNormalized >= startDateNormalized && entryDateNormalized <= endDateNormalized;
            }).sort((a, b) => {
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            // Close the modal
            document.querySelector('div[style*="z-index: 1000"]').remove();
            
            updateCashFlowTable(customData);
        }

        function updateCashFlowTable(data) {
            const tbody = document.getElementById('cashFlowAnalysisTableBody');
            
            if (!tbody) {
                console.error('Cash flow table body not found');
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 20px; color: #999;">
                            No cash flow data available for the selected date range.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Store the data for later use (for saving)
            if (!window.cashFlowTableData) {
                window.cashFlowTableData = {};
            }
            
            // Calculate totals
            let totalCash = 0;
            let totalTNG = 0;
            let totalShopee = 0;
            let totalGrab = 0;
            let totalCashExpenses = 0;
            let totalCashSalary = 0;
            let totalSales = 0;
            
            const rows = data.map((entry, index) => {
                const cash = parseFloat(entry.cashReceived || 0);
                const tng = parseFloat(entry.tngReceived || 0);
                const shopee = parseFloat(entry.shopeeReceived || 0);
                const grab = parseFloat(entry.grabReceived || 0);
                const cashExpenses = parseFloat(entry.cashExpenses || 0);
                const cashSalary = parseFloat(entry.cashSalary || 0);
                // Total Sale = Cash Received + TNG Received + Expenses paid by Cash + Salary paid by cash + Grab Received + Shopee Received
                const totalSale = cash + tng + cashExpenses + cashSalary + grab + shopee;
                
                totalCash += cash;
                totalTNG += tng;
                totalShopee += shopee;
                totalGrab += grab;
                totalCashExpenses += cashExpenses;
                totalCashSalary += cashSalary;
                totalSales += totalSale;
                
                // Format date using the existing formatDate helper
                const formattedDate = formatDate(entry.date);
                
                // Store entry data for saving
                const rowId = `cashFlowRow_${index}_${entry.date}`;
                window.cashFlowTableData[rowId] = entry;
                
                return `
                    <tr id="${rowId}" data-entry-date="${entry.date}" data-entry-id="${entry.id || ''}">
                        <td>${formattedDate}</td>
                        <td>
                            <input type="number" 
                                   class="cash-flow-input" 
                                   value="${cash.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="cashReceived"
                                   data-row-id="${rowId}"
                                   oninput="updateCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="cash-flow-input" 
                                   value="${tng.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="tngReceived"
                                   data-row-id="${rowId}"
                                   oninput="updateCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="cash-flow-input" 
                                   value="${shopee.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="shopeeReceived"
                                   data-row-id="${rowId}"
                                   oninput="updateCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="cash-flow-input" 
                                   value="${grab.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="grabReceived"
                                   data-row-id="${rowId}"
                                   oninput="updateCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="cash-flow-input" 
                                   value="${cashExpenses.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="cashExpenses"
                                   data-row-id="${rowId}"
                                   oninput="updateCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="cash-flow-input" 
                                   value="${cashSalary.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="cashSalary"
                                   data-row-id="${rowId}"
                                   oninput="updateCashFlowTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <span class="cash-flow-total-sale" data-row-id="${rowId}" style="font-weight: bold;">RM ${totalSale.toFixed(2)}</span>
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm" 
                                    onclick="saveCashFlowRow('${rowId}')" 
                                    style="padding: 5px 10px; font-size: 12px;">
                                üíæ Save
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add total row
            const totalRow = `
                <tr style="font-weight: bold; background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                    <td>Total</td>
                    <td id="cashFlowTotalCash">RM ${totalCash.toFixed(2)}</td>
                    <td id="cashFlowTotalTNG">RM ${totalTNG.toFixed(2)}</td>
                    <td id="cashFlowTotalShopee">RM ${totalShopee.toFixed(2)}</td>
                    <td id="cashFlowTotalGrab">RM ${totalGrab.toFixed(2)}</td>
                    <td id="cashFlowTotalCashExpenses">RM ${totalCashExpenses.toFixed(2)}</td>
                    <td id="cashFlowTotalCashSalary">RM ${totalCashSalary.toFixed(2)}</td>
                    <td id="cashFlowTotalSales" style="color: #27ae60;">RM ${totalSales.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;
            
            tbody.innerHTML = rows + totalRow;
        }

        // Export Cash Flow Analysis to Excel
        function exportCashFlowToExcel() {
            const tbody = document.getElementById('cashFlowAnalysisTableBody');
            if (!tbody) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            const rows = tbody.querySelectorAll('tr[id^="cashFlowRow_"]');
            if (rows.length === 0) {
                alert('No data to export. Please generate a report first.');
                return;
            }
            
            // CSV header
            let csvContent = '\uFEFF'; // BOM for UTF-8 (Excel compatibility)
            csvContent += 'Date,Cash Received,TNG Received,Shopee,Grab,Expenses paid by Cash,Salary/Gaji paid by cash,Total Sale\n';
            
            // Get data from table rows
            rows.forEach(row => {
                const dateCell = row.querySelector('td:first-child').textContent.trim();
                const cashInput = row.querySelector('input[data-field="cashReceived"]');
                const tngInput = row.querySelector('input[data-field="tngReceived"]');
                const shopeeInput = row.querySelector('input[data-field="shopeeReceived"]');
                const grabInput = row.querySelector('input[data-field="grabReceived"]');
                const cashExpensesInput = row.querySelector('input[data-field="cashExpenses"]');
                const cashSalaryInput = row.querySelector('input[data-field="cashSalary"]');
                const totalSaleSpan = row.querySelector('.cash-flow-total-sale');
                
                const cash = cashInput ? parseFloat(cashInput.value) || 0 : 0;
                const tng = tngInput ? parseFloat(tngInput.value) || 0 : 0;
                const shopee = shopeeInput ? parseFloat(shopeeInput.value) || 0 : 0;
                const grab = grabInput ? parseFloat(grabInput.value) || 0 : 0;
                const cashExpenses = cashExpensesInput ? parseFloat(cashExpensesInput.value) || 0 : 0;
                const cashSalary = cashSalaryInput ? parseFloat(cashSalaryInput.value) || 0 : 0;
                const totalSale = totalSaleSpan ? parseFloat(totalSaleSpan.textContent.replace('RM', '').replace(/,/g, '').trim()) || 0 : 0;
                
                csvContent += `${dateCell},${cash.toFixed(2)},${tng.toFixed(2)},${shopee.toFixed(2)},${grab.toFixed(2)},${cashExpenses.toFixed(2)},${cashSalary.toFixed(2)},${totalSale.toFixed(2)}\n`;
            });
            
            // Add total row
            const totalRow = tbody.querySelector('tr:last-child');
            if (totalRow && totalRow.textContent.includes('Total')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 8) {
                    csvContent += `Total,${totalCells[1].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[2].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[3].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[4].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[5].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[6].textContent.replace('RM', '').replace(/,/g, '').trim()},${totalCells[7].textContent.replace('RM', '').replace(/,/g, '').trim()}\n`;
                }
            }
            
            // Create filename with current date
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const filename = `Cash_Flow_Analysis_${dateStr}.csv`;
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert('Cash Flow Analysis data exported successfully!');
        }

        async function saveCashFlowRow(rowId) {
            const row = document.getElementById(rowId);
            if (!row) {
                alert('Row not found!');
                return;
            }
            
            const entryData = window.cashFlowTableData[rowId];
            if (!entryData) {
                alert('Entry data not found!');
                return;
            }
            
            // Get the input values
            const cashInput = row.querySelector('input[data-field="cashReceived"]');
            const tngInput = row.querySelector('input[data-field="tngReceived"]');
            const shopeeInput = row.querySelector('input[data-field="shopeeReceived"]');
            const grabInput = row.querySelector('input[data-field="grabReceived"]');
            const cashExpensesInput = row.querySelector('input[data-field="cashExpenses"]');
            const cashSalaryInput = row.querySelector('input[data-field="cashSalary"]');
            
            const cashReceived = parseFloat(cashInput.value) || 0;
            const tngReceived = parseFloat(tngInput.value) || 0;
            const shopeeReceived = parseFloat(shopeeInput.value) || 0;
            const grabReceived = parseFloat(grabInput.value) || 0;
            const cashExpenses = parseFloat(cashExpensesInput.value) || 0;
            const cashSalary = parseFloat(cashSalaryInput.value) || 0;
            
            // Calculate Total Sale (Sales Today) - NEW FORMULA
            const salesToday = cashReceived + tngReceived + cashExpenses + cashSalary + grabReceived + shopeeReceived;
            
            // Get cigarette sales and rental collection from the entry to recalculate coffeeSales
            const cigaretteSales = parseFloat(entryData.cigaretteSales || 0);
            const rentalCollection = parseFloat(entryData.rentalCollection || 0);
            
            // Calculate Coffee Sales - NEW FORMULA: Sales Today - Cigarette Sales - Rental Collection
            const calculatedCoffeeSales = Math.max(0, salesToday - cigaretteSales - rentalCollection);
            
            const updatedData = {
                cashReceived: cashReceived,
                tngReceived: tngReceived,
                shopeeReceived: shopeeReceived,
                grabReceived: grabReceived,
                cashExpenses: cashExpenses,
                cashSalary: cashSalary,
                salesToday: salesToday, // Update salesToday with new formula
                coffeeSales: calculatedCoffeeSales, // Recalculate coffeeSales based on new salesToday
                updatedAt: new Date()
            };
            
            try {
                // Update in dailyFinanceData array
                const recordIndex = dailyFinanceData.findIndex(r => r.date === entryData.date);
                if (recordIndex !== -1) {
                    dailyFinanceData[recordIndex] = {
                        ...dailyFinanceData[recordIndex],
                        ...updatedData
                    };
                }
                
                // Update in Firestore if record has an id
                if (entryData.id) {
                    await updateFirestoreDoc(COLLECTIONS.DAILY_DATA, entryData.id, updatedData);
                    console.log('Cash flow updated in Firestore');
                } else {
                    // Try to find the record by date
                    const existingRecord = dailyFinanceData.find(r => r.date === entryData.date && r.id);
                    if (existingRecord && existingRecord.id) {
                        await updateFirestoreDoc(COLLECTIONS.DAILY_DATA, existingRecord.id, updatedData);
                        console.log('Cash flow updated in Firestore');
                    }
                }
                
                // Update localStorage
                const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const localRecordIndex = savedData.findIndex(r => r.date === entryData.date);
                if (localRecordIndex !== -1) {
                    savedData[localRecordIndex] = {
                        ...savedData[localRecordIndex],
                        ...updatedData
                    };
                } else {
                    // If not found, add it
                    savedData.push({
                        ...entryData,
                        ...updatedData
                    });
                }
                localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));
                
                // Update the stored entry data
                window.cashFlowTableData[rowId] = {
                    ...entryData,
                    ...updatedData
                };
                
                // Update the total sale display for this row
                const totalSaleDisplay = row.querySelector('.cash-flow-total-sale');
                if (totalSaleDisplay) {
                    totalSaleDisplay.textContent = `RM ${salesToday.toFixed(2)}`;
                }
                
                // Recalculate and update totals
                updateCashFlowTotals();
                
                // Show success feedback
                const saveButton = row.querySelector('button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '‚úÖ Saved';
                saveButton.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.backgroundColor = '';
                }, 2000);
                
                // Refresh history table if it exists
                if (typeof refreshHistoryTable === 'function') {
                    await refreshHistoryTable();
                }
                
                // Refresh Sale Summary Reports table if it's currently displayed
                refreshSaleSummaryTableIfVisible(entryData.date);
                
            } catch (error) {
                console.error('Error saving cash flow data:', error);
                alert('Error saving cash flow data. Please try again.');
            }
        }

        function refreshSaleSummaryTableIfVisible(changedDate) {
            // Check if Sale Summary Reports table is visible
            const saleSummaryTableBody = document.getElementById('saleSummaryTableBody');
            if (!saleSummaryTableBody || saleSummaryTableBody.innerHTML.includes('Select 30 Days')) {
                return; // Table not populated yet
            }
            
            // Get the current data range that's displayed
            const visibleRows = saleSummaryTableBody.querySelectorAll('tr[id^="saleSummaryRow_"]');
            if (visibleRows.length === 0) {
                return; // No data displayed
            }
            
            // Check if the changed date is in the visible range
            const changedDateStr = changedDate.split('T')[0] || changedDate;
            let dateInRange = false;
            
            visibleRows.forEach(row => {
                const rowDate = row.getAttribute('data-entry-date');
                if (rowDate && (rowDate === changedDateStr || rowDate.split('T')[0] === changedDateStr)) {
                    dateInRange = true;
                }
            });
            
            if (dateInRange) {
                // Get the date range from the first and last visible rows
                const firstRow = visibleRows[0];
                const lastRow = visibleRows[visibleRows.length - 1];
                const startDate = firstRow.getAttribute('data-entry-date')?.split('T')[0];
                const endDate = lastRow.getAttribute('data-entry-date')?.split('T')[0];
                
                if (startDate && endDate) {
                    // Re-fetch and update the table using the latest data (already updated in dailyFinanceData)
                    const savedData = dailyFinanceData.length > 0 
                        ? dailyFinanceData 
                        : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                    
                    const filteredData = savedData.filter(entry => {
                        let entryDateStr = entry.date;
                        let entryDateNormalized = entryDateStr;
                        if (entryDateStr && entryDateStr.includes('T')) {
                            entryDateNormalized = entryDateStr.split('T')[0];
                        } else if (entryDateStr && entryDateStr.includes('/')) {
                            const parts = entryDateStr.split('/');
                            if (parts.length === 3) {
                                const year = parts[2];
                                const month = parts[0].padStart(2, '0');
                                const day = parts[1].padStart(2, '0');
                                entryDateNormalized = `${year}-${month}-${day}`;
                            }
                        }
                        return entryDateNormalized >= startDate && entryDateNormalized <= endDate;
                    }).sort((a, b) => {
                        const dateA = a.date?.split('T')[0] || a.date || '';
                        const dateB = b.date?.split('T')[0] || b.date || '';
                        return dateA.localeCompare(dateB);
                    });
                    
                    // Update the table with the latest data
                    updateSaleSummaryTable(filteredData);
                }
            }
        }

        function updateCashFlowTotals() {
            const tbody = document.getElementById('cashFlowAnalysisTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr[id^="cashFlowRow_"]');
            let totalCash = 0;
            let totalTNG = 0;
            let totalShopee = 0;
            let totalGrab = 0;
            let totalCashExpenses = 0;
            let totalCashSalary = 0;
            let totalSales = 0;
            
            rows.forEach(row => {
                const cashInput = row.querySelector('input[data-field="cashReceived"]');
                const tngInput = row.querySelector('input[data-field="tngReceived"]');
                const shopeeInput = row.querySelector('input[data-field="shopeeReceived"]');
                const grabInput = row.querySelector('input[data-field="grabReceived"]');
                const cashExpensesInput = row.querySelector('input[data-field="cashExpenses"]');
                const cashSalaryInput = row.querySelector('input[data-field="cashSalary"]');
                
                const cash = parseFloat(cashInput.value) || 0;
                const tng = parseFloat(tngInput.value) || 0;
                const shopee = parseFloat(shopeeInput.value) || 0;
                const grab = parseFloat(grabInput.value) || 0;
                const cashExpenses = parseFloat(cashExpensesInput.value) || 0;
                const cashSalary = parseFloat(cashSalaryInput.value) || 0;
                const totalSale = cash + tng + cashExpenses + cashSalary + grab + shopee;
                
                totalCash += cash;
                totalTNG += tng;
                totalShopee += shopee;
                totalGrab += grab;
                totalCashExpenses += cashExpenses;
                totalCashSalary += cashSalary;
                totalSales += totalSale;
                
                // Update the total sale display for this row
                const totalSaleDisplay = row.querySelector('.cash-flow-total-sale');
                if (totalSaleDisplay) {
                    totalSaleDisplay.textContent = `RM ${totalSale.toFixed(2)}`;
                }
            });
            
            // Update total row
            const totalCashEl = document.getElementById('cashFlowTotalCash');
            const totalTNGEl = document.getElementById('cashFlowTotalTNG');
            const totalShopeeEl = document.getElementById('cashFlowTotalShopee');
            const totalGrabEl = document.getElementById('cashFlowTotalGrab');
            const totalCashExpensesEl = document.getElementById('cashFlowTotalCashExpenses');
            const totalCashSalaryEl = document.getElementById('cashFlowTotalCashSalary');
            const totalSalesEl = document.getElementById('cashFlowTotalSales');
            
            if (totalCashEl) totalCashEl.textContent = `RM ${totalCash.toFixed(2)}`;
            if (totalTNGEl) totalTNGEl.textContent = `RM ${totalTNG.toFixed(2)}`;
            if (totalShopeeEl) totalShopeeEl.textContent = `RM ${totalShopee.toFixed(2)}`;
            if (totalGrabEl) totalGrabEl.textContent = `RM ${totalGrab.toFixed(2)}`;
            if (totalCashExpensesEl) totalCashExpensesEl.textContent = `RM ${totalCashExpenses.toFixed(2)}`;
            if (totalCashSalaryEl) totalCashSalaryEl.textContent = `RM ${totalCashSalary.toFixed(2)}`;
            if (totalSalesEl) totalSalesEl.textContent = `RM ${totalSales.toFixed(2)}`;
        }

        // Sale Summary Reports Functions
        function generateSaleSummary30DaysReport() {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 29 * 24 * 60 * 60 * 1000); // Past 30 days (including today)
            
            const days30Data = savedData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            updateSaleSummaryTable(days30Data);
        }

        function generateSaleSummaryCustomReport() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Sale Summary Custom Report</h2>
                    <div class="date-picker">
                        <label>From Date:</label>
                        <input type="date" id="saleSummaryStartDate" value="${new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                    </div>
                    <div class="date-picker">
                        <label>To Date:</label>
                        <input type="date" id="saleSummaryEndDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button onclick="generateSaleSummaryFromDates()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Report</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateSaleSummaryFromDates() {
            const startDate = document.getElementById('saleSummaryStartDate').value;
            const endDate = document.getElementById('saleSummaryEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be later than end date.');
                return;
            }

            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            // Normalize dates to YYYY-MM-DD format for comparison
            const startDateNormalized = startDate;
            const endDateNormalized = endDate;
            
            const customData = savedData.filter(entry => {
                let entryDateStr = entry.date;
                
                // Normalize entry date
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                
                return entryDateNormalized >= startDateNormalized && entryDateNormalized <= endDateNormalized;
            }).sort((a, b) => {
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            // Close the modal
            document.querySelector('div[style*="z-index: 1000"]').remove();
            
            updateSaleSummaryTable(customData);
        }

        function updateSaleSummaryTable(data) {
            const tbody = document.getElementById('saleSummaryTableBody');
            
            if (!tbody) {
                console.error('Sale summary table body not found');
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                            No sale summary data available for the selected date range.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Store the data for later use (for saving)
            if (!window.saleSummaryTableData) {
                window.saleSummaryTableData = {};
            }
            
            // Calculate totals
            let totalCigaretteSales = 0;
            let totalRentalCollection = 0;
            let totalCoffeeSales = 0;
            let totalSales = 0;
            
            const rows = data.map((entry, index) => {
                const cigaretteSales = parseFloat(entry.cigaretteSales || 0);
                const rentalCollection = parseFloat(entry.rentalCollection || 0);
                const coffeeSales = parseFloat(entry.coffeeSales || 0);
                // Total Sales should match salesToday from Cash Flow Analysis (calculated from cash inputs)
                // Use salesToday if available, otherwise calculate: Cigarette Sales + Rental Collection + Coffee Sales (fallback)
                const totalSale = parseFloat(entry.salesToday || 0) || (cigaretteSales + rentalCollection + coffeeSales);
                
                totalCigaretteSales += cigaretteSales;
                totalRentalCollection += rentalCollection;
                totalCoffeeSales += coffeeSales;
                totalSales += totalSale;
                
                // Format date using the existing formatDate helper
                const formattedDate = formatDate(entry.date);
                
                // Store entry data for saving
                const rowId = `saleSummaryRow_${index}_${entry.date}`;
                window.saleSummaryTableData[rowId] = entry;
                
                return `
                    <tr id="${rowId}" data-entry-date="${entry.date}" data-entry-id="${entry.id || ''}">
                        <td>${formattedDate}</td>
                        <td>
                            <input type="number" 
                                   class="sale-summary-input" 
                                   value="${cigaretteSales.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="cigaretteSales"
                                   data-row-id="${rowId}"
                                   oninput="updateSaleSummaryTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="sale-summary-input" 
                                   value="${rentalCollection.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="rentalCollection"
                                   data-row-id="${rowId}"
                                   oninput="updateSaleSummaryTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="number" 
                                   class="sale-summary-input" 
                                   value="${coffeeSales.toFixed(2)}" 
                                   step="0.01" 
                                   data-field="coffeeSales"
                                   data-row-id="${rowId}"
                                   oninput="updateSaleSummaryTotals()"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        </td>
                        <td>
                            <span class="sale-total-display" data-row-id="${rowId}" style="font-weight: bold;">RM ${totalSale.toFixed(2)}</span>
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm" 
                                    onclick="saveSaleSummaryRow('${rowId}')" 
                                    style="padding: 5px 10px; font-size: 12px;">
                                üíæ Save
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add total row
            const totalRow = `
                <tr style="font-weight: bold; background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                    <td>Total</td>
                    <td id="saleSummaryTotalCigarette">RM ${totalCigaretteSales.toFixed(2)}</td>
                    <td id="saleSummaryTotalRental">RM ${totalRentalCollection.toFixed(2)}</td>
                    <td id="saleSummaryTotalCoffee">RM ${totalCoffeeSales.toFixed(2)}</td>
                    <td id="saleSummaryTotalSales" style="color: #27ae60;">RM ${totalSales.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;
            
            tbody.innerHTML = rows + totalRow;
        }

        async function saveSaleSummaryRow(rowId) {
            const row = document.getElementById(rowId);
            if (!row) {
                alert('Row not found!');
                return;
            }
            
            const entryData = window.saleSummaryTableData[rowId];
            if (!entryData) {
                alert('Entry data not found!');
                return;
            }
            
            // Get the input values
            const cigaretteInput = row.querySelector('input[data-field="cigaretteSales"]');
            const rentalInput = row.querySelector('input[data-field="rentalCollection"]');
            const coffeeInput = row.querySelector('input[data-field="coffeeSales"]');
            
            const cigaretteSales = parseFloat(cigaretteInput.value) || 0;
            const rentalCollection = parseFloat(rentalInput.value) || 0;
            const coffeeSales = parseFloat(coffeeInput.value) || 0;
            
            // Get the entry data to calculate salesToday from cash inputs
            const cashReceived = parseFloat(entryData.cashReceived || 0);
            const tngReceived = parseFloat(entryData.tngReceived || 0);
            const cashExpenses = parseFloat(entryData.cashExpenses || 0);
            const cashSalary = parseFloat(entryData.cashSalary || 0);
            const grabReceived = parseFloat(entryData.grabReceived || 0);
            const shopeeReceived = parseFloat(entryData.shopeeReceived || 0);
            
            // Calculate salesToday - NEW FORMULA: Cash Received + TNG Received + Expenses paid by Cash + Salary paid by cash + Grab Received + Shopee Received
            const salesToday = cashReceived + tngReceived + cashExpenses + cashSalary + grabReceived + shopeeReceived;
            
            // Calculate Coffee Sales - NEW FORMULA: Sales Today - Cigarette Sales - Rental Collection
            const calculatedCoffeeSales = Math.max(0, salesToday - cigaretteSales - rentalCollection);
            
            const updatedData = {
                cigaretteSales: cigaretteSales,
                rentalCollection: rentalCollection,
                coffeeSales: calculatedCoffeeSales, // Use calculated value
                salesToday: salesToday, // Update salesToday based on new formula
                updatedAt: new Date()
            };
            
            try {
                // Update in dailyFinanceData array
                const recordIndex = dailyFinanceData.findIndex(r => r.date === entryData.date);
                if (recordIndex !== -1) {
                    dailyFinanceData[recordIndex] = {
                        ...dailyFinanceData[recordIndex],
                        ...updatedData
                    };
                }
                
                // Update in Firestore if record has an id
                if (entryData.id) {
                    await updateFirestoreDoc(COLLECTIONS.DAILY_DATA, entryData.id, updatedData);
                    console.log('Sale summary updated in Firestore');
                } else {
                    // Try to find the record by date
                    const existingRecord = dailyFinanceData.find(r => r.date === entryData.date && r.id);
                    if (existingRecord && existingRecord.id) {
                        await updateFirestoreDoc(COLLECTIONS.DAILY_DATA, existingRecord.id, updatedData);
                        console.log('Sale summary updated in Firestore');
                    }
                }
                
                // Update localStorage
                const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const localRecordIndex = savedData.findIndex(r => r.date === entryData.date);
                if (localRecordIndex !== -1) {
                    savedData[localRecordIndex] = {
                        ...savedData[localRecordIndex],
                        ...updatedData
                    };
                } else {
                    // If not found, add it
                    savedData.push({
                        ...entryData,
                        ...updatedData
                    });
                }
                localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));
                
                // Update the stored entry data
                window.saleSummaryTableData[rowId] = {
                    ...entryData,
                    ...updatedData
                };
                
                // Update the total display for this row
                const totalDisplay = row.querySelector('.sale-total-display');
                if (totalDisplay) {
                    totalDisplay.textContent = `RM ${salesToday.toFixed(2)}`;
                }
                
                // Recalculate and update totals
                updateSaleSummaryTotals();
                
                // Show success feedback
                const saveButton = row.querySelector('button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '‚úÖ Saved';
                saveButton.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.backgroundColor = '';
                }, 2000);
                
                // Refresh history table if it exists
                if (typeof refreshHistoryTable === 'function') {
                    await refreshHistoryTable();
                }
                
            } catch (error) {
                console.error('Error saving sale summary data:', error);
                alert('Error saving sale summary data. Please try again.');
            }
        }

        function updateSaleSummaryTotals() {
            const tbody = document.getElementById('saleSummaryTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr[id^="saleSummaryRow_"]');
            let totalCigaretteSales = 0;
            let totalRentalCollection = 0;
            let totalCoffeeSales = 0;
            let totalSales = 0;
            
            rows.forEach(row => {
                const rowId = row.id;
                const entryData = window.saleSummaryTableData[rowId];
                
                const cigaretteInput = row.querySelector('input[data-field="cigaretteSales"]');
                const rentalInput = row.querySelector('input[data-field="rentalCollection"]');
                const coffeeInput = row.querySelector('input[data-field="coffeeSales"]');
                
                const cigaretteSales = parseFloat(cigaretteInput.value) || 0;
                const rentalCollection = parseFloat(rentalInput.value) || 0;
                const coffeeSales = parseFloat(coffeeInput.value) || 0;
                
                // Total Sale should match salesToday from Cash Flow Analysis
                // Get salesToday from entry data, or calculate if not available
                const salesToday = entryData ? parseFloat(entryData.salesToday || 0) : 0;
                const totalSale = salesToday || (cigaretteSales + rentalCollection + coffeeSales);
                
                totalCigaretteSales += cigaretteSales;
                totalRentalCollection += rentalCollection;
                totalCoffeeSales += coffeeSales;
                totalSales += totalSale;
                
                // Update the total display for this row
                const totalDisplay = row.querySelector('.sale-total-display');
                if (totalDisplay) {
                    totalDisplay.textContent = `RM ${totalSale.toFixed(2)}`;
                }
            });
            
            // Update total row
            const totalCigaretteEl = document.getElementById('saleSummaryTotalCigarette');
            const totalRentalEl = document.getElementById('saleSummaryTotalRental');
            const totalCoffeeEl = document.getElementById('saleSummaryTotalCoffee');
            const totalSalesEl = document.getElementById('saleSummaryTotalSales');
            
            if (totalCigaretteEl) totalCigaretteEl.textContent = `RM ${totalCigaretteSales.toFixed(2)}`;
            if (totalRentalEl) totalRentalEl.textContent = `RM ${totalRentalCollection.toFixed(2)}`;
            if (totalCoffeeEl) totalCoffeeEl.textContent = `RM ${totalCoffeeSales.toFixed(2)}`;
            if (totalSalesEl) totalSalesEl.textContent = `RM ${totalSales.toFixed(2)}`;
        }

        // Chart Functions
        let charts = {};

        function initializeCharts() {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            if (savedData.length === 0) {
                showNoDataMessage();
                return;
            }

            // Destroy existing charts before reinitializing
            if (charts.sales) charts.sales.destroy();
            if (charts.expenses) charts.expenses.destroy();
            if (charts.salary) charts.salary.destroy();
            if (charts.cashFlow) charts.cashFlow.destroy();
            if (charts.cashFlowPie) charts.cashFlowPie.destroy();
            if (charts.profitLoss) charts.profitLoss.destroy();

            // Initialize all charts
            initializeSalesChart();
            initializeExpensesChart();
            initializeSalaryChart();
            initializeCashFlowChart();
            initializeCashFlowPieChart();
            initializeProfitLossChart();
        }

        function showNoDataMessage() {
            const chartContainers = document.querySelectorAll('.chart-wrapper');
            chartContainers.forEach(container => {
                container.innerHTML = '<div class="no-data-message">No data available. Start recording daily finances to see charts.</div>';
            });
        }

        function initializeSalesChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            charts.sales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cigarette Sales',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Rental Collection',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Coffee Sales',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Beer Sales',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': RM ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            updateSalesChart('7days');
        }

        function initializeExpensesChart() {
            const ctx = document.getElementById('expensesChart');
            if (!ctx) return;

            charts.expenses = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Expenses',
                        data: [],
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 1
                    }, {
                        label: 'Bank Expenses',
                        data: [],
                        backgroundColor: '#9b59b6',
                        borderColor: '#8e44ad',
                        borderWidth: 1
                    }, {
                        label: 'Salary/Gaji',
                        data: [],
                        backgroundColor: '#f39c12',
                        borderColor: '#e67e22',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': RM ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            updateExpensesChart('7days');
        }

        function initializeSalaryChart() {
            const ctx = document.getElementById('salaryChart');
            if (!ctx) return;

            charts.salary = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3498db',
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6',
                            '#1abc9c',
                            '#34495e',
                            '#e67e22',
                            '#16a085',
                            '#2c3e50'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': RM ' + value.toFixed(2) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            updateSalaryChart('7days');
        }

        function initializeCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;

            charts.cashFlow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cash Received',
                        data: [],
                        backgroundColor: '#27ae60',
                        borderColor: '#229954',
                        borderWidth: 1
                    }, {
                        label: 'TNG Received',
                        data: [],
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }, {
                        label: 'Grab Received',
                        data: [],
                        backgroundColor: '#f39c12',
                        borderColor: '#e67e22',
                        borderWidth: 1
                    }, {
                        label: 'Shopee Received',
                        data: [],
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': RM ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: false,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            stacked: false
                        }
                    }
                }
            });

            updateCashFlowChart('7days');
        }

        function initializeCashFlowPieChart() {
            const ctx = document.getElementById('cashFlowPieChart');
            if (!ctx) return;

            charts.cashFlowPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Cash Received', 'TNG Received', 'Grab Received', 'Shopee Received'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#27ae60',  // Cash - Green
                            '#3498db',  // TNG - Blue
                            '#f39c12',  // Grab - Orange
                            '#e74c3c'   // Shopee - Red
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': RM ' + value.toFixed(2) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            updateCashFlowPieChart('7days');
        }

        function initializeProfitLossChart() {
            const ctx = document.getElementById('profitLossChart');
            if (!ctx) return;

            charts.profitLoss = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Total Sales',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }, {
                        label: 'Total Expenses',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }, {
                        label: 'Net Profit',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': RM ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            updateProfitLossChart('7days');
        }

        function updateSalesChart(period) {
            if (!charts.sales) return;
            
            const data = getChartData(period);
            charts.sales.data.labels = data.labels;
            charts.sales.data.datasets[0].data = data.cigaretteSales;
            charts.sales.data.datasets[1].data = data.rentalCollection;
            charts.sales.data.datasets[2].data = data.coffeeSales;
            charts.sales.data.datasets[3].data = data.beerSales;
            charts.sales.update();
            
            updateChartControls('salesChart', period);
        }

        function updateExpensesChart(period) {
            if (!charts.expenses) return;
            
            const data = getChartData(period);
            charts.expenses.data.labels = data.labels;
            charts.expenses.data.datasets[0].data = data.expenses;
            charts.expenses.data.datasets[1].data = data.bankExpenses;
            charts.expenses.data.datasets[2].data = data.salary;
            charts.expenses.update();
            
            updateChartControls('expensesChart', period);
        }

        function updateSalaryChart(period) {
            if (!charts.salary) return;
            
            const data = getSalaryChartData(period);
            charts.salary.data.labels = data.labels;
            charts.salary.data.datasets[0].data = data.values;
            charts.salary.update();
            
            updateChartControls('salaryChart', period);
        }

        function updateCashFlowChart(period) {
            if (!charts.cashFlow) return;
            
            const data = getChartData(period);
            charts.cashFlow.data.labels = data.labels;
            charts.cashFlow.data.datasets[0].data = data.cashReceived;
            charts.cashFlow.data.datasets[1].data = data.tngReceived;
            charts.cashFlow.data.datasets[2].data = data.grabReceived;
            charts.cashFlow.data.datasets[3].data = data.shopeeReceived;
            charts.cashFlow.update();
            
            updateChartControls('cashFlowChart', period);
        }

        function updateProfitLossChart(period) {
            if (!charts.profitLoss) return;
            
            const data = getChartData(period);
            charts.profitLoss.data.labels = data.labels;
            charts.profitLoss.data.datasets[0].data = data.totalSales;
            charts.profitLoss.data.datasets[1].data = data.totalExpenses;
            charts.profitLoss.data.datasets[2].data = data.netProfit;
            charts.profitLoss.update();
            
            updateChartControls('profitLossChart', period);
        }

        function updateCashFlowPieChart(period) {
            if (!charts.cashFlowPie) return;
            
            const data = getChartData(period);
            
            // Calculate totals for the period
            const cashTotal = data.cashReceived.reduce((sum, val) => sum + val, 0);
            const tngTotal = data.tngReceived.reduce((sum, val) => sum + val, 0);
            const grabTotal = data.grabReceived.reduce((sum, val) => sum + val, 0);
            const shopeeTotal = data.shopeeReceived.reduce((sum, val) => sum + val, 0);
            
            // Update pie chart data
            charts.cashFlowPie.data.datasets[0].data = [cashTotal, tngTotal, grabTotal, shopeeTotal];
            charts.cashFlowPie.update();
            
            updateChartControls('cashFlowPieChart', period);
        }

        function updateChartControls(chartId, activePeriod) {
            const container = document.getElementById(chartId).closest('.chart-container');
            if (!container) return;
            
            const buttons = container.querySelectorAll('.chart-controls button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Map period to button text or onclick
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                if (onclick.includes(`'${activePeriod}'`) || onclick.includes(`"${activePeriod}"`)) {
                    btn.classList.add('active');
                }
            });
        }

        // ============ NIGHT SHIFT CHART FUNCTIONS ============
        
        function getNightChartData(period) {
            // Use Firestore data (nightShiftData) with localStorage as fallback
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            const days = parseInt(period.replace('days', ''));
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - (days - 1) * 24 * 60 * 60 * 1000);
            
            const filteredData = savedData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = filteredData.map(entry => {
                const date = new Date(entry.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            return {
                labels: labels,
                cigaretteSales: filteredData.map(entry => parseFloat(entry.cigaretteSales || 0)),
                coffeeSales: filteredData.map(entry => parseFloat(entry.coffeeSales || 0)),
                beerSales: filteredData.map(entry => parseFloat(entry.beerSales || 0)),
                totalSales: filteredData.map(entry => parseFloat(entry.salesToday || 0)),
                cashReceived: filteredData.map(entry => parseFloat(entry.cashReceived || 0)),
                tngReceived: filteredData.map(entry => parseFloat(entry.tngReceived || 0)),
                grabReceived: filteredData.map(entry => parseFloat(entry.grabReceived || 0)),
                shopeeReceived: filteredData.map(entry => parseFloat(entry.shopeeReceived || 0)),
                totalReceived: filteredData.map(entry => {
                    const cash = parseFloat(entry.cashReceived || 0);
                    const tng = parseFloat(entry.tngReceived || 0);
                    const grab = parseFloat(entry.grabReceived || 0);
                    const shopee = parseFloat(entry.shopeeReceived || 0);
                    return cash + tng + grab + shopee;
                })
            };
        }

        function updateNightQuickAnalytics() {
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            const today = new Date().toISOString().split('T')[0];
            
            const todayData = savedData.filter(d => d.date === today);
            const todaySales = todayData.reduce((sum, d) => sum + parseFloat(d.salesToday || 0), 0);
            
            // Calculate week total
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - 7);
            const weekData = savedData.filter(d => {
                const recordDate = new Date(d.date);
                return recordDate >= weekStart;
            });
            const weekSales = weekData.reduce((sum, d) => sum + parseFloat(d.salesToday || 0), 0);
            
            // Calculate month total
            const monthStart = new Date();
            monthStart.setDate(1); // First day of current month
            const monthData = savedData.filter(d => {
                const recordDate = new Date(d.date);
                return recordDate >= monthStart;
            });
            const monthSales = monthData.reduce((sum, d) => sum + parseFloat(d.salesToday || 0), 0);
            
            const todayElement = document.getElementById('nightTodaySales');
            const weekElement = document.getElementById('nightWeekSales');
            const monthElement = document.getElementById('nightMonthSales');
            
            if (todayElement) todayElement.textContent = `RM ${todaySales.toFixed(2)}`;
            if (weekElement) weekElement.textContent = `RM ${weekSales.toFixed(2)}`;
            if (monthElement) monthElement.textContent = `RM ${monthSales.toFixed(2)}`;
        }

        function initializeNightCharts() {
            // Use Firestore data (nightShiftData) with localStorage as fallback
            const savedData = nightShiftData.length > 0 
                ? nightShiftData 
                : JSON.parse(localStorage.getItem('nightShiftData')) || [];
            
            if (savedData.length === 0) {
                showNoNightDataMessage();
                return;
            }

            // Destroy existing charts before reinitializing
            if (charts.nightSales) charts.nightSales.destroy();
            if (charts.nightCashFlow) charts.nightCashFlow.destroy();
            if (charts.nightCashFlowPie) charts.nightCashFlowPie.destroy();

            // Initialize all night charts
            initializeNightSalesChart();
            initializeNightCashFlowChart();
            initializeNightCashFlowPieChart();
        }

        function showNoNightDataMessage() {
            const chartContainers = document.querySelectorAll('#nightSalesChart, #nightCashFlowChart, #nightCashFlowPieChart');
            chartContainers.forEach(canvas => {
                if (canvas) {
                    const container = canvas.closest('.chart-wrapper');
                    if (container) {
                        container.innerHTML = '<div class="no-data-message">No night shift data available. Start recording night shift finances to see charts.</div>';
                    }
                }
            });
        }

        function initializeNightSalesChart() {
            const ctx = document.getElementById('nightSalesChart');
            if (!ctx) return;

            charts.nightSales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cigarette Sales',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Coffee Sales',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Beer Sales',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Total Sales',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': RM ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            updateNightSalesChart('7days');
        }

        function initializeNightCashFlowChart() {
            const ctx = document.getElementById('nightCashFlowChart');
            if (!ctx) return;

            charts.nightCashFlow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cash Received',
                        data: [],
                        backgroundColor: '#27ae60',
                        borderColor: '#229954',
                        borderWidth: 1
                    }, {
                        label: 'TNG Received',
                        data: [],
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }, {
                        label: 'Grab Received',
                        data: [],
                        backgroundColor: '#f39c12',
                        borderColor: '#e67e22',
                        borderWidth: 1
                    }, {
                        label: 'Shopee Received',
                        data: [],
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': RM ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            updateNightCashFlowChart('7days');
        }

        function initializeNightCashFlowPieChart() {
            const ctx = document.getElementById('nightCashFlowPieChart');
            if (!ctx) return;

            charts.nightCashFlowPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Cash Received', 'TNG Received', 'Grab Received', 'Shopee Received'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#27ae60',  // Cash - Green
                            '#3498db',  // TNG - Blue
                            '#f39c12',  // Grab - Orange
                            '#e74c3c'   // Shopee - Red
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': RM ' + value.toFixed(2) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            updateNightCashFlowPieChart('7days');
        }

        function updateNightSalesChart(period) {
            if (!charts.nightSales) return;
            
            const data = getNightChartData(period);
            charts.nightSales.data.labels = data.labels;
            charts.nightSales.data.datasets[0].data = data.cigaretteSales;
            charts.nightSales.data.datasets[1].data = data.coffeeSales;
            charts.nightSales.data.datasets[2].data = data.beerSales;
            charts.nightSales.data.datasets[3].data = data.totalSales;
            charts.nightSales.update();
            
            updateChartControls('nightSalesChart', period);
        }

        function updateNightCashFlowChart(period) {
            if (!charts.nightCashFlow) return;
            
            const data = getNightChartData(period);
            charts.nightCashFlow.data.labels = data.labels;
            charts.nightCashFlow.data.datasets[0].data = data.cashReceived;
            charts.nightCashFlow.data.datasets[1].data = data.tngReceived;
            charts.nightCashFlow.data.datasets[2].data = data.grabReceived;
            charts.nightCashFlow.data.datasets[3].data = data.shopeeReceived;
            charts.nightCashFlow.update();
            
            updateChartControls('nightCashFlowChart', period);
        }

        function updateNightCashFlowPieChart(period) {
            if (!charts.nightCashFlowPie) return;
            
            const data = getNightChartData(period);
            
            // Calculate totals for the period
            const cashTotal = data.cashReceived.reduce((sum, val) => sum + val, 0);
            const tngTotal = data.tngReceived.reduce((sum, val) => sum + val, 0);
            const grabTotal = data.grabReceived.reduce((sum, val) => sum + val, 0);
            const shopeeTotal = data.shopeeReceived.reduce((sum, val) => sum + val, 0);
            
            // Update pie chart data
            charts.nightCashFlowPie.data.datasets[0].data = [cashTotal, tngTotal, grabTotal, shopeeTotal];
            charts.nightCashFlowPie.update();
            
            updateChartControls('nightCashFlowPieChart', period);
        }

        // ============ END NIGHT SHIFT CHART FUNCTIONS ============

        function getChartData(period) {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            const days = parseInt(period.replace('days', ''));
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - (days - 1) * 24 * 60 * 60 * 1000);
            
            const filteredData = savedData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = filteredData.map(entry => {
                const date = new Date(entry.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            return {
                labels: labels,
                cigaretteSales: filteredData.map(entry => parseFloat(entry.cigaretteSales || 0)),
                rentalCollection: filteredData.map(entry => parseFloat(entry.rentalCollection || 0)),
                coffeeSales: filteredData.map(entry => parseFloat(entry.coffeeSales || 0)),
                beerSales: filteredData.map(entry => parseFloat(entry.beerSales || 0)),
                expenses: filteredData.map(entry => parseFloat(entry.totalExpenses || 0)),
                bankExpenses: filteredData.map(entry => parseFloat(entry.totalBankExpenses || 0)),
                salary: filteredData.map(entry => parseFloat(entry.totalSalary || 0)),
                cashReceived: filteredData.map(entry => parseFloat(entry.cashReceived || 0)),
                tngReceived: filteredData.map(entry => parseFloat(entry.tngReceived || 0)),
                grabReceived: filteredData.map(entry => parseFloat(entry.grabReceived || 0)),
                shopeeReceived: filteredData.map(entry => parseFloat(entry.shopeeReceived || 0)),
                totalSales: filteredData.map(entry => parseFloat(entry.salesToday || 0)),
                totalExpenses: filteredData.map(entry => {
                    const expenses = parseFloat(entry.totalExpenses || 0);
                    const bankExpenses = parseFloat(entry.totalBankExpenses || 0);
                    const salary = parseFloat(entry.totalSalary || 0);
                    return expenses + bankExpenses + salary;
                }),
                netProfit: filteredData.map(entry => {
                    const sales = parseFloat(entry.salesToday || 0);
                    const expenses = parseFloat(entry.totalExpenses || 0);
                    const bankExpenses = parseFloat(entry.totalBankExpenses || 0);
                    const salary = parseFloat(entry.totalSalary || 0);
                    return sales - (expenses + bankExpenses + salary);
                })
            };
        }

        function getSalaryChartData(period) {
            // Use Firestore data (dailyFinanceData) with localStorage as fallback
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            const days = parseInt(period.replace('days', ''));
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - (days - 1) * 24 * 60 * 60 * 1000);
            
            const filteredData = savedData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            });

            // Aggregate salary data
            const salaryTotals = {};
            filteredData.forEach(entry => {
                if (entry.salaries) {
                    entry.salaries.forEach(salary => {
                        if (salary.name && salary.amount) {
                            salaryTotals[salary.name] = (salaryTotals[salary.name] || 0) + parseFloat(salary.amount);
                        }
                    });
                }
            });

            const labels = Object.keys(salaryTotals);
            const values = Object.values(salaryTotals);

            return { labels, values };
        }

        // Report Generation Functions
        function generateDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            // Use Firestore data instead of localStorage
            const todayData = dailyFinanceData.filter(entry => entry.date === today);
            
            if (todayData.length === 0) {
                // Show message when no data exists instead of sample data
                const noDataMessage = `
                    <div class="no-data-message">
                        <h3>üìä Daily Report - ${formatDate(today)}</h3>
                        <div class="alert alert-info">
                            <h4>üìù No Data Available</h4>
                            <p>No financial data has been recorded for today (${formatDate(today)}).</p>
                            <p>Please enter your daily financial data in the main form to generate reports.</p>
                            <button class="btn btn-primary" onclick="showMainPage(event)">Go to Data Entry</button>
                        </div>
                    </div>
                `;
                displayReport('Daily Report - ' + formatDate(today), noDataMessage);
                return;
            }

            const reportData = todayData[0];
            displayReport('Daily Report - ' + formatDate(today), generateDailyReportContent(reportData));
        }

        function generateWeeklyReport() {
            // Use Firestore data instead of localStorage
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 6 * 24 * 60 * 60 * 1000);
            
            const weekData = dailyFinanceData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (weekData.length === 0) {
                // Show message when no data exists instead of sample data
                const noDataMessage = `
                    <div class="no-data-message">
                        <h3>üìä Weekly Report - ${formatDate(startDate.toISOString().split('T')[0])} to ${formatDate(endDate.toISOString().split('T')[0])}</h3>
                        <div class="alert alert-info">
                            <h4>üìù No Data Available</h4>
                            <p>No financial data has been recorded for this week.</p>
                            <p>Please enter your daily financial data in the main form to generate reports.</p>
                            <button class="btn btn-primary" onclick="showMainPage(event)">Go to Data Entry</button>
                        </div>
                    </div>
                `;
                displayReport('Weekly Report - ' + formatDate(startDate.toISOString().split('T')[0]) + ' to ' + formatDate(endDate.toISOString().split('T')[0]), noDataMessage);
                return;
            }

            displayReport('Weekly Report - ' + formatDate(startDate.toISOString().split('T')[0]) + ' to ' + formatDate(endDate.toISOString().split('T')[0]), generateWeeklyReportContent(weekData));
        }

        function generateMonthlyReport() {
            // Use Firestore data instead of localStorage
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const monthData = dailyFinanceData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startOfMonth && entryDate <= today;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (monthData.length === 0) {
                // Show message when no data exists instead of sample data
                const noDataMessage = `
                    <div class="no-data-message">
                        <h3>üìä Monthly Report - ${today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                        <div class="alert alert-info">
                            <h4>üìù No Data Available</h4>
                            <p>No financial data has been recorded for this month.</p>
                            <p>Please enter your daily financial data in the main form to generate reports.</p>
                            <button class="btn btn-primary" onclick="showMainPage(event)">Go to Data Entry</button>
                        </div>
                    </div>
                `;
                displayReport('Monthly Report - ' + today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }), noDataMessage);
                return;
            }

            displayReport('Monthly Report - ' + today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }), generateMonthlyReportContent(monthData));
        }

        function generate30DaysReport() {
            // Use Firestore data instead of localStorage
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 29 * 24 * 60 * 60 * 1000); // Past 30 days (including today)
            
            const days30Data = dailyFinanceData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (days30Data.length === 0) {
                const noDataMessage = `
                    <div class="no-data-message">
                        <h3>üìä 30 Days Report - ${formatDate(startDate.toISOString().split('T')[0])} to ${formatDate(endDate.toISOString().split('T')[0])}</h3>
                        <div class="alert alert-info">
                            <h4>üìù No Data Available</h4>
                            <p>No financial data has been recorded for the past 30 days.</p>
                            <p>Start recording your daily finances to generate reports.</p>
                            <button class="btn btn-primary" onclick="showMainPage(event)">Go to Data Entry</button>
                        </div>
                    </div>
                `;
                displayReport('30 Days Report - ' + formatDate(startDate.toISOString().split('T')[0]) + ' to ' + formatDate(endDate.toISOString().split('T')[0]), noDataMessage);
                return;
            }
            
            displayReport('30 Days Report - ' + formatDate(startDate.toISOString().split('T')[0]) + ' to ' + formatDate(endDate.toISOString().split('T')[0]), generate30DaysReportContent(days30Data));
        }

        function generate90DaysReport() {
            // Use Firestore data instead of localStorage
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 89 * 24 * 60 * 60 * 1000); // Past 90 days (including today)
            
            const days90Data = dailyFinanceData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (days90Data.length === 0) {
                const noDataMessage = `
                    <div class="no-data-message">
                        <h3>üìä 90 Days Report - ${formatDate(startDate.toISOString().split('T')[0])} to ${formatDate(endDate.toISOString().split('T')[0])}</h3>
                        <div class="alert alert-info">
                            <h4>üìù No Data Available</h4>
                            <p>No financial data has been recorded for the past 90 days.</p>
                            <p>Start recording your daily finances to generate reports.</p>
                            <button class="btn btn-primary" onclick="showMainPage(event)">Go to Data Entry</button>
                        </div>
                    </div>
                `;
                displayReport('90 Days Report - ' + formatDate(startDate.toISOString().split('T')[0]) + ' to ' + formatDate(endDate.toISOString().split('T')[0]), noDataMessage);
                return;
            }
            
            displayReport('90 Days Report - ' + formatDate(startDate.toISOString().split('T')[0]) + ' to ' + formatDate(endDate.toISOString().split('T')[0]), generate90DaysReportContent(days90Data));
        }

        function generateCustomReport() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Custom Report</h2>
                    <div class="date-picker">
                        <label>From Date:</label>
                        <input type="date" id="customStartDate" value="${new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                    </div>
                    <div class="date-picker">
                        <label>To Date:</label>
                        <input type="date" id="customEndDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button onclick="generateCustomReportFromDates()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Generate Report</button>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateCustomReportFromDates() {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be later than end date.');
                return;
            }

            // Use Firestore data (dailyFinanceData) instead of localStorage
            const savedData = dailyFinanceData.length > 0 
                ? dailyFinanceData 
                : JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
            
            console.log('üîç Custom Report Debug:');
            console.log('  Start Date:', startDate);
            console.log('  End Date:', endDate);
            console.log('  Total records in database:', savedData.length);
            console.log('  Sample records (first 3):', savedData.slice(0, 3).map(d => ({ date: d.date, sales: d.salesToday })));
            
            // Normalize dates to YYYY-MM-DD format for comparison (remove time component)
            const startDateNormalized = startDate; // Already in YYYY-MM-DD format
            const endDateNormalized = endDate; // Already in YYYY-MM-DD format
            
            const customData = savedData.filter(entry => {
                if (!entry.date) return false;
                
                // Compare date strings directly (YYYY-MM-DD format)
                const entryDateStr = entry.date; // Should be in YYYY-MM-DD format
                
                // If entry.date is in a different format, parse it
                let entryDateNormalized = entryDateStr;
                if (entryDateStr && entryDateStr.includes('T')) {
                    // Handle ISO date strings (e.g., "2025-10-01T00:00:00.000Z")
                    entryDateNormalized = entryDateStr.split('T')[0];
                } else if (entryDateStr && entryDateStr.includes('/')) {
                    // Handle date strings like "MM/DD/YYYY"
                    const parts = entryDateStr.split('/');
                    if (parts.length === 3) {
                        const year = parts[2];
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        entryDateNormalized = `${year}-${month}-${day}`;
                    }
                }
                
                // Compare as strings (YYYY-MM-DD format allows string comparison)
                const isInRange = entryDateNormalized >= startDateNormalized && entryDateNormalized <= endDateNormalized;
                
                return isInRange;
            }).sort((a, b) => {
                // Sort by date
                const dateA = a.date?.split('T')[0] || a.date || '';
                const dateB = b.date?.split('T')[0] || b.date || '';
                return dateA.localeCompare(dateB);
            });
            
            console.log('  Records found in date range:', customData.length);
            if (customData.length > 0) {
                console.log('  Sample filtered records:', customData.slice(0, 3).map(d => ({ date: d.date, sales: d.salesToday })));
            }

            // Close the modal
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();

            if (customData.length === 0) {
                const noDataMessage = `
                    <div class="no-data-message">
                        <h3>üìä Custom Report - ${formatDate(startDate)} to ${formatDate(endDate)}</h3>
                        <div class="alert alert-info">
                            <h4>üìù No Data Available</h4>
                            <p>No financial data has been recorded for the selected date range.</p>
                            <p>Date Range: ${formatDate(startDate)} to ${formatDate(endDate)}</p>
                            <button class="btn btn-primary" onclick="showMainPage(event)">Go to Data Entry</button>
                        </div>
                    </div>
                `;
                displayReport('Custom Report - ' + formatDate(startDate) + ' to ' + formatDate(endDate), noDataMessage);
                return;
            }
            
            displayReport('Custom Report - ' + formatDate(startDate) + ' to ' + formatDate(endDate), generateCustomReportContent(customData));
        }

        function displayReport(title, content) {
            // Show loading state
            document.getElementById('reportTitle').textContent = 'Generating Report...';
            document.getElementById('reportContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 20px; color: #666;">Generating report...</p></div>';
            document.getElementById('reportDisplay').style.display = 'block';
            
            // Scroll to report
            document.getElementById('reportDisplay').scrollIntoView({ behavior: 'smooth' });
            
            // Simulate processing time and then show actual content
            setTimeout(() => {
                document.getElementById('reportTitle').textContent = title;
                document.getElementById('reportContent').innerHTML = content;
            }, 500);
        }

        function generateDailyReportContent(data) {
            const totalSales = parseFloat(data.salesToday || 0);
            const totalExpenses = parseFloat(data.totalExpenses || 0) + parseFloat(data.totalBankExpenses || 0) + parseFloat(data.totalSalary || 0);
            const netProfit = totalSales - totalExpenses;

            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Expenses</h4>
                        <div class="value">RM ${totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Net Profit</h4>
                        <div class="value" style="color: ${netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${netProfit.toFixed(2)}</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üí∞ Sales Breakdown</h3>
                    <table class="report-table">
                        <tr><th>Category</th><th>Amount</th></tr>
                        <tr><td>Cigarette Sales</td><td>RM ${parseFloat(data.cigaretteSales || 0).toFixed(2)}</td></tr>
                        <tr><td>Rental Collection</td><td>RM ${parseFloat(data.rentalCollection || 0).toFixed(2)}</td></tr>
                        <tr><td>Coffee Sales</td><td>RM ${parseFloat(data.coffeeSales || 0).toFixed(2)}</td></tr>
                        <tr><td>Beer Sales</td><td>RM ${parseFloat(data.beerSales || 0).toFixed(2)}</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>üí∏ Expenses Breakdown</h3>
                    <table class="report-table">
                        <tr><th>Category</th><th>Amount</th></tr>
                        <tr><td>Regular Expenses</td><td>RM ${parseFloat(data.totalExpenses || 0).toFixed(2)}</td></tr>
                        <tr><td>Bank Expenses</td><td>RM ${parseFloat(data.totalBankExpenses || 0).toFixed(2)}</td></tr>
                        <tr><td>Salary</td><td>RM ${parseFloat(data.totalSalary || 0).toFixed(2)}</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>üíµ Cash Flow</h3>
                    <table class="report-table">
                        <tr><th>Source</th><th>Amount</th></tr>
                        <tr><td>Cash Received</td><td>RM ${parseFloat(data.cashReceived || 0).toFixed(2)}</td></tr>
                        <tr><td>TNG Received</td><td>RM ${parseFloat(data.tngReceived || 0).toFixed(2)}</td></tr>
                        <tr><td>Grab Received</td><td>RM ${parseFloat(data.grabReceived || 0).toFixed(2)}</td></tr>
                        <tr><td>Shopee Received</td><td>RM ${parseFloat(data.shopeeReceived || 0).toFixed(2)}</td></tr>
                    </table>
                </div>
            `;
        }

        function generateWeeklyReportContent(weekData) {
            const totals = calculatePeriodTotals(weekData);
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Expenses</h4>
                        <div class="value">RM ${totals.totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Net Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily</h4>
                        <div class="value">RM ${(totals.netProfit / weekData.length).toFixed(2)}</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üìÖ Daily Breakdown</h3>
                    <table class="report-table">
                        <tr><th>Date</th><th>Sales</th><th>Expenses</th><th>Profit</th></tr>
                        ${weekData.map(day => {
                            const sales = parseFloat(day.salesToday || 0);
                            const expenses = parseFloat(day.totalExpenses || 0) + parseFloat(day.totalBankExpenses || 0) + parseFloat(day.totalSalary || 0);
                            const profit = sales - expenses;
                            return `<tr>
                                <td>${formatDate(day.date)}</td>
                                <td>RM ${sales.toFixed(2)}</td>
                                <td>RM ${expenses.toFixed(2)}</td>
                                <td style="color: ${profit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${profit.toFixed(2)}</td>
                            </tr>`;
                        }).join('')}
                        <tr style="font-weight: bold; background-color: #f8f9fa;">
                            <td>Total</td>
                            <td>RM ${totals.totalSales.toFixed(2)}</td>
                            <td>RM ${totals.totalExpenses.toFixed(2)}</td>
                            <td style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>üìä Weekly Summary</h3>
                    <table class="report-table">
                        <tr><th>Category</th><th>Total</th><th>Average</th></tr>
                        <tr><td>Cigarette Sales</td><td>RM ${totals.cigaretteSales.toFixed(2)}</td><td>RM ${(totals.cigaretteSales / weekData.length).toFixed(2)}</td></tr>
                        <tr><td>Rental Collection</td><td>RM ${totals.rentalCollection.toFixed(2)}</td><td>RM ${(totals.rentalCollection / weekData.length).toFixed(2)}</td></tr>
                        <tr><td>Coffee Sales</td><td>RM ${totals.coffeeSales.toFixed(2)}</td><td>RM ${(totals.coffeeSales / weekData.length).toFixed(2)}</td></tr>
                        <tr><td>Beer Sales</td><td>RM ${totals.beerSales.toFixed(2)}</td><td>RM ${(totals.beerSales / weekData.length).toFixed(2)}</td></tr>
                        <tr><td>Regular Expenses</td><td>RM ${totals.expenses.toFixed(2)}</td><td>RM ${(totals.expenses / weekData.length).toFixed(2)}</td></tr>
                        <tr><td>Bank Expenses</td><td>RM ${totals.bankExpenses.toFixed(2)}</td><td>RM ${(totals.bankExpenses / weekData.length).toFixed(2)}</td></tr>
                        <tr><td>Salary</td><td>RM ${totals.salary.toFixed(2)}</td><td>RM ${(totals.salary / weekData.length).toFixed(2)}</td></tr>
                    </table>
                </div>
            `;
        }

        function generateMonthlyReportContent(monthData) {
            const totals = calculatePeriodTotals(monthData);
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Expenses</h4>
                        <div class="value">RM ${totals.totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Net Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily</h4>
                        <div class="value">RM ${(totals.netProfit / monthData.length).toFixed(2)}</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üìÖ Daily Performance</h3>
                    <table class="report-table">
                        <tr><th>Date</th><th>Sales</th><th>Expenses</th><th>Profit</th></tr>
                        ${monthData.map(day => {
                            const sales = parseFloat(day.salesToday || 0);
                            const expenses = parseFloat(day.totalExpenses || 0) + parseFloat(day.totalBankExpenses || 0) + parseFloat(day.totalSalary || 0);
                            const profit = sales - expenses;
                            return `<tr>
                                <td>${formatDate(day.date)}</td>
                                <td>RM ${sales.toFixed(2)}</td>
                                <td>RM ${expenses.toFixed(2)}</td>
                                <td style="color: ${profit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${profit.toFixed(2)}</td>
                            </tr>`;
                        }).join('')}
                        <tr style="font-weight: bold; background-color: #f8f9fa;">
                            <td>Total</td>
                            <td>RM ${totals.totalSales.toFixed(2)}</td>
                            <td>RM ${totals.totalExpenses.toFixed(2)}</td>
                            <td style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>üìä Monthly Summary</h3>
                    <table class="report-table">
                        <tr><th>Category</th><th>Total</th><th>Average</th><th>Best Day</th><th>Worst Day</th></tr>
                        <tr><td>Cigarette Sales</td><td>RM ${totals.cigaretteSales.toFixed(2)}</td><td>RM ${(totals.cigaretteSales / monthData.length).toFixed(2)}</td><td>RM ${Math.max(...monthData.map(d => parseFloat(d.cigaretteSales || 0))).toFixed(2)}</td><td>RM ${Math.min(...monthData.map(d => parseFloat(d.cigaretteSales || 0))).toFixed(2)}</td></tr>
                        <tr><td>Rental Collection</td><td>RM ${totals.rentalCollection.toFixed(2)}</td><td>RM ${(totals.rentalCollection / monthData.length).toFixed(2)}</td><td>RM ${Math.max(...monthData.map(d => parseFloat(d.rentalCollection || 0))).toFixed(2)}</td><td>RM ${Math.min(...monthData.map(d => parseFloat(d.rentalCollection || 0))).toFixed(2)}</td></tr>
                        <tr><td>Coffee Sales</td><td>RM ${totals.coffeeSales.toFixed(2)}</td><td>RM ${(totals.coffeeSales / monthData.length).toFixed(2)}</td><td>RM ${Math.max(...monthData.map(d => parseFloat(d.coffeeSales || 0))).toFixed(2)}</td><td>RM ${Math.min(...monthData.map(d => parseFloat(d.coffeeSales || 0))).toFixed(2)}</td></tr>
                        <tr><td>Beer Sales</td><td>RM ${totals.beerSales.toFixed(2)}</td><td>RM ${(totals.beerSales / monthData.length).toFixed(2)}</td><td>RM ${Math.max(...monthData.map(d => parseFloat(d.beerSales || 0))).toFixed(2)}</td><td>RM ${Math.min(...monthData.map(d => parseFloat(d.beerSales || 0))).toFixed(2)}</td></tr>
                    </table>
                </div>
            `;
        }

        function generate30DaysReportContent(days30Data) {
            const totals = calculatePeriodTotals(days30Data);
            const daysCount = days30Data.length || 1; // Prevent division by zero
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Expenses</h4>
                        <div class="value">RM ${totals.totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Net Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Days Recorded</h4>
                        <div class="value">${days30Data.length}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Sales</h4>
                        <div class="value">RM ${(totals.totalSales / daysCount).toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${(totals.netProfit / daysCount).toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>üìä 30 Days Summary</h3>
                    <table class="report-table">
                        <tr>
                            <th>Category</th>
                            <th>Total</th>
                            <th>Average per Day</th>
                        </tr>
                        <tr>
                            <td>Cigarette Sales</td>
                            <td>RM ${totals.cigaretteSales.toFixed(2)}</td>
                            <td>RM ${(totals.cigaretteSales / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Rental Collection</td>
                            <td>RM ${totals.rentalCollection.toFixed(2)}</td>
                            <td>RM ${(totals.rentalCollection / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Coffee Sales</td>
                            <td>RM ${totals.coffeeSales.toFixed(2)}</td>
                            <td>RM ${(totals.coffeeSales / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Regular Expenses</td>
                            <td>RM ${totals.expenses.toFixed(2)}</td>
                            <td>RM ${(totals.expenses / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Bank Expenses</td>
                            <td>RM ${totals.bankExpenses.toFixed(2)}</td>
                            <td>RM ${(totals.bankExpenses / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Salary</td>
                            <td>RM ${totals.salary.toFixed(2)}</td>
                            <td>RM ${(totals.salary / daysCount).toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generate90DaysReportContent(days90Data) {
            const totals = calculatePeriodTotals(days90Data);
            const daysCount = days90Data.length || 1; // Prevent division by zero
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Expenses</h4>
                        <div class="value">RM ${totals.totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Net Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Days Recorded</h4>
                        <div class="value">${days90Data.length}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Sales</h4>
                        <div class="value">RM ${(totals.totalSales / daysCount).toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${(totals.netProfit / daysCount).toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>üìä 90 Days Summary</h3>
                    <table class="report-table">
                        <tr>
                            <th>Category</th>
                            <th>Total</th>
                            <th>Average per Day</th>
                        </tr>
                        <tr>
                            <td>Cigarette Sales</td>
                            <td>RM ${totals.cigaretteSales.toFixed(2)}</td>
                            <td>RM ${(totals.cigaretteSales / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Rental Collection</td>
                            <td>RM ${totals.rentalCollection.toFixed(2)}</td>
                            <td>RM ${(totals.rentalCollection / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Coffee Sales</td>
                            <td>RM ${totals.coffeeSales.toFixed(2)}</td>
                            <td>RM ${(totals.coffeeSales / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Regular Expenses</td>
                            <td>RM ${totals.expenses.toFixed(2)}</td>
                            <td>RM ${(totals.expenses / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Bank Expenses</td>
                            <td>RM ${totals.bankExpenses.toFixed(2)}</td>
                            <td>RM ${(totals.bankExpenses / daysCount).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Salary</td>
                            <td>RM ${totals.salary.toFixed(2)}</td>
                            <td>RM ${(totals.salary / daysCount).toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generateCustomReportContent(customData) {
            const totals = calculatePeriodTotals(customData);
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Expenses</h4>
                        <div class="value">RM ${totals.totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Net Profit</h4>
                        <div class="value" style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily</h4>
                        <div class="value">RM ${(totals.netProfit / customData.length).toFixed(2)}</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üìÖ Daily Breakdown</h3>
                    <table class="report-table">
                        <tr><th>Date</th><th>Sales</th><th>Expenses</th><th>Profit</th></tr>
                        ${customData.map(day => {
                            const sales = parseFloat(day.salesToday || 0);
                            const expenses = parseFloat(day.totalExpenses || 0) + parseFloat(day.totalBankExpenses || 0) + parseFloat(day.totalSalary || 0);
                            const profit = sales - expenses;
                            return `<tr>
                                <td>${formatDate(day.date)}</td>
                                <td>RM ${sales.toFixed(2)}</td>
                                <td>RM ${expenses.toFixed(2)}</td>
                                <td style="color: ${profit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${profit.toFixed(2)}</td>
                            </tr>`;
                        }).join('')}
                        <tr style="font-weight: bold; background-color: #f8f9fa;">
                            <td>Total</td>
                            <td>RM ${totals.totalSales.toFixed(2)}</td>
                            <td>RM ${totals.totalExpenses.toFixed(2)}</td>
                            <td style="color: ${totals.netProfit >= 0 ? '#27ae60' : '#e74c3c'}">RM ${totals.netProfit.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>üìä Period Summary</h3>
                    <table class="report-table">
                        <tr><th>Category</th><th>Total</th><th>Average</th></tr>
                        <tr><td>Cigarette Sales</td><td>RM ${totals.cigaretteSales.toFixed(2)}</td><td>RM ${(totals.cigaretteSales / customData.length).toFixed(2)}</td></tr>
                        <tr><td>Rental Collection</td><td>RM ${totals.rentalCollection.toFixed(2)}</td><td>RM ${(totals.rentalCollection / customData.length).toFixed(2)}</td></tr>
                        <tr><td>Coffee Sales</td><td>RM ${totals.coffeeSales.toFixed(2)}</td><td>RM ${(totals.coffeeSales / customData.length).toFixed(2)}</td></tr>
                        <tr><td>Beer Sales</td><td>RM ${totals.beerSales.toFixed(2)}</td><td>RM ${(totals.beerSales / customData.length).toFixed(2)}</td></tr>
                        <tr><td>Regular Expenses</td><td>RM ${totals.expenses.toFixed(2)}</td><td>RM ${(totals.expenses / customData.length).toFixed(2)}</td></tr>
                        <tr><td>Bank Expenses</td><td>RM ${totals.bankExpenses.toFixed(2)}</td><td>RM ${(totals.bankExpenses / customData.length).toFixed(2)}</td></tr>
                        <tr><td>Salary</td><td>RM ${totals.salary.toFixed(2)}</td><td>RM ${(totals.salary / customData.length).toFixed(2)}</td></tr>
                    </table>
                </div>
            `;
        }

        function calculatePeriodTotals(data) {
            return data.reduce((totals, day) => {
                totals.totalSales += parseFloat(day.salesToday || 0);
                totals.cigaretteSales += parseFloat(day.cigaretteSales || 0);
                totals.rentalCollection += parseFloat(day.rentalCollection || 0);
                totals.coffeeSales += parseFloat(day.coffeeSales || 0);
                totals.beerSales += parseFloat(day.beerSales || 0);
                totals.expenses += parseFloat(day.totalExpenses || 0);
                totals.bankExpenses += parseFloat(day.totalBankExpenses || 0);
                totals.salary += parseFloat(day.totalSalary || 0);
                return totals;
            }, {
                totalSales: 0,
                cigaretteSales: 0,
                rentalCollection: 0,
                coffeeSales: 0,
                beerSales: 0,
                expenses: 0,
                bankExpenses: 0,
                salary: 0,
                get totalExpenses() { return this.expenses + this.bankExpenses + this.salary; },
                get netProfit() { return this.totalSales - this.totalExpenses; }
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function exportReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            const reportTitle = document.getElementById('reportTitle').textContent;
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
                        .report-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db; }
                        .report-card h4 { margin: 0 0 10px 0; color: #2c3e50; font-size: 14px; text-transform: uppercase; }
                        .report-card .value { font-size: 24px; font-weight: bold; color: #27ae60; }
                        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .report-table th, .report-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        .report-table th { background: #ecf0f1; font-weight: bold; color: #2c3e50; }
                        .report-section { margin-bottom: 25px; }
                        .report-section h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
                    </style>
                </head>
                <body>
                    <h1>${reportTitle}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    ${reportContent}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printReport() {
            const reportContent = document.getElementById('reportContent').innerHTML;
            const reportTitle = document.getElementById('reportTitle').textContent;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
                        .report-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db; }
                        .report-card h4 { margin: 0 0 10px 0; color: #2c3e50; font-size: 14px; text-transform: uppercase; }
                        .report-card .value { font-size: 24px; font-weight: bold; color: #27ae60; }
                        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .report-table th, .report-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        .report-table th { background: #ecf0f1; font-weight: bold; color: #2c3e50; }
                        .report-section { margin-bottom: 25px; }
                        .report-section h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>${reportTitle}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ============ NIGHT SHIFT REPORT FUNCTIONS ============
        
        function generateNightDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = nightShiftData.filter(entry => entry.date === today);
            
            if (todayData.length === 0) {
                alert('No night shift data found for today!');
                return;
            }
            
            const data = todayData[0];
            const content = generateNightDailyReportContent(data);
            
            document.getElementById('nightReportTitle').textContent = `üåô Night Shift Daily Report - ${formatDate(today)}`;
            document.getElementById('nightReportContent').innerHTML = content;
            document.getElementById('nightReportDisplay').style.display = 'block';
        }

        function generateNightWeeklyReport() {
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 6 * 24 * 60 * 60 * 1000);
            
            const weekData = nightShiftData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (weekData.length === 0) {
                alert('No night shift data found for the last 7 days!');
                return;
            }
            
            const content = generateNightWeeklyReportContent(weekData);
            const dateRange = `${formatDate(weekData[0].date)} to ${formatDate(weekData[weekData.length - 1].date)}`;
            
            document.getElementById('nightReportTitle').textContent = `üåô Night Shift Weekly Report - ${dateRange}`;
            document.getElementById('nightReportContent').innerHTML = content;
            document.getElementById('nightReportDisplay').style.display = 'block';
        }

        function generateNightMonthlyReport() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const monthData = nightShiftData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startOfMonth && entryDate <= today;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (monthData.length === 0) {
                alert('No night shift data found for this month!');
                return;
            }
            
            const content = generateNightMonthlyReportContent(monthData);
            const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            document.getElementById('nightReportTitle').textContent = `üåô Night Shift Monthly Report - ${monthName}`;
            document.getElementById('nightReportContent').innerHTML = content;
            document.getElementById('nightReportDisplay').style.display = 'block';
        }

        function generateNightCustomReport() {
            const startDate = prompt('Enter start date (YYYY-MM-DD):');
            const endDate = prompt('Enter end date (YYYY-MM-DD):');
            
            if (!startDate || !endDate) {
                return;
            }
            
            const customData = nightShiftData.filter(entry => {
                return entry.date >= startDate && entry.date <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (customData.length === 0) {
                alert('No night shift data found for the selected date range!');
                return;
            }
            
            const content = generateNightCustomReportContent(customData);
            const dateRange = `${formatDate(startDate)} to ${formatDate(endDate)}`;
            
            document.getElementById('nightReportTitle').textContent = `üåô Night Shift Custom Report - ${dateRange}`;
            document.getElementById('nightReportContent').innerHTML = content;
            document.getElementById('nightReportDisplay').style.display = 'block';
        }

        function generateNightDailyReportContent(data) {
            const totalSales = parseFloat(data.salesToday || 0);
            const cashReceived = parseFloat(data.cashReceived || 0);
            const tngReceived = parseFloat(data.tngReceived || 0);
            const totalReceived = parseFloat(data.totalCashReceived || 0) || (cashReceived + tngReceived);

            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Cash Received</h4>
                        <div class="value">RM ${cashReceived.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>TNG Received</h4>
                        <div class="value">RM ${tngReceived.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Received</h4>
                        <div class="value">RM ${totalReceived.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Sales Breakdown</h3>
                    <table class="report-table">
                        <tr>
                            <th>Category</th>
                            <th>Amount</th>
                        </tr>
                        <tr>
                            <td>Cigarette Sales</td>
                            <td>RM ${parseFloat(data.cigaretteSales || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Coffee Sales</td>
                            <td>RM ${parseFloat(data.coffeeSales || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Beer Sales</td>
                            <td>RM ${parseFloat(data.beerSales || 0).toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="report-section">
                    <h3>Payment Methods</h3>
                    <table class="report-table">
                        <tr>
                            <th>Payment Method</th>
                            <th>Amount</th>
                        </tr>
                        <tr>
                            <td>Cash</td>
                            <td>RM ${cashReceived.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>TNG</td>
                            <td>RM ${tngReceived.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generateNightWeeklyReportContent(weekData) {
            const totals = calculateNightPeriodTotals(weekData);
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Cash Received</h4>
                        <div class="value">RM ${totals.totalCashReceived.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Sales</h4>
                        <div class="value">RM ${totals.avgSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Days Recorded</h4>
                        <div class="value">${weekData.length}</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Daily Breakdown</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Sales</th>
                                <th>Cash</th>
                                <th>TNG</th>
                                <th>Total Received</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${weekData.map(entry => {
                                const cash = parseFloat(entry.cashReceived || 0);
                                const tng = parseFloat(entry.tngReceived || 0);
                                const total = cash + tng;
                                return `
                                    <tr>
                                        <td>${formatDate(entry.date)}</td>
                                        <td>RM ${parseFloat(entry.salesToday || 0).toFixed(2)}</td>
                                        <td>RM ${cash.toFixed(2)}</td>
                                        <td>RM ${tng.toFixed(2)}</td>
                                        <td>RM ${total.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateNightMonthlyReportContent(monthData) {
            const totals = calculateNightPeriodTotals(monthData);
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Cash Received</h4>
                        <div class="value">RM ${totals.totalCashReceived.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Sales</h4>
                        <div class="value">RM ${totals.avgSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Days Recorded</h4>
                        <div class="value">${monthData.length}</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Monthly Summary</h3>
                    <table class="report-table">
                        <tr>
                            <th>Category</th>
                            <th>Total</th>
                        </tr>
                        <tr>
                            <td>Cigarette Sales</td>
                            <td>RM ${totals.totalCigaretteSales.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Coffee Sales</td>
                            <td>RM ${totals.totalCoffeeSales.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Beer Sales</td>
                            <td>RM ${totals.totalBeerSales.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Cash Received</td>
                            <td>RM ${totals.totalCash.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>TNG Received</td>
                            <td>RM ${totals.totalTng.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generateNightCustomReportContent(customData) {
            const totals = calculateNightPeriodTotals(customData);
            
            return `
                <div class="report-summary">
                    <div class="report-card">
                        <h4>Total Sales</h4>
                        <div class="value">RM ${totals.totalSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Total Cash Received</h4>
                        <div class="value">RM ${totals.totalCashReceived.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Average Daily Sales</h4>
                        <div class="value">RM ${totals.avgSales.toFixed(2)}</div>
                    </div>
                    <div class="report-card">
                        <h4>Days Recorded</h4>
                        <div class="value">${customData.length}</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>Daily Breakdown</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Sales</th>
                                <th>Cash</th>
                                <th>TNG</th>
                                <th>Total Received</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customData.map(entry => {
                                const cash = parseFloat(entry.cashReceived || 0);
                                const tng = parseFloat(entry.tngReceived || 0);
                                const total = cash + tng;
                                return `
                                    <tr>
                                        <td>${formatDate(entry.date)}</td>
                                        <td>RM ${parseFloat(entry.salesToday || 0).toFixed(2)}</td>
                                        <td>RM ${cash.toFixed(2)}</td>
                                        <td>RM ${tng.toFixed(2)}</td>
                                        <td>RM ${total.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function calculateNightPeriodTotals(data) {
            const totals = {
                totalSales: 0,
                totalCigaretteSales: 0,
                totalCoffeeSales: 0,
                totalBeerSales: 0,
                totalCash: 0,
                totalTng: 0,
                totalGrab: 0,
                totalShopee: 0,
                totalCashReceived: 0
            };
            
            data.forEach(entry => {
                totals.totalSales += parseFloat(entry.salesToday || 0);
                totals.totalCigaretteSales += parseFloat(entry.cigaretteSales || 0);
                totals.totalCoffeeSales += parseFloat(entry.coffeeSales || 0);
                totals.totalBeerSales += parseFloat(entry.beerSales || 0);
                totals.totalCash += parseFloat(entry.cashReceived || 0);
                totals.totalTng += parseFloat(entry.tngReceived || 0);
                totals.totalGrab += parseFloat(entry.grabReceived || 0);
                totals.totalShopee += parseFloat(entry.shopeeReceived || 0);
                // Calculate totalCashReceived as Cash + TNG only
                const entryCash = parseFloat(entry.cashReceived || 0);
                const entryTng = parseFloat(entry.tngReceived || 0);
                totals.totalCashReceived += entryCash + entryTng;
            });
            
            totals.avgSales = data.length > 0 ? totals.totalSales / data.length : 0;
            
            return totals;
        }

        function exportNightReport() {
            const reportContent = document.getElementById('nightReportContent').innerHTML;
            const reportTitle = document.getElementById('nightReportTitle').textContent;
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
                        .report-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db; }
                        .report-card h4 { margin: 0 0 10px 0; color: #2c3e50; font-size: 14px; text-transform: uppercase; }
                        .report-card .value { font-size: 24px; font-weight: bold; color: #27ae60; }
                        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .report-table th, .report-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        .report-table th { background: #ecf0f1; font-weight: bold; color: #2c3e50; }
                        .report-section { margin-bottom: 25px; }
                        .report-section h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
                    </style>
                </head>
                <body>
                    <h1>${reportTitle}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    ${reportContent}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `night_shift_report_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Night shift report exported successfully!');
        }

        function printNightReport() {
            const reportContent = document.getElementById('nightReportContent').innerHTML;
            const reportTitle = document.getElementById('nightReportTitle').textContent;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
                        .report-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db; }
                        .report-card h4 { margin: 0 0 10px 0; color: #2c3e50; font-size: 14px; text-transform: uppercase; }
                        .report-card .value { font-size: 24px; font-weight: bold; color: #27ae60; }
                        .report-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .report-table th, .report-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        .report-table th { background: #ecf0f1; font-weight: bold; color: #2c3e50; }
                        .report-section { margin-bottom: 25px; }
                        .report-section h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>${reportTitle}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        // ============ END NIGHT SHIFT REPORT FUNCTIONS ============

        // Default cigarette products
        let cigaretteProducts = [
            { name: 'LD', price: 12 },
            { name: 'Rothman & Chest', price: 12.4 },
            { name: 'Terrar', price: 14 },
            { name: 'Peter', price: 16.2 },
            { name: 'Wiston', price: 15.9 },
            { name: 'Dunhill', price: 17.7 },
            { name: 'Mevius', price: 17.7 },
            { name: 'Marbolo', price: 17.4 }
        ];

        // Load cigarette products from Firestore/localStorage
        async function loadCigaretteProducts() {
            try {
                const { db, doc, getDoc } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;

                if (!user) {
                    console.log('User not authenticated, loading from localStorage');
                    // Use localStorage as fallback when not authenticated
                    const localProducts = localStorage.getItem('cigaretteProducts');
                    if (localProducts) {
                        try {
                            cigaretteProducts = JSON.parse(localProducts);
                            console.log('‚úÖ Cigarette products loaded from localStorage (not authenticated):', cigaretteProducts.length, 'products');
                        } catch (e) {
                            console.error('‚ùå Error parsing local cigarette products:', e);
                        }
                    }
                    updateCigaretteTable();
                    updateNightCigaretteTable();
                    return;
                }

                console.log('Loading cigarette products from Firestore for user:', user.uid);
                
                // Try to get the specific document directly (more efficient than querying collection)
                const settingsRef = doc(db, 'users', user.uid, 'settings', 'cigaretteProducts');
                const docSnapshot = await getDoc(settingsRef);
                
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    console.log('üìÑ Document found in Firestore:', data);
                    
                    if (data.products && Array.isArray(data.products) && data.products.length > 0) {
                        cigaretteProducts = data.products;
                        // Also save to localStorage as backup
                        localStorage.setItem('cigaretteProducts', JSON.stringify(cigaretteProducts));
                        console.log('‚úÖ Cigarette products loaded from Firestore:', cigaretteProducts.length, 'products');
                        console.log('Products:', cigaretteProducts.map(p => `${p.name} (RM ${p.price})`).join(', '));
                    } else {
                        console.warn('‚ö†Ô∏è Document exists but products array is invalid or empty');
                        // Try localStorage as fallback
                        const localProducts = localStorage.getItem('cigaretteProducts');
                        if (localProducts) {
                            try {
                                cigaretteProducts = JSON.parse(localProducts);
                                console.log('üì¶ Using localStorage fallback:', cigaretteProducts.length, 'products');
                            } catch (e) {
                                console.error('‚ùå Error parsing local cigarette products:', e);
                            }
                        }
                    }
                } else {
                    console.log('üì≠ Document does not exist in Firestore, trying localStorage');
                    // Try localStorage as fallback
                    const localProducts = localStorage.getItem('cigaretteProducts');
                    if (localProducts) {
                        try {
                            cigaretteProducts = JSON.parse(localProducts);
                            console.log('üì¶ Cigarette products loaded from localStorage (not found in Firestore):', cigaretteProducts.length, 'products');
                        } catch (e) {
                            console.error('‚ùå Error parsing local cigarette products:', e);
                        }
                    } else {
                        console.log('üì¶ No localStorage backup found, using default products');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading cigarette products from Firestore:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message
                });
                
                // Fallback to localStorage
                const localProducts = localStorage.getItem('cigaretteProducts');
                if (localProducts) {
                    try {
                        cigaretteProducts = JSON.parse(localProducts);
                        console.log('üì¶ Cigarette products loaded from localStorage (error fallback):', cigaretteProducts.length, 'products');
                    } catch (e) {
                        console.error('‚ùå Error parsing local cigarette products:', e);
                    }
                }
            }
            
            // Update both tables
            console.log('üîÑ Updating cigarette tables with', cigaretteProducts.length, 'products');
            updateCigaretteTable();
            updateNightCigaretteTable();
        }

        // Save cigarette products to Firestore/localStorage
        async function saveCigaretteProducts() {
            try {
                const { db, doc, setDoc } = window.firestoreDB;
                const { auth } = window.firebaseAuth;
                const user = auth.currentUser;

                if (!user) {
                    alert('Please login to save settings');
                    // Still save to localStorage as backup
                    localStorage.setItem('cigaretteProducts', JSON.stringify(cigaretteProducts));
                    return;
                }

                // Validate cigarette products array
                if (!Array.isArray(cigaretteProducts) || cigaretteProducts.length === 0) {
                    console.error('Invalid cigarette products array:', cigaretteProducts);
                    alert('Error: Invalid product list. Please add at least one product.');
                    return;
                }

                const settingsRef = doc(db, 'users', user.uid, 'settings', 'cigaretteProducts');
                const now = new Date().toISOString();
                
                const dataToSave = {
                    products: cigaretteProducts,
                    updatedAt: now,
                    createdAt: now
                };

                console.log('Saving cigarette products to Firestore:', {
                    path: `users/${user.uid}/settings/cigaretteProducts`,
                    productCount: cigaretteProducts.length,
                    products: cigaretteProducts
                });
                
                // Use setDoc with merge: true to create or update the document
                await setDoc(settingsRef, dataToSave, { merge: true });

                // Verify the save by reading it back
                const { getDoc } = window.firestoreDB;
                const verifyDoc = await getDoc(settingsRef);
                if (verifyDoc.exists()) {
                    const savedData = verifyDoc.data();
                    console.log('‚úÖ Verified save - Document exists in Firestore:', {
                        savedProductCount: savedData.products?.length || 0,
                        savedProducts: savedData.products
                    });
                } else {
                    console.warn('‚ö†Ô∏è Warning: Document not found after save');
                }

                // Also save to localStorage as backup
                localStorage.setItem('cigaretteProducts', JSON.stringify(cigaretteProducts));
                
                console.log('‚úÖ Cigarette products saved to Firestore successfully:', cigaretteProducts.length, 'products');
                
                // Update tables immediately after saving
                updateCigaretteTable();
                updateNightCigaretteTable();
                
                return true; // Return success
            } catch (error) {
                console.error('‚ùå Error saving cigarette products to Firestore:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                // Fallback to localStorage
                localStorage.setItem('cigaretteProducts', JSON.stringify(cigaretteProducts));
                console.log('Cigarette products saved to localStorage as backup');
                
                throw error; // Re-throw to let caller handle it
            }
        }

        // Update cigarette table dynamically
        function updateCigaretteTable() {
            const cigaretteTable = document.querySelector('.cigarette-table tbody');
            if (!cigaretteTable) return;

            // Update headers
            const headerRow = document.querySelector('.cigarette-table thead tr');
            headerRow.innerHTML = '<th></th>';
            cigaretteProducts.forEach(product => {
                headerRow.innerHTML += `<th>${product.name}</th>`;
            });

            // Update rows
            cigaretteTable.innerHTML = `
                <tr>
                    <td><strong>Default Price</strong></td>
                    ${cigaretteProducts.map(product => 
                        `<td><input type="number" value="${product.price}" readonly></td>`
                    ).join('')}
                </tr>
                <tr>
                    <td><strong>Sales of packs</strong></td>
                    ${cigaretteProducts.map(product => 
                        `<td><input type="number" class="cigarette-qty" data-price="${product.price}" placeholder="0"></td>`
                    ).join('')}
                </tr>
                <tr class="total-row">
                    <td><strong>Total:</strong></td>
                    <td colspan="${cigaretteProducts.length}"><input type="number" id="cigaretteTotal" readonly placeholder="0.00"></td>
                </tr>
            `;

            // Re-attach event listeners for calculation
            document.querySelectorAll('.cigarette-qty').forEach(input => {
                input.addEventListener('input', calculateAll);
            });
        }

        // Show cigarette products editor modal
        function editCigaretteProducts() {
            showCigaretteProductsModal();
        }

        function showCigaretteProductsModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="cigaretteProductsModal" class="products-modal">
                    <div class="products-modal-content">
                        <div class="products-modal-header">
                            <h2>üì¶ Edit Cigarette Products</h2>
                            <button class="close-modal-btn" onclick="closeCigaretteProductsModal()">&times;</button>
                        </div>
                        <div class="products-modal-body">
                            <div style="margin-bottom: 20px;">
                                <h3>Add New Product</h3>
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <input type="text" id="newProductName" placeholder="Product Name" class="form-control" style="flex: 2;">
                                    <input type="number" id="newProductPrice" placeholder="Price (RM)" class="form-control" step="0.01" style="flex: 1;">
                                    <button class="btn btn-success" onclick="addCigaretteProduct()">+ Add</button>
                                </div>
                            </div>
                            
                            <div>
                                <h3>Current Products</h3>
                                <div id="cigaretteProductsList"></div>
                            </div>
                        </div>
                        <div class="products-modal-footer">
                            <button class="btn btn-primary" onclick="saveAndCloseCigaretteProductsModal()">Save & Close</button>
                            <button class="btn btn-secondary" onclick="closeCigaretteProductsModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv.firstElementChild);

            // Populate products list
            updateCigaretteProductsList();
        }

        function updateCigaretteProductsList() {
            const listDiv = document.getElementById('cigaretteProductsList');
            if (!listDiv) return;

            listDiv.innerHTML = cigaretteProducts.map((product, index) => `
                <div class="product-item">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="text" value="${product.name}" 
                            onchange="updateCigaretteProductName(${index}, this.value)" 
                            class="form-control" style="flex: 2;">
                        <input type="number" value="${product.price}" 
                            onchange="updateCigaretteProductPrice(${index}, this.value)" 
                            class="form-control" step="0.01" style="flex: 1;">
                        <button class="btn btn-danger" onclick="deleteCigaretteProduct(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addCigaretteProduct() {
            const nameInput = document.getElementById('newProductName');
            const priceInput = document.getElementById('newProductPrice');
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);

            if (!name) {
                alert('Please enter a product name');
                return;
            }

            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }

            // Check for duplicate names
            if (cigaretteProducts.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Product with this name already exists');
                return;
            }

            cigaretteProducts.push({ name, price });
            
            // Clear inputs
            nameInput.value = '';
            priceInput.value = '';

            updateCigaretteProductsList();
        }

        function updateCigaretteProductName(index, newName) {
            newName = newName.trim();
            if (!newName) {
                alert('Product name cannot be empty');
                updateCigaretteProductsList();
                return;
            }

            // Check for duplicate names (excluding current product)
            if (cigaretteProducts.some((p, i) => i !== index && p.name.toLowerCase() === newName.toLowerCase())) {
                alert('Product with this name already exists');
                updateCigaretteProductsList();
                return;
            }

            cigaretteProducts[index].name = newName;
        }

        function updateCigaretteProductPrice(index, newPrice) {
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                updateCigaretteProductsList();
                return;
            }

            cigaretteProducts[index].price = price;
        }

        function deleteCigaretteProduct(index) {
            if (cigaretteProducts.length <= 1) {
                alert('You must have at least one cigarette product');
                return;
            }

            if (confirm(`Delete ${cigaretteProducts[index].name}?`)) {
                cigaretteProducts.splice(index, 1);
                updateCigaretteProductsList();
            }
        }

        async function saveAndCloseCigaretteProductsModal() {
            try {
                await saveCigaretteProducts();
                
                // Force reload from Firestore to verify save
                await loadCigaretteProducts();
                
                updateCigaretteTable();
                closeCigaretteProductsModal();
                
                // Update the product settings display
                if (window.location.hash === '#settings') {
                    showProductSettingsSection();
                }
                
                alert('Cigarette products saved successfully and synced to Firestore!');
            } catch (error) {
                console.error('Error in saveAndCloseCigaretteProductsModal:', error);
                alert('Error saving cigarette products. Please check console for details.');
            }
        }

        function closeCigaretteProductsModal() {
            const modal = document.getElementById('cigaretteProductsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Placeholder functions for future implementation
        function editRentalProducts() { alert('Rental product editing feature coming soon!'); }
        function viewRentalAnalytics() { alert('Rental analytics feature coming soon!'); }
        function exportData() { alert('Data export feature coming soon!'); }
        function importData() { alert('Data import feature coming soon!'); }
        function backupData() { alert('Data backup feature coming soon!'); }
        function clearOldData() { alert('Data cleanup feature coming soon!'); }
        function resetAllData() { 
            if (confirm('Are you sure you want to reset ALL data? This cannot be undone!')) {
                localStorage.clear();
                alert('All data has been reset!');
            }
        }

        // Set today's date as default
        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

        // Initialize the page with default rows
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for Firestore to be ready
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Initialize history table
            await refreshHistoryTable();
            // Add initial rows
            addExpenseRow();
            addBankExpenseRow();
            addSalaryRow();
            
            // Load saved templates
            await loadTemplates();
            
            // Load cigarette products
            await loadCigaretteProducts();
            
            // Add event listeners
            setupEventListeners();
            
            // Initialize mobile support
            addMobileTouchSupport();
            resizeChartsForMobile();
            
            // Set up real-time listeners for cross-device sync
            await setupRealtimeListeners();
            
            // Initialize the total cash received calculation
            calculateCashReceived();
            
            console.log('Daily Finance Tracker initialized with Firestore and real-time sync');
        });

        // Clean up when page unloads
        window.addEventListener('beforeunload', cleanupRealtimeListeners);

        // Add expense row
        function addExpenseRow() {
            const tbody = document.getElementById('expensesTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="text" class="expense-input" placeholder="Enter expense name" list="expenseSuggestions">
                </td>
                <td>
                    <input type="number" class="amount-input expense-amount" placeholder="0.00" step="0.01">
                </td>
                <td>
                    <button class="btn-remove" onclick="removeRow(this)">√ó</button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listener for amount calculation
            const amountInput = row.querySelector('.expense-amount');
            amountInput.addEventListener('input', calculateExpenses);
        }

        // Add bank expense row
        function addBankExpenseRow() {
            const tbody = document.getElementById('bankExpensesTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="text" class="expense-input" placeholder="Enter bank expense name" list="bankExpenseSuggestions">
                </td>
                <td>
                    <input type="number" class="amount-input bank-expense" placeholder="0.00" step="0.01">
                </td>
                <td>
                    <button class="btn-remove" onclick="removeRow(this)">√ó</button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listener for amount calculation
            const amountInput = row.querySelector('.bank-expense');
            amountInput.addEventListener('input', calculateBankExpenses);
        }

        // Add salary row
        function addSalaryRow() {
            const tbody = document.getElementById('salaryTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="text" class="expense-input" placeholder="Enter salary name" list="salarySuggestions">
                </td>
                <td>
                    <input type="number" class="amount-input salary-amount" placeholder="0.00" step="0.01">
                </td>
                <td>
                    <button class="btn-remove" onclick="removeRow(this)">√ó</button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listener for amount calculation
            const amountInput = row.querySelector('.salary-amount');
            amountInput.addEventListener('input', calculateSalary);
        }

        // Remove row
        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
            
            // Recalculate totals
            calculateExpenses();
            calculateBankExpenses();
            calculateSalary();
        }

        // Calculate cigarette sales
        function calculateCigaretteSales() {
            const cigaretteInputs = document.querySelectorAll('.cigarette-qty');
            let total = 0;
            
            cigaretteInputs.forEach(input => {
                const qty = parseFloat(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                total += qty * price;
            });
            
            document.getElementById('cigaretteTotal').value = total.toFixed(2);
            document.getElementById('summaryCigaretteSales').textContent = total.toFixed(2);
            // When cigarette sales change, recalculate Coffee Sales (Sales Today stays the same)
            calculateCoffeeSales();
        }

        // Calculate rental collection
        function calculateRentalCollection() {
            const rentalInputs = document.querySelectorAll('.rental-days');
            let total = 0;
            
            rentalInputs.forEach(input => {
                const days = parseFloat(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                const rentalName = input.dataset.name;
                const rowTotal = days * price;
                
                // Update individual rental total
                const totalInput = document.querySelector(`.rental-total[data-name="${rentalName}"]`);
                if (totalInput) {
                    totalInput.value = rowTotal.toFixed(2);
                }
                
                total += rowTotal;
            });
            
            document.getElementById('rentalTotal').value = total.toFixed(2);
            document.getElementById('summaryRentalCollection').textContent = total.toFixed(2);
            // When rental collection changes, recalculate Coffee Sales (Sales Today stays the same)
            calculateCoffeeSales();
        }

        // Calculate beer sales
        function calculateBeerSales() {
            const beerBrands = ['carlsberg', 'tiger', 'guinness'];
            let totalBeerSales = 0;
            
            beerBrands.forEach(brand => {
                const priceInput = document.querySelector(`.beer-price[data-brand="${brand}"]`);
                const bottlesInput = document.querySelector(`.beer-bottles[data-brand="${brand}"]`);
                const totalInput = document.querySelector(`.beer-total[data-brand="${brand}"]`);
                
                if (priceInput && bottlesInput && totalInput) {
                    const price = parseFloat(priceInput.value) || 0;
                    const bottles = parseFloat(bottlesInput.value) || 0;
                    const total = price * bottles;
                    
                    totalInput.value = total.toFixed(2);
                    totalBeerSales += total;
                }
            });
            
            document.getElementById('beerTotal').value = totalBeerSales.toFixed(2);
            calculateSalesToday();
        }

        // Calculate expenses
        function calculateExpenses() {
            const expenseInputs = document.querySelectorAll('.expense-amount');
            let total = 0;
            
            expenseInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            const totalExpensesValue = total.toFixed(2);
            document.getElementById('totalExpenses').value = totalExpensesValue;
            
            // Automatically update "Expenses paid by Cash today" with the same value
            const cashExpensesEl = document.getElementById('cashExpenses');
            if (cashExpensesEl) {
                cashExpensesEl.textContent = totalExpensesValue;
            }
            
            // Trigger calculateCashReceived to update Sales Today and Coffee Sales
            calculateCashReceived();
        }

        // Calculate bank expenses
        function calculateBankExpenses() {
            const bankExpenseInputs = document.querySelectorAll('.bank-expense');
            let total = 0;
            
            bankExpenseInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalBankExpenses').value = total.toFixed(2);
        }

        // Calculate salary
        function calculateSalary() {
            const salaryInputs = document.querySelectorAll('.salary-amount');
            let total = 0;
            
            salaryInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            const totalSalaryValue = total.toFixed(2);
            document.getElementById('totalSalary').value = totalSalaryValue;
            
            // Automatically update "Salary/Gaji paid by cash today" with the same value
            const cashSalaryEl = document.getElementById('cashSalary');
            if (cashSalaryEl) {
                cashSalaryEl.textContent = totalSalaryValue;
            }
            
            // Trigger calculateCashReceived to update Sales Today and Coffee Sales
            calculateCashReceived();
        }

        // Calculate total sales today - NEW FORMULA: Cash Received + TNG Received + Expenses paid by Cash + Salary paid by cash + Grab Received + Shopee Received
        function calculateSalesToday() {
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const tngReceived = parseFloat(document.getElementById('tngReceived').value) || 0;
            // Get cashExpenses from span (read-only, auto-calculated from Expenses table)
            const cashExpensesEl = document.getElementById('cashExpenses');
            const cashExpenses = parseFloat(cashExpensesEl ? cashExpensesEl.textContent : 0) || 0;
            // Get cashSalary from span (read-only, auto-calculated from Salary/Gaji table)
            const cashSalaryEl = document.getElementById('cashSalary');
            const cashSalary = parseFloat(cashSalaryEl ? cashSalaryEl.textContent : 0) || 0;
            const grabReceived = parseFloat(document.getElementById('grabReceived').value) || 0;
            const shopeeReceived = parseFloat(document.getElementById('shopeeReceived').value) || 0;
            
            // Sales Today = Cash Received + TNG Received + Expenses paid by Cash today + Salary/Gaji paid by cash today + Grab Received + Shopee Received
            const totalSales = cashReceived + tngReceived + cashExpenses + cashSalary + grabReceived + shopeeReceived;
            document.getElementById('salesToday').textContent = totalSales.toFixed(2);
            
            // After Sales Today is updated, calculate Coffee Sales
            calculateCoffeeSales();
        }

        // Calculate Coffee Sales - NEW FORMULA: Sales Today - Cigarette Sales - Rental Collection
        function calculateCoffeeSales() {
            const salesToday = parseFloat(document.getElementById('salesToday').textContent) || 0;
            const cigaretteSales = parseFloat(document.getElementById('summaryCigaretteSales').textContent) || 0;
            const rentalCollection = parseFloat(document.getElementById('summaryRentalCollection').textContent) || 0;
            
            // Coffee Sales = Sales Today - Cigarette Sales - Rental Collection
            const coffeeSales = Math.max(0, salesToday - cigaretteSales - rentalCollection);
            const coffeeSalesInput = document.getElementById('coffeeSales');
            if (coffeeSalesInput) {
                coffeeSalesInput.value = coffeeSales.toFixed(2);
            }
        }

        function calculateCashReceived() {
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const tngReceived = parseFloat(document.getElementById('tngReceived').value) || 0;
            // Get cashExpenses from span (read-only, auto-calculated from Expenses table)
            const cashExpensesEl = document.getElementById('cashExpenses');
            const cashExpenses = parseFloat(cashExpensesEl ? cashExpensesEl.textContent : 0) || 0;
            // Get cashSalary from span (read-only, auto-calculated from Salary/Gaji table)
            const cashSalaryEl = document.getElementById('cashSalary');
            const cashSalary = parseFloat(cashSalaryEl ? cashSalaryEl.textContent : 0) || 0;
            const grabReceived = parseFloat(document.getElementById('grabReceived').value) || 0;
            const shopeeReceived = parseFloat(document.getElementById('shopeeReceived').value) || 0;
            
            const total = cashReceived + tngReceived + cashExpenses + cashSalary + grabReceived + shopeeReceived;
            document.getElementById('totalCashReceived').textContent = total.toFixed(2);
            
            // When cash inputs change, recalculate Sales Today and Coffee Sales
            calculateSalesToday();
        }

        // Calculate all totals
        function calculateAll() {
            calculateCigaretteSales();
            calculateRentalCollection();
            // calculateBeerSales(); // Removed - beer sales only in night section
            calculateExpenses();
            calculateBankExpenses();
            calculateSalary();
            calculateCashReceived(); // This will trigger calculateSalesToday() and calculateCoffeeSales()
        }

        // Save expense template
        async function saveExpenseTemplate(name) {
            if (name && !savedExpenses.find(exp => exp.name === name)) {
                try {
                    const templateData = { name: name };
                    await saveToFirestore(COLLECTIONS.EXPENSES, templateData);
                    
                    // Update local array
                    savedExpenses.push({ name: name });
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('savedExpenses', JSON.stringify(savedExpenses.map(exp => exp.name)));
                    
                    updateExpenseSuggestions();
                    console.log('Expense template saved to Firestore');
                } catch (error) {
                    console.error('Error saving expense template to Firestore:', error);
                    
                    // Fallback to localStorage
                    if (!savedExpenses.find(exp => exp.name === name)) {
                        savedExpenses.push({ name: name });
                        localStorage.setItem('savedExpenses', JSON.stringify(savedExpenses.map(exp => exp.name)));
                        updateExpenseSuggestions();
                    }
                }
            }
        }

        // Save salary template
        async function saveSalaryTemplate(name) {
            if (name && !savedSalaries.find(sal => sal.name === name)) {
                try {
                    const templateData = { name: name };
                    await saveToFirestore(COLLECTIONS.SALARIES, templateData);
                    
                    // Update local array
                    savedSalaries.push({ name: name });
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('savedSalaries', JSON.stringify(savedSalaries.map(sal => sal.name)));
                    
                    updateSalarySuggestions();
                    console.log('Salary template saved to Firestore');
                } catch (error) {
                    console.error('Error saving salary template to Firestore:', error);
                    
                    // Fallback to localStorage
                    if (!savedSalaries.find(sal => sal.name === name)) {
                        savedSalaries.push({ name: name });
                        localStorage.setItem('savedSalaries', JSON.stringify(savedSalaries.map(sal => sal.name)));
                        updateSalarySuggestions();
                    }
                }
            }
        }

        // Save bank expense template
        async function saveBankExpenseTemplate(name) {
            if (name && !savedBankExpenses.find(exp => exp.name === name)) {
                try {
                    const templateData = { name: name };
                    await saveToFirestore(COLLECTIONS.BANK_EXPENSES, templateData);
                    
                    // Update local array
                    savedBankExpenses.push({ name: name });
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('savedBankExpenses', JSON.stringify(savedBankExpenses.map(exp => exp.name)));
                    
                    updateBankExpenseSuggestions();
                    console.log('Bank expense template saved to Firestore');
                } catch (error) {
                    console.error('Error saving bank expense template to Firestore:', error);
                    
                    // Fallback to localStorage
                    if (!savedBankExpenses.find(exp => exp.name === name)) {
                        savedBankExpenses.push({ name: name });
                        localStorage.setItem('savedBankExpenses', JSON.stringify(savedBankExpenses.map(exp => exp.name)));
                        updateBankExpenseSuggestions();
                    }
                }
            }
        }

        // Update expense suggestions
        function updateExpenseSuggestions() {
            let datalist = document.getElementById('expenseSuggestions');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'expenseSuggestions';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            savedExpenses.forEach(expense => {
                const option = document.createElement('option');
                option.value = expense.name || expense;
                datalist.appendChild(option);
            });
        }

        // Update salary suggestions
        function updateSalarySuggestions() {
            let datalist = document.getElementById('salarySuggestions');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'salarySuggestions';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            savedSalaries.forEach(salary => {
                const option = document.createElement('option');
                option.value = salary.name || salary;
                datalist.appendChild(option);
            });
        }

        // Update bank expense suggestions
        function updateBankExpenseSuggestions() {
            let datalist = document.getElementById('bankExpenseSuggestions');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'bankExpenseSuggestions';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            savedBankExpenses.forEach(expense => {
                const option = document.createElement('option');
                option.value = expense.name || expense;
                datalist.appendChild(option);
            });
        }

        // ============ RENTAL TEMPLATES MANAGEMENT ============
        let savedRentals = [];

        async function addRentalTemplate() {
            const name = document.getElementById('newRentalName').value.trim();
            const price = document.getElementById('newRentalPrice').value;
            
            console.log('Adding rental:', { name, price });
            
            if (!name) {
                alert('Please enter a rental name');
                return;
            }
            
            if (!price || parseFloat(price) <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            try {
                const templateData = { 
                    name: name, 
                    price: parseFloat(price)
                };
                
                console.log('Saving template data:', templateData);
                console.log('Collection:', COLLECTIONS.RENTALS);
                
                await saveToFirestore(COLLECTIONS.RENTALS, templateData);
                console.log('Rental saved to Firestore successfully');
                
                // Clear input fields
                document.getElementById('newRentalName').value = '';
                document.getElementById('newRentalPrice').value = '';
                
                // Reload the list
                await loadRentalTemplates();
                
                // Update the main rental table
                updateRentalTable();
                
                alert('Rental added successfully!');
            } catch (error) {
                console.error('Error adding rental:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                alert(`Error adding rental: ${error.message || 'Please try again.'}`);
            }
        }

        function editRentalTemplate(id) {
            // Show edit inputs, hide display spans
            document.getElementById(`rental-name-display-${id}`).style.display = 'none';
            document.getElementById(`rental-name-edit-${id}`).style.display = 'inline';
            document.getElementById(`rental-price-display-${id}`).style.display = 'none';
            document.getElementById(`rental-price-edit-${id}`).style.display = 'inline';
            
            // Show save/cancel buttons, hide edit/delete buttons
            document.getElementById(`edit-btn-${id}`).style.display = 'none';
            document.getElementById(`delete-btn-${id}`).style.display = 'none';
            document.getElementById(`save-btn-${id}`).style.display = 'inline';
            document.getElementById(`cancel-btn-${id}`).style.display = 'inline';
        }

        function cancelEditRental(id) {
            // Find the rental to restore original values
            const rental = savedRentals.find(r => r.id === id);
            
            // Hide edit inputs, show display spans
            document.getElementById(`rental-name-display-${id}`).style.display = 'inline';
            document.getElementById(`rental-name-edit-${id}`).style.display = 'none';
            document.getElementById(`rental-price-display-${id}`).style.display = 'inline';
            document.getElementById(`rental-price-edit-${id}`).style.display = 'none';
            
            // Restore original values
            document.getElementById(`rental-name-edit-${id}`).value = rental.name;
            document.getElementById(`rental-price-edit-${id}`).value = rental.price;
            
            // Show edit/delete buttons, hide save/cancel buttons
            document.getElementById(`edit-btn-${id}`).style.display = 'inline';
            document.getElementById(`delete-btn-${id}`).style.display = 'inline';
            document.getElementById(`save-btn-${id}`).style.display = 'none';
            document.getElementById(`cancel-btn-${id}`).style.display = 'none';
        }

        async function saveRentalTemplate(id) {
            const newName = document.getElementById(`rental-name-edit-${id}`).value.trim();
            const newPrice = document.getElementById(`rental-price-edit-${id}`).value;
            
            if (!newName) {
                alert('Please enter a rental name');
                return;
            }
            
            if (!newPrice || parseFloat(newPrice) <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            try {
                // Find the rental
                const rental = savedRentals.find(r => r.id === id);
                if (!rental) {
                    alert('Rental not found');
                    return;
                }
                
                // Update the rental data
                const updatedData = {
                    name: newName,
                    price: parseFloat(newPrice)
                };
                
                // Update in Firestore
                await updateFirestoreDoc(COLLECTIONS.RENTALS, id, updatedData);
                
                // Update local array
                const index = savedRentals.findIndex(r => r.id === id);
                if (index !== -1) {
                    savedRentals[index] = { ...savedRentals[index], ...updatedData };
                }
                
                // Reload the list
                await loadRentalTemplates();
                
                // Update the main rental table
                updateRentalTable();
                
                alert('Rental updated successfully!');
            } catch (error) {
                console.error('Error saving rental:', error);
                alert('Error saving rental. Please try again.');
            }
        }

        async function removeRentalTemplate(id) {
            if (!confirm('Are you sure you want to delete this rental?')) {
                return;
            }
            
            try {
                await deleteFromFirestore(COLLECTIONS.RENTALS, id);
                
                // Remove from local array
                savedRentals = savedRentals.filter(rental => rental.id !== id);
                
                // Reload the list
                await loadRentalTemplates();
                
                // Update the main rental table
                updateRentalTable();
                
                alert('Rental deleted successfully!');
            } catch (error) {
                console.error('Error deleting rental:', error);
                alert('Error deleting rental. Please try again.');
            }
        }

        async function loadRentalTemplates() {
            try {
                // Load rentals without orderBy to avoid index issues
                const { getDocs, collection } = window.firestoreDB;
                const querySnapshot = await getDocs(collection(window.firestoreDB.db, COLLECTIONS.RENTALS));
                savedRentals = [];
                querySnapshot.forEach((doc) => {
                    savedRentals.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded rentals:', savedRentals.length);
                
                // Update the display
                updateRentalTemplatesList();
            } catch (error) {
                console.error('Error loading rental templates:', error);
                alert('Error loading rentals: ' + error.message);
            }
        }

        function updateRentalTemplatesList() {
            const listContainer = document.getElementById('rentalTemplatesList');
            if (!listContainer) return;
            
            if (savedRentals.length === 0) {
                listContainer.innerHTML = '<p>No rental collections configured yet.</p>';
                return;
            }
            
            let html = '<table class="table"><thead><tr><th>Rental Name</th><th>Price</th><th>Actions</th></tr></thead><tbody>';
            savedRentals.forEach(rental => {
                html += `
                    <tr id="rental-row-${rental.id}">
                        <td>
                            <span id="rental-name-display-${rental.id}">${rental.name || rental}</span>
                            <input type="text" id="rental-name-edit-${rental.id}" value="${rental.name || rental}" style="display:none;" class="form-control">
                        </td>
                        <td>
                            <span id="rental-price-display-${rental.id}">RM ${parseFloat(rental.price || 0).toFixed(2)}</span>
                            <input type="number" id="rental-price-edit-${rental.id}" value="${rental.price || 0}" step="0.01" style="display:none; width:100px;" class="form-control">
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editRentalTemplate('${rental.id}')" id="edit-btn-${rental.id}">Edit</button>
                            <button class="btn btn-success btn-sm" onclick="saveRentalTemplate('${rental.id}')" id="save-btn-${rental.id}" style="display:none;">Save</button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelEditRental('${rental.id}')" id="cancel-btn-${rental.id}" style="display:none;">Cancel</button>
                            <button class="btn btn-danger btn-sm" onclick="removeRentalTemplate('${rental.id}')" id="delete-btn-${rental.id}">Delete</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            
            listContainer.innerHTML = html;
        }

        function updateRentalTable() {
            const rentalTable = document.querySelector('.rental-table tbody');
            if (!rentalTable || savedRentals.length === 0) return;
            
            // Clear existing rental rows (but keep the total row)
            const totalRow = rentalTable.querySelector('.total-row');
            rentalTable.innerHTML = '';
            
            // Add rows for each rental
            savedRentals.forEach(rental => {
                const tr = document.createElement('tr');
                
                // Rental name
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<strong>${rental.name}</strong>`;
                tr.appendChild(nameCell);
                
                // Price per day (readonly)
                const priceCell = document.createElement('td');
                const priceInput = document.createElement('input');
                priceInput.type = 'number';
                priceInput.className = 'rental-price';
                priceInput.value = rental.price;
                priceInput.readOnly = true;
                priceInput.setAttribute('data-name', rental.id);
                priceCell.appendChild(priceInput);
                tr.appendChild(priceCell);
                
                // Days of collection
                const daysCell = document.createElement('td');
                const daysInput = document.createElement('input');
                daysInput.type = 'number';
                daysInput.className = 'rental-days';
                daysInput.value = '0';
                daysInput.min = '0';
                daysInput.step = '1';
                daysInput.setAttribute('data-price', rental.price);
                daysInput.setAttribute('data-name', rental.id);
                daysInput.placeholder = '0';
                daysInput.addEventListener('input', calculateRentalCollection);
                daysCell.appendChild(daysInput);
                tr.appendChild(daysCell);
                
                // Total
                const totalCell = document.createElement('td');
                const totalInput = document.createElement('input');
                totalInput.type = 'number';
                totalInput.className = 'rental-total';
                totalInput.readOnly = true;
                totalInput.setAttribute('data-name', rental.id);
                totalInput.placeholder = '0.00';
                totalCell.appendChild(totalInput);
                tr.appendChild(totalCell);
                
                rentalTable.appendChild(tr);
            });
            
            // Re-add the total row at the bottom
            if (totalRow) {
                rentalTable.appendChild(totalRow);
            }
            
            // Recalculate rental collection
            calculateRentalCollection();
        }
        // ============ END RENTAL TEMPLATES MANAGEMENT ============

        // Load templates
        async function loadTemplates() {
            try {
                // Load templates from Firestore
                savedExpenses = await getFromFirestore(COLLECTIONS.EXPENSES);
                savedSalaries = await getFromFirestore(COLLECTIONS.SALARIES);
                savedBankExpenses = await getFromFirestore(COLLECTIONS.BANK_EXPENSES);
                savedRentals = await getFromFirestore(COLLECTIONS.RENTALS);
                
                console.log('Templates loaded from Firestore:', {
                    expenses: savedExpenses.length,
                    salaries: savedSalaries.length,
                    bankExpenses: savedBankExpenses.length,
                    rentals: savedRentals.length
                });
                
                updateExpenseSuggestions();
                updateSalarySuggestions();
                updateBankExpenseSuggestions();
                updateRentalTable();
            } catch (error) {
                console.error('Error loading templates from Firestore:', error);
                
                // Fallback to localStorage
                savedExpenses = JSON.parse(localStorage.getItem('savedExpenses')) || [];
                savedSalaries = JSON.parse(localStorage.getItem('savedSalaries')) || [];
                savedBankExpenses = JSON.parse(localStorage.getItem('savedBankExpenses')) || [];
                
                updateExpenseSuggestions();
                updateSalarySuggestions();
                updateBankExpenseSuggestions();
            }
        }

        // Manage templates
        function manageTemplates() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: #2c3e50;">Manage Templates</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>Expense Templates</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newExpense" placeholder="Add new expense template" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addExpenseTemplate()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Add</button>
                        </div>
                        <div id="expenseList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>Salary Names</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newSalary" placeholder="Add new salary name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addSalaryTemplate()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Add</button>
                        </div>
                        <div id="salaryList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>Bank Expense Templates</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newBankExpense" placeholder="Add new bank expense template" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addBankExpenseTemplate()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Add</button>
                        </div>
                        <div id="bankExpenseList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateTemplateLists();
        }

        // Update template lists in modal
        function updateTemplateLists() {
            // Update expense list
            const expenseList = document.getElementById('expenseList');
            expenseList.innerHTML = '';
            savedExpenses.forEach((expense, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;';
                div.innerHTML = `
                    <span>${expense}</span>
                    <button onclick="removeExpenseTemplate(${index})" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                `;
                expenseList.appendChild(div);
            });

            // Update salary list
            const salaryList = document.getElementById('salaryList');
            salaryList.innerHTML = '';
            savedSalaries.forEach((salary, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;';
                div.innerHTML = `
                    <span>${salary}</span>
                    <button onclick="removeSalaryTemplate(${index})" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                `;
                salaryList.appendChild(div);
            });

            // Update bank expense list
            const bankExpenseList = document.getElementById('bankExpenseList');
            bankExpenseList.innerHTML = '';
            savedBankExpenses.forEach((expense, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;';
                div.innerHTML = `
                    <span>${expense}</span>
                    <button onclick="removeBankExpenseTemplate(${index})" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                `;
                bankExpenseList.appendChild(div);
            });
        }

        // Add expense template
        function addExpenseTemplate() {
            const input = document.getElementById('newExpense');
            const name = input.value.trim();
            if (name) {
                saveExpenseTemplate(name);
                input.value = '';
                updateTemplateLists();
            }
        }

        // Add salary template
        function addSalaryTemplate() {
            const input = document.getElementById('newSalary');
            const name = input.value.trim();
            if (name) {
                saveSalaryTemplate(name);
                input.value = '';
                updateTemplateLists();
            }
        }

        // Add bank expense template
        function addBankExpenseTemplate() {
            const input = document.getElementById('newBankExpense');
            const name = input.value.trim();
            if (name) {
                saveBankExpenseTemplate(name);
                input.value = '';
                updateTemplateLists();
            }
        }

        // Remove expense template
        function removeExpenseTemplate(index) {
            savedExpenses.splice(index, 1);
            localStorage.setItem('savedExpenses', JSON.stringify(savedExpenses));
            updateExpenseSuggestions();
            updateTemplateLists();
        }

        // Remove salary template
        function removeSalaryTemplate(index) {
            savedSalaries.splice(index, 1);
            localStorage.setItem('savedSalaries', JSON.stringify(savedSalaries));
            updateSalarySuggestions();
            updateTemplateLists();
        }

        // Remove bank expense template
        function removeBankExpenseTemplate(index) {
            savedBankExpenses.splice(index, 1);
            localStorage.setItem('savedBankExpenses', JSON.stringify(savedBankExpenses));
            updateBankExpenseSuggestions();
            updateTemplateLists();
        }

        // Save data function
        async function saveData() {
            const data = {
                date: document.getElementById('dateInput').value,
                cigaretteSales: document.getElementById('cigaretteTotal').value,
                cigaretteDetails: getCigaretteData(), // Save individual cigarette quantities
                rentalCollection: document.getElementById('rentalTotal').value,
                totalExpenses: document.getElementById('totalExpenses').value,
                totalBankExpenses: document.getElementById('totalBankExpenses').value,
                totalSalary: document.getElementById('totalSalary').value,
                cashReceived: document.getElementById('cashReceived').value,
                tngReceived: document.getElementById('tngReceived').value,
                // Get cashExpenses from span (read-only, auto-calculated from Expenses table)
                cashExpenses: document.getElementById('cashExpenses')?.textContent || '0',
                // Get cashSalary from span (read-only, auto-calculated from Salary/Gaji table)
                cashSalary: document.getElementById('cashSalary')?.textContent || '0',
                grabReceived: document.getElementById('grabReceived').value,
                shopeeReceived: document.getElementById('shopeeReceived').value,
                totalCashReceived: document.getElementById('totalCashReceived').textContent,
                // Calculate salesToday - NEW FORMULA: Cash Received + TNG Received + Expenses paid by Cash + Salary paid by cash + Grab Received + Shopee Received
                salesToday: document.getElementById('salesToday').textContent,
                // Calculate coffeeSales - NEW FORMULA: Sales Today - Cigarette Sales - Rental Collection
                coffeeSales: document.getElementById('coffeeSales').value,
                beerSales: 0, // Removed from main dashboard - only in night section
                expenses: getExpenseData(),
                bankExpenses: getBankExpenseData(),
                salaries: getSalaryData(),
                // Add device and sync information
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenResolution: `${screen.width}x${screen.height}`,
                    timestamp: new Date().toISOString(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                syncInfo: {
                    lastModified: new Date(),
                    version: '1.0',
                    source: 'web-app'
                }
            };
            
            console.log('Data to save:', data);
            
            try {
                // Check if a record for this date already exists in Firestore
                const existingRecord = dailyFinanceData.find(record => record.date === data.date);
                
                if (existingRecord) {
                    // Update existing record in Firestore
                    await updateFirestoreDoc(COLLECTIONS.DAILY_DATA, existingRecord.id, data);
                    console.log('Record updated in Firestore');
                } else {
                    // Add new record to Firestore
                    await saveToFirestore(COLLECTIONS.DAILY_DATA, data);
                    console.log('New record saved to Firestore');
                }
                
                // Also save to localStorage as backup
                const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const existingRecordIndex = savedData.findIndex(record => record.date === data.date);
                
                if (existingRecordIndex !== -1) {
                    savedData[existingRecordIndex] = data;
                } else {
                    savedData.push(data);
                }
                
                localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));
                
                // Show success message with device info
                const deviceType = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
                alert(`‚úÖ Data saved successfully to Firestore!\nüì± Device: ${deviceType}\nüåê Synced across all devices`);
                
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                
                // Fallback to localStorage only
                const savedData = JSON.parse(localStorage.getItem('dailyFinanceData')) || [];
                const existingRecordIndex = savedData.findIndex(record => record.date === data.date);
                
                if (existingRecordIndex !== -1) {
                    savedData[existingRecordIndex] = data;
                } else {
                    savedData.push(data);
                }
                
                localStorage.setItem('dailyFinanceData', JSON.stringify(savedData));
                
                alert('‚ö†Ô∏è Data saved locally (Firestore unavailable). Please check your internet connection.');
            }
        }

        // Get cigarette data
        function getCigaretteData() {
            const cigarettes = [];
            const qtyInputs = document.querySelectorAll('.cigarette-qty');
            qtyInputs.forEach((input, index) => {
                const qty = parseFloat(input.value) || 0;
                if (qty > 0 && cigaretteProducts[index]) {
                    cigarettes.push({
                        name: cigaretteProducts[index].name,
                        price: cigaretteProducts[index].price,
                        quantity: qty,
                        total: qty * cigaretteProducts[index].price
                    });
                }
            });
            return cigarettes;
        }

        // Get expense data
        function getExpenseData() {
            const expenses = [];
            const rows = document.querySelectorAll('#expensesTableBody tr');
            rows.forEach(row => {
                const nameInput = row.querySelector('.expense-input');
                const amountInput = row.querySelector('.expense-amount');
                if (nameInput && amountInput && nameInput.value.trim()) {
                    expenses.push({
                        name: nameInput.value.trim(),
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return expenses;
        }

        // Get bank expense data
        function getBankExpenseData() {
            const expenses = [];
            const rows = document.querySelectorAll('#bankExpensesTableBody tr');
            rows.forEach(row => {
                const nameInput = row.querySelector('.expense-input');
                const amountInput = row.querySelector('.bank-expense');
                if (nameInput && amountInput && nameInput.value.trim()) {
                    expenses.push({
                        name: nameInput.value.trim(),
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return expenses;
        }

        // Get salary data
        function getSalaryData() {
            const salaries = [];
            const rows = document.querySelectorAll('#salaryTableBody tr');
            rows.forEach(row => {
                const nameInput = row.querySelector('.expense-input');
                const amountInput = row.querySelector('.salary-amount');
                if (nameInput && amountInput && nameInput.value.trim()) {
                    salaries.push({
                        name: nameInput.value.trim(),
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return salaries;
        }

        // Clear all function
        function clearAll() {
            if (confirm('Are you sure you want to clear all data?')) {
                // Clear all input fields
                const inputs = document.querySelectorAll('input[type="number"]:not([readonly])');
                inputs.forEach(input => input.value = '');
                
                // Clear text inputs
                const textInputs = document.querySelectorAll('input[type="text"]');
                textInputs.forEach(input => input.value = '');
                
                // Reset summaries
                document.getElementById('salesToday').textContent = '0.00';
                document.getElementById('summaryCigaretteSales').textContent = '0.00';
                document.getElementById('summaryRentalCollection').textContent = '0.00';
                
                // Set today's date
                document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Cigarette sales
            document.querySelectorAll('.cigarette-qty').forEach(input => {
                input.addEventListener('input', calculateCigaretteSales);
            });

            // Rental collection
            document.querySelectorAll('.rental-days').forEach(input => {
                input.addEventListener('input', calculateRentalCollection);
            });

            // Beer sales removed - only in night section
            
            // Coffee sales
            // Coffee Sales is now calculated automatically, no need for input listener
            // calculateCoffeeSales() is called automatically when Sales Today or cigarette/rental changes

            // Auto-save templates when user types in expense/salary fields
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('expense-input')) {
                    const value = e.target.value.trim();
                    if (value && e.target.closest('#expensesTableBody')) {
                        // Auto-save expense template after 2 seconds of no typing
                        clearTimeout(e.target.saveTimeout);
                        e.target.saveTimeout = setTimeout(() => {
                            saveExpenseTemplate(value);
                        }, 2000);
                    } else if (value && e.target.closest('#salaryTableBody')) {
                        // Auto-save salary template after 2 seconds of no typing
                        clearTimeout(e.target.saveTimeout);
                        e.target.saveTimeout = setTimeout(() => {
                            saveSalaryTemplate(value);
                        }, 2000);
                    } else if (value && e.target.closest('#bankExpensesTableBody')) {
                        // Auto-save bank expense template after 2 seconds of no typing
                        clearTimeout(e.target.saveTimeout);
                        e.target.saveTimeout = setTimeout(() => {
                            saveBankExpenseTemplate(value);
                        }, 2000);
                    }
                }
            });
        }
    </script>
</body>
</html>
